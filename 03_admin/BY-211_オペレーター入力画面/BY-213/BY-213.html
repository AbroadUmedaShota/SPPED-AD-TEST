<!DOCTYPE html>
<html lang="ja">
<head>
    <title>名刺入力画面</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        #next-action-modal {
            max-width: 450px;
            width: 80%;
        }
        #skip-modal,
        #suspend-modal {
            max-width: 450px;
            width: 80%;
        }
        #next-action-modal .modal-footer {
            text-align: right;
        }
        #skip-modal label span {
            color: #000;
        }
        body.dark-mode #skip-modal label span {
            color: #fff;
        }
        .other-reason-section {
            margin-top: 15px;
        }
        .other-reason-section .other-textarea-field {
            /* Indent the textarea slightly to show it belongs to "Other" */
            margin-top: 5px;
            margin-left: 35px; 
        }

        #skip-reason-options .other-textarea-field .materialize-textarea {
            /* Default: disabled-like appearance */
            background-color: #f2f2f2 !important;
            border-bottom-color: #ccc !important;
            pointer-events: none;
            color: #9e9e9e;
        }

        #skip-reason-options.other-enabled .other-textarea-field .materialize-textarea {
            /* Enabled appearance */
            background-color: transparent !important;
            border-bottom-color: #9e9e9e;
            pointer-events: auto;
        }

        /* Set text color for light mode */
        #skip-reason-options.other-enabled .other-textarea-field textarea#skip-reason-other-detail.materialize-textarea {
            color: #000 !important;
        }

        /* Set text color for dark mode */
        body.dark-mode #skip-reason-options.other-enabled .other-textarea-field textarea#skip-reason-other-detail.materialize-textarea {
            color: #fff !important;
        }

        /* When focused while enabled */
        #skip-reason-options.other-enabled .other-textarea-field .materialize-textarea:focus {
            border-bottom: 1px solid #26a69a; /* Materialize focus color */
            box-shadow: 0 1px 0 0 #26a69a;
        }

    </style>
</head>
<body>

  <!-- Header -->
  <nav class="blue-grey darken-3">
    <div class="nav-wrapper" style="padding: 0 20px;">
      <a href="#" class="brand-logo">名刺入力</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
              <li>
                <a href="#user-profile-modal" class="modal-trigger nav-user-profile">
                              <img src="https://www.gravatar.com/avatar/?d=mp" alt="User Avatar" class="avatar">
                              <span id="user-email">入力者: ...</span>
                              <span class="nav-divider">|</span>
                              <span id="current-task-name">タスク: ...</span>                </a>
              </li>
              <li>
                <a href="#" class="tooltipped" data-position="bottom" data-tooltip="ダークモード切替" id="toggle-dark-mode">
                  <i class="material-icons">brightness_4</i>
                </a>
              </li>
            </ul>
          </div>
        </nav>
      
        <!-- Main Content -->
        <div class="container" style="width: 95%; max-width: none;">
          <div class="row">
      
            <!-- Left Panel: Image Viewer -->
            <div class="col s8" id="left-panel-container">
              <!-- Main Image Area -->
              <div id="main-image-area">
                  <img id="main-image" src="../../sample/表.png" alt="名刺の表面">
              </div>
      
              <!-- Thumbnail Area -->
              <div class="thumbnail-wrapper center-align">
                  <img id="thumbnail-image" src="../../sample/裏.png" alt="名刺の裏面サムネイル" class="tooltipped" data-position="top" data-tooltip="画像切替 (Alt+Q)">
              </div>
      
              <!-- Image Controls Area -->
              <div class="image-controls center-align">
                  <a id="rotate-btn" class="btn-floating waves-effect waves-light blue tooltipped" data-position="top" data-tooltip="回転 (Alt+Left/Right)"><i class="material-icons">rotate_90_degrees_ccw</i></a>
                  <a id="reset-btn" class="btn-floating waves-effect waves-light green tooltipped" data-position="top" data-tooltip="リセット (Alt+R)"><i class="material-icons">refresh</i></a>
                  <div class="zoom-control">
                      <i id="zoom-out-btn" class="material-icons">zoom_out</i>
                      <input type="range" id="zoom-slider" min="0.5" max="3" value="1" step="0.1">
                      <i id="zoom-in-btn" class="material-icons">zoom_in</i>
                  </div>
              </div>
            </div>
      
            <!-- Right Panel: Form -->
            <div class="col s4" id="right-panel-container">
              <div id="form-groups">
                
                <div class="group-section active" data-group="グループ1">
                  <h5>グループ1：メールアドレス</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">email</i>
                    <input type="email" id="email" name="email">
                    <label for="email">メールアドレス</label>
                  </div>
                </div>
      
                <div class="group-section" data-group="グループ2">
                  <h5>グループ2：氏名</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">person</i>
                    <input type="text" id="last-name" name="last-name">
                    <label for="last-name">姓</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">person_outline</i>
                    <input type="text" id="first-name" name="first-name">
                    <label for="first-name">名</label>
                  </div>
                </div>
      
                <div class="group-section" data-group="グループ3">
                  <h5>グループ3：会社情報</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">business</i>
                    <input type="text" id="company" name="company">
                    <label for="company">会社名</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">group_work</i>
                    <input type="text" id="department" name="department">
                    <label for="department">部署名</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">work</i>
                    <input type="text" id="position" name="position">
                    <label for="position">役職名</label>
                  </div>
                </div>
                
                <div class="group-section" data-group="グループ4">
                  <h5>グループ4：住所</h5>
                  <div class="row" style="margin-bottom: 0;">
                      <div class="input-field col s9 with-suggestion">
                          <i class="material-icons prefix">markunread_mailbox</i>
                          <input type="text" id="zip" name="zip">
                          <label for="zip">郵便番号</label>
                      </div>
                      <div class="input-field col s3">
                          <a href="#!" id="zip-search-btn" class="btn waves-effect waves-light tooltipped" data-position="top" data-tooltip="郵便番号から住所を検索">
                              <i class="material-icons">search</i>
                          </a>
                      </div>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">location_on</i>
                    <input type="text" id="address1" name="address1">
                    <label for="address1">住所1</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">location_city</i>
                    <input type="text" id="address2" name="address2">
                    <label for="address2">住所2(建物名)</label>
                  </div>
                </div>
      
                <div class="group-section" data-group="グループ5">
                  <h5>グループ5：電話番号</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">phone</i>
                    <input type="tel" id="tel1" name="tel1">
                    <label for="tel1">電話番号1</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">phone_in_talk</i>
                    <input type="tel" id="tel2" name="tel2">
                    <label for="tel2">電話番号2</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">phone_iphone</i>
                    <input type="tel" id="mobile" name="mobile">
                    <label for="mobile">携帯番号</label>
                  </div>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">print</i>
                    <input type="tel" id="fax" name="fax">
                    <label for="fax">FAX番号</label>
                  </div>
                </div>
      
                <div class="group-section" data-group="グループ6">
                  <h5>グループ6：URL</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">link</i>
                    <input type="url" id="url" name="url">
                    <label for="url">URL</label>
                  </div>
                </div>
      
                <div class="group-section" data-group="グループ7">
                  <h5>グループ7：その他（メモ等）</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">note</i>
                    <textarea id="notes" name="notes" class="materialize-textarea"></textarea>
                    <label for="notes">その他</label>
                  </div>
                </div>
      
                <div class="group-section" data-group="グループ8">
                  <h5>グループ8：フリー入力</h5>
                  <div class="input-field with-suggestion">
                    <i class="material-icons prefix">edit</i>
                    <textarea id="free-text" name="free-text" class="materialize-textarea"></textarea>
                    <label for="free-text">フリー入力</label>
                  </div>
                </div>
              </div>
      
              <div id="snippet-container"></div>
      
              <!-- Action Controls (Timer and Buttons) -->
              <div class="fixed-action-controls">
                  <div class="timer-container center-align">
                      <span id="elapsed-time">経過時間: 00:00:00</span>
                      <span id="pause-time" class="orange-text" style="display: none;"></span>
                      <span class="stats-divider">|</span>
                      <span id="card-count">処理枚数: 0</span>
                      <span class="stats-divider">|</span>
                      <span id="avg-time">平均時間: 0.0s</span>
                  </div>
                  <div class="button-group" style="margin-top: 10px;">
                      <a id="suspend-button" class="btn waves-effect waves-light orange darken-2 modal-trigger tooltipped" data-position="top" data-target="suspend-modal" data-tooltip="作業終了"><i class="material-icons">exit_to_app</i></a>
                      <a id="skip-button" class="btn waves-effect waves-light red lighten-1 modal-trigger tooltipped" data-position="top" data-target="skip-modal" data-tooltip="スキップ"><i class="material-icons">skip_next</i></a>
                      <a id="confirm-button" class="btn-large btn-floating waves-effect waves-light green darken-1 tooltipped" data-position="top" data-tooltip="確定 (Ctrl+Enter)"><i class="material-icons">check</i></a>
                  </div>
              </div>
      
            </div>
          </div>
        </div>
      
        <!-- Modals -->
          <div id="user-profile-modal" class="modal">
            <div class="modal-content">
              <div class="center-align">
                <img src="https://www.gravatar.com/avatar/?d=mp" alt="User Avatar" class="avatar-large">
                <h4 id="modal-user-name">(ユーザー名)</h4>
                <p><span class="chip blue white-text">照合兼任</span></p>
              </div>
              <ul class="collection">
                <li class="collection-item"><div>メール<a href="#!" class="secondary-content" id="modal-user-email">...</a></div></li>
                <li class="collection-item"><div>現在タスク<a href="#!" class="secondary-content" id="modal-user-task">...</a></div></li>
                <li class="collection-item"><div>本日完了<a href="#!" class="secondary-content">18件</a></div></li>
                <li class="collection-item"><div>精度<a href="#!" class="secondary-content">98.4%</a></div></li>
                <li class="collection-item"><div>状態<a href="#!" class="secondary-content"><span class="new badge green" data-badge-caption="">稼働中</span></a></div></li>
              </ul>
            </div>
            <div class="modal-footer">
              <a href="#!" class="modal-close waves-effect waves-green btn-flat">閉じる</a>
            </div>
          </div>      
          <div id="suggestions-modal" class="modal">
            <div class="modal-content">
              <a href="#!" class="modal-close-icon modal-close"><i class="material-icons">close</i></a>
              <h4 id="suggestions-modal-title"></h4>            <div class="row">
              <div class="input-field col s9">
                <input type="text" id="new-suggestion-input">
                <label for="new-suggestion-input">新しい候補を追加</label>
              </div>
              <div class="col s3">
                <a href="#!" id="add-suggestion-btn" class="btn waves-effect waves-light">追加</a>
              </div>
            </div>
            <ul id="suggestions-list" class="collection">
              <!-- Suggestions will be dynamically added here -->
            </ul>
          </div>
          <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">完了</a>
          </div>
        </div>
      
        <div id="skip-modal" class="modal">
            <div class="modal-content">
                <h4>スキップ理由</h4>
                <p>スキップする理由を選択、または入力してください。</p>
                <div id="skip-reason-options">
                    <div><label><input name="skip_reason_group" type="radio" value="not_card" /><span>名刺ではない</span></label></div>
                    <div><label><input name="skip_reason_group" type="radio" value="unsupported_language" /><span>対応言語外</span></label></div>
                    <div><label><input name="skip_reason_group" type="radio" value="escalation" /><span>エスカレーション</span></label></div>
                    
                    <!-- "Other" section now as a block -->
                    <div class="other-reason-section">
                        <label>
                            <input name="skip_reason_group" type="radio" value="other" />
                            <span>その他</span>
                        </label>
                        <div class="input-field other-textarea-field">
                            <textarea id="skip-reason-other-detail" class="materialize-textarea"></textarea>
                            <label for="skip-reason-other-detail">詳細な理由を入力</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect btn-flat">キャンセル</a>
                <a href="#!" id="confirm-skip-btn" class="waves-effect waves-light btn red">スキップ確定</a>
            </div>
        </div>
      
        <div id="suspend-modal" class="modal">
          <div class="modal-header">
            <i class="material-icons">warning</i>
            <h4>作業終了</h4>
          </div>
          <div class="modal-content">
            <p>作業を終了しますか？<br>現在表示されている画面の内容は保存されません。</p>
          </div>
          <div class="modal-footer">
            <a href="#!" id="cancel-suspend-button" class="modal-close waves-effect waves-green btn-flat">キャンセル</a>
            <a href="#!" id="confirm-suspend-button" class="waves-effect waves-light btn orange darken-2">終了</a>
          </div>
        </div>
      

<!-- Confirmation Modal for Next Action -->
<div id="next-action-modal" class="modal">
  <div class="modal-content">
    <h4 id="next-action-modal-title">確認</h4>
    <p id="next-action-modal-message">次のグループに進みますか？</p>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat tooltipped" data-position="top" data-tooltip="閉じる (Enter)">いいえ</a>
    <a href="#!" id="next-action-modal-confirm" class="waves-effect waves-light btn tooltipped" data-position="top" data-tooltip="次に進む (Ctrl+Enter)">はい</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Initialize all tooltips on the page ---
    M.Tooltip.init(document.querySelectorAll('.tooltipped'));

    // --- Modal Setup ---
    const nextActionModalEl = document.getElementById('next-action-modal');
    let modalKeydownHandler;
    let elementToFocusAfterClose = null; // Variable to store the element to focus

    const modalOptions = {
        dismissible: true,
        onOpenEnd: () => {
            modalKeydownHandler = (event) => {
                if (event.ctrlKey && event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('next-action-modal-confirm').click();
                } else if (event.key === 'Enter') {
                    event.preventDefault();
                    modalInstance.close();
                }
            };
            document.addEventListener('keydown', modalKeydownHandler);
        },
        onCloseEnd: () => {
            if (modalKeydownHandler) document.removeEventListener('keydown', modalKeydownHandler);
            // Focus the element after the modal is fully closed
            if (elementToFocusAfterClose) {
                elementToFocusAfterClose.focus();
                elementToFocusAfterClose = null; // Reset for the next use
            }
        }
    };
    const modalInstance = M.Modal.init(nextActionModalEl, modalOptions);
    const modalTitle = document.getElementById('next-action-modal-title');
    const modalMessage = document.getElementById('next-action-modal-message');

    // --- Simplified Event Handling ---
    const formGroupsContainer = document.getElementById('form-groups');
    if (!formGroupsContainer) return;

    const allFormElements = Array.from(document.querySelectorAll('input:not([type="hidden"]), textarea'));

    const showModal = (title, message, onConfirm) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        const originalConfirmBtn = document.getElementById('next-action-modal-confirm');
        const newConfirmBtn = originalConfirmBtn.cloneNode(true);
        originalConfirmBtn.parentNode.replaceChild(newConfirmBtn, originalConfirmBtn);

        // Initialize tooltip on the new button, as cloning removes the instance
        M.Tooltip.init(newConfirmBtn);

        newConfirmBtn.addEventListener('click', () => {
            if (onConfirm) onConfirm(); // Execute the confirm action
            modalInstance.close();
        }, { once: true });
        modalInstance.open();
    };

    formGroupsContainer.addEventListener('keydown', (event) => {
        const currentElement = event.target;

        // Handle Alt+Enter to go backwards
        if (event.altKey && event.key === 'Enter') {
            event.preventDefault();
            const activeGroup = currentElement.closest('.group-section.active');
            if (activeGroup) {
                const groupInputs = Array.from(activeGroup.querySelectorAll('input:not([type="hidden"]), textarea'));
                const currentIndex = groupInputs.indexOf(currentElement);
                if (currentIndex > 0) {
                    groupInputs[currentIndex - 1].focus();
                }
            }
            return; // Stop processing
        }

        // Handle Enter (but not with Alt) to go forwards
        if ((currentElement.tagName === 'INPUT' || currentElement.tagName === 'TEXTAREA') && event.key === 'Enter' && !event.ctrlKey && !event.altKey) {
            event.preventDefault();

            const group = currentElement.closest('.group-section');
            if (!group) return;

            const groupInputs = Array.from(group.querySelectorAll('input:not([type="hidden"]), textarea'));
            const currentIndexInGroup = groupInputs.indexOf(currentElement);
            const isLastInGroup = currentIndexInGroup === groupInputs.length - 1;

            const overallIndex = allFormElements.indexOf(currentElement);
            const isLastOnPage = overallIndex === allFormElements.length - 1;

            if (isLastInGroup) {
                if (isLastOnPage) {
                    showModal('確定', '次の名刺に進みますか？', () => {
                        document.getElementById('confirm-button').click();
                    });
                } else {
                    // Set the default focus target to the current element (to return focus on cancel)
                    elementToFocusAfterClose = currentElement;
                    showModal('確認', '次のグループに進みますか？', () => {
                        // On confirm, overwrite the focus target to be the next element
                        if (overallIndex < allFormElements.length - 1) {
                            elementToFocusAfterClose = allFormElements[overallIndex + 1];
                        }
                    });
                }
            } else {
                if (currentIndexInGroup < groupInputs.length - 1) {
                    groupInputs[currentIndexInGroup + 1].focus();
                }
            }
        }
    });

    // Global Ctrl+Enter handler
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'Enter') {
            if (modalInstance && !modalInstance.isOpen) {
                event.preventDefault();
                document.getElementById('confirm-button').click();
            }
        }
    });
});
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js" defer></script>
<!-- Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="suggestion.js" defer></script>
<script src="script.js" defer></script>
</body>
</html>