# SPEED AD 画面機能一覧

このドキュメントでは、SPEED ADシステムの各画面の機能一覧を記載しています。SPEED ADは展示会やイベントでのアンケート収集と名刺データ化を効率化するシステムです。

## システム概要

SPEED ADは以下の主要機能を提供します：

1. **アンケート作成・管理**：ユーザーが簡単にアンケートを作成・編集できる機能
2. **名刺データ化**：収集した名刺をOCRでデータ化し、人力で照合・確認する機能
3. **お礼メール送信**：アンケート回答者へのお礼メール自動送信機能
4. **データエクスポート**：収集したデータのCSV出力機能
5. **グループ管理**：複数ユーザーでのアンケート共有・管理機能

## 主要データモデル

- **Survey**: アンケート情報（タイトル、説明、期間など）
- **Survey_detail**: アンケートの質問項目
- **Answer**: アンケート回答データ（名刺情報含む）
- **Answer_detail**: 各質問への回答データ
- **Input_business_cards**: 名刺データ入力情報
- **Users/Corporate**: ユーザー/会社情報
- **Adminuser/AdminUserGroup**: 管理者/管理者グループ情報

## ワークフロー

### アンケートステータスフロー

1. **会期前 (status=1)**: アンケート作成後、開始日前の状態
2. **会期中 (status=2)**: アンケート回答受付中の状態
3. **データ化中 (status=3)**: 会期終了後、名刺データ化作業中の状態
4. **アップ待ち (status=4)**: データ化完了、顧客へのデータ提供待ちの状態
5. **アップ完了 (status=5)**: 顧客へのデータ提供完了状態
6. **データ化なし (status=6)**: 名刺データ化を行わないアンケートの状態

### 名刺データ化ワークフロー

1. **OCR処理**: 名刺画像をOCRで自動テキスト化
2. **データ入力**: オペレーターによる名刺データの手入力（複数人で実施）
3. **データ照合**: 入力データの照合・確認作業
   - 一致: 複数オペレーターの入力が一致した場合
   - 不一致: 入力が一致しない場合、再入力または修正
   - エスカレーション: 判断が難しい場合、上位者へ判断を委ねる
4. **データ確定**: 最終確認後のデータ確定
5. **データ提供**: 顧客へのデータ提供（CSVダウンロード）

## ユーザー向け画面

### 1. ログイン・アカウント関連
- **ログイン画面** (index.blade.php - `/index`, `/`)
  - ユーザーログイン機能
  - パスワードリセット機能へのリンク

- **パスワード関連画面** 
  - パスワードリセット画面 (password.blade.php - `/password`)
  - 新規パスワード作成画面 (password_create.blade.php - `/password_create`)
  - パスワード変更画面 (`/password_change`)

- **アカウント編集画面** (user/edit.blade.php - `/user/edit`)
  - ユーザー情報の編集機能
  - 会社情報の編集機能

### 2. トップ・ダッシュボード
- **トップ画面** (user/top.blade.php - `/top`)
  - アンケート一覧表示
  - アンケート作成へのリンク
  - グループ管理へのリンク
  - アンケート作成内部処理
    1.アンケート名(必須),アンケートタイトル(必須),展示会期間(必須),メモを記入し「アンケート作成に進む」を押すと作成処理開始
    2.必須項目チェックを行う
    3.日付のチェックを行う。終了日が開始日より早くないか、31日以上の会期になっていないか、開始日が過去又は本日で無いか
    4.ajaxで入力データをquestionnaire/createへと渡す
    5.php側でsurveyテーブルにcreateを行う
    6.survey.id+".png"のファイル名でQRコードを生成する
    7.アンケート編集ページへと遷移する

### 3. アンケート関連
- **アンケート作成画面** (user/questionnaire.blade.php - `/questionnaire`)
  - アンケート新規作成機能 (`/questionnaire/create`)
  - 質問項目の設定（複数タイプ対応）
    - フリーアンサー（自由記述）
    - シングルアンサー
    - マルチアンサー
    - マトリックス(sa)
    - マトリックス(ma)
    - 日付/時間
    - 手書きスペース
  - 必須項目設定機能
  - アンケートプレビュー機能
  - アンケート作成表示処理
    1.GET処理を使用しIDを取得し、surveyとsurvey_detailからアンケート情報を取得する
    2.会期が終了している場合は編集ボタンを非表示にする
    3.設問数分、設問項目を追加する
    4.設問種別に応じてjqueryを利用し、要素をの追加を行う
    5.survey_detailにデータが無い場合は指定の5設問を表示する
  - アンケート作成保存処理
    1.ページ上部アンケート情報、名刺撮影の有無、連続回答の有無、各設問のデータを取得する
    2.各設問のデータはJSON.stringifyを使用しjsonへ変換後に値を渡す
    3.php側でjsonのdecodeを行い配列にする
    4.アンケート情報の更新を行う
    5.一度DB上のsurvey_detailをsurvey.idと紐づいているものを削除する
    6.設問情報の配列をループ処理を利用し、survey_detailへとcreate処理を行う
    7.保存処理完了後、「編集に戻る」「アンケート一覧に戻る」のダイアログを表示する

- **アンケート回答画面** (user/questionnaire_answer.blade.php - `/questionnaire_answer`)
  - アンケート回答機能
  - 名刺画像アップロード機能
  - 手書き入力機能
  - 必須項目チェック機能
  - 名刺手入力機能
  - OCR処理機能 (`/questionnaire_answer/extract`)
  - アンケート回答保存処理
    1.送信ボタンの無効化処理
    2.設問数分ループ処理を行い配列データに回答結果を格納する
    3.必須項目未入力の場合は保存を中止し、ダイアログを表示する
    4.(2)で手書きデータがあった場合は、canvasをPromiseで起動しバックグラウンドで画像保存処理を行う
    5.名刺画像アップロード処理を行う
    6.(5)が完了後に回答データをanswerへ登録する
    7.(6)完了後にOCRを非同期で起動し、読み取り後input_business_cardsへ登録を行う
    8.手書きデータがない場合はそのままサンクスページへと遷移し、手書きデータがある場合は処理完了後に遷移を行う

- **サンクス画面** (user/thanks.blade.php - `/thanks`)
  - アンケート回答完了表示
  - 連続回答機能（オプション）

- **アンケートプレビュー画面** (user/questionnaire_preview.blade.php - `/questionnaire_preview`)
  - アンケート表示確認機能

- **アンケートコピー画面** (user/questionnaire_copy.blade.php - `/questionnaire_copy`)
  - 既存アンケートのコピー作成機能

- **名刺データ設定画面** (user/bizcard.blade.php - `/bizcard`)
  - 名刺データ化設定機能
  - データ化プラン選択機能
  - クーポン適用機能
  - form前提を.changeイベントで監視し、リアルタイムでご請求見込み金額の内容の更新を行う
  - 名刺データ設定保存処理
    1.有料プランの場合はアカウント情報が登録されているかのチェックを行う
    2.クーポンコードが入力されている場合は使用可能かのチェックを行う
    3.ページ上部アンケート情報、項目プラン、スピードプラン、想定件数、クーポンコード、各種金額、名刺のデータ化の有無をajaxでphpに値を渡す
    4.php上で営業日の計算を行いデータ完了予定日を計算する
    5.ajaxで取得したデータを元にsurveyをupdate処理を行う
    6.「名刺のデータ化を行う」を選択していた場合はメール送信を行う

- **お礼メール設定画面** (user/thanks_mail.blade.php - `/thanks_mail`)
  - お礼メールテンプレート選択機能
  - お礼メール送信機能
  - メール内容編集機能
  - お礼メール設定画面表示処理
    1.survey.survey_mail_textにデータが存在する場合はそちら取得。無い場合はテンプレートを取得しメール本文へ出力
    2.会期前、御礼メール送信前、御礼メール送信後で表示する項目を変更する
  - お礼メール送信処理
    1.メール送信処理中のメッセージを表示し、多重送信防止に送信ボタンを非表示にする
    2.送信リストからチェックが入っているものを配列に格納を行う
    3.1人ずつメール送信処理を行い、answer.mail_flagに送信済のTRUEを格納する
    4.送信完了後「送信しました」のアラートを表示

### 4. データエクスポート
- **CSVエクスポート機能**
  - アンケート回答データのCSVダウンロード (`/csv_export`)
  - 名刺データのCSVダウンロード (`/csv_export2`)
  - 名刺画像のZIPダウンロード (`/zip_douwn`)
  - 共通処理
    1.グループID、アンケートIDから会社IDを0埋め5桁＋アンケートID0埋め5桁を命名規則として使用(名刺データCSVは末尾にncdを、ZIPはncpicsを追加)
    2.会期前は全てのデータを。会期後はテスト回答はのぞくものを出力する

### 5. グループ管理
- **グループ作成画面** 
  - グループ作成画面_グループ作成画面 (user/groupplan.blade.php - `/groupplan`)
  - グループ設定画面_申し込み完了画面 (user/groupplan2.blade.php - `/groupplan2`) 

- **グループ参加画面** (user/group_join.blade.php - `/group_join`)
  - グループ招待承認機能

- **ユーザー管理画面** (user/user_admin.blade.php - `/user_admin`)
  - グループメンバー一覧表示
  - メンバー追加機能
  - メンバー削除機能

- **ユーザー追加画面** (user/user_admin_add.blade.php - `/user_admin_add`)
  - グループへのユーザー招待機能
  - メール送信機能

### 6. その他
- **利用規約画面** (user/kiyaku.blade.php - `/kiyaku`)
  - 利用規約表示

- **特定商取引法画面** (user/tokushou.blade.php - `/tokushou`)
  - 特定商取引法に基づく表示

- **ヘルプ画面** (user/help.blade.php - `/help`)
  - ヘルプ情報表示

## 管理者向け画面

### 1. ログイン・アカウント関連
- **管理者ログイン画面** (admin/index.blade.php - `/admin/index`, `/admin`)
  - 管理者ログイン機能 (`/admin/login`)

- **管理者トップ画面** (admin/top.blade.php - `/admin/top`)
  - 管理ダッシュボード表示
  - ログインしているアカウント権限によりメニューの表示メニューを変更する
    - アブロードマネージャー 全ての画面にアクセス可能
    - アブロードスタッフ　　全ての画面にアクセス可能
    - オペレーター管理者　名刺入力画面、オペレーター実績確認にアクセス可能
    - オペレーター　　　　名刺入力画面のみアクセス可能

### 2. ユーザー管理
- **ユーザー一覧画面** (admin/user.blade.php - `/admin/user`)
  - ユーザー検索機能
  - ユーザー編集機能へのリンク
  - ユーザー一覧表示処理
    1.検索条件を元にusersからデータを取得し配列に格納する
    2.格納した物の表示処理を行う。(1ページ50件のページャーを起動する)

### 3. アンケート管理
- **アンケート一覧画面** (admin/questionnaire.blade.php - `/admin/questionnaire`)
  - アンケート検索機能
  - アンケート情報表示
  - アンケート編集機能
  - アンケート削除機能 (`/admin/questionnaire_delete`)
  - 名刺画像ダウンロード機能
  - 完了データアップロード機能
  - アンケート一覧表示処理
    1.検索条件を元にsurveyからデータを取得し配列に格納する
    2.格納した物の表示処理を行う。(1ページ50件のページャーを起動する)
  - 完了データアップロード処理
    1.CSV選択後アップロード処理を行う
    2.PHP上でファイルの拡張子チェックを行う
    3.csvを1行ずつ読み込み、answerテーブルへupdate処理を行う
    4.処理完了後アップロード官僚のアラートを表示する

### 4. 請求管理
- **請求管理画面** (admin/payment.blade.php - `/admin/payment`)
  - 請求情報検索機能
  - 請求情報表示
  - 請求情報編集機能 (`/admin/payment_edit`)
  - 請求管理一覧表示処理
    1.検索条件を元にアンケート単位で請求情報を取得する
    2.格納した物の表示処理を行う。(1ページ50件のページャーを起動する)
  - 請求情報編集処理
  　1.編集ボタン押下時、街頭アンケートの請求情報を取得し、モーダルで編集画面を表示する
    2.各種入力後、更新が押された際にajaxで値を渡し、php上で更新を行う

- **請求書画面** (admin/invoice.blade.php - `/admin/invoice`)
  - 請求書検索機能
  - 請求書表示
  - 請求書ダウンロード機能
  - 請求書一覧表示処理
    1.検索条件を元に請求書単位で請求書情報を取得する
    2.格納した物の表示処理を行う。(1ページ50件のページャーを起動する)

### 5. クーポン管理
- **クーポン管理画面** (admin/coupon.blade.php - `/admin/coupon`)
  - クーポン検索機能
  - クーポン情報表示
  - クーポン作成機能 (`/admin/coupon_create`)
  - クーポン編集機能 (`/admin/coupon_editupdate`)
  - クーポン利用履歴表示機能 (`/admin/coupon_history`)
  - クーポン管理一覧表示処理
    1.検索条件を元にcouponからデータを取得し配列に格納する
    2.格納した物の表示処理を行う。(1ページ50件のページャーを起動する)

  - クーポン作成機能処理
    1.モーダルを起動し、ランダム15文字のクーポンコードを表示する
    2.各種情報入力後、作成が押された際にajaxで値を渡し、php上で更新を行う
    3.登録の際クーポンコードが重複していないかチェック処理を行う

### 6. 営業日カレンダー管理
- **営業日カレンダー管理画面** (admin/calendar.blade.php - `/admin/calendar`)
  - 営業日設定機能
  - 休日設定機能 (`/admin/calendar_create`)

### 7. データ入力・照合
- **データ入力一覧画面** (admin/data_input_list.blade.php - `/admin/data_input_list`)
  - 入力対象グループ選択機能
  - 入力状況表示機能
  - データ入力一覧表示処理
    1.グループ1から6までループ処理を行う
    2.1（メールアドレス）を入力しないと2以降が入力可能状態にならない仕様に対応する為に事前にemailが入力完了の物を配列で取得しておく
    3.入力一致ではない、3回入力されていない、ログインユーザーが入力していない名刺情報を各グループ毎にカウントする
    4.(3)のカウントが0のグループは入力不可のフラグを立てる

- **データ入力画面** (admin/data_input_screen.blade.php - `/admin/data_input_screen`)
  - 名刺データ入力機能
  - OCR結果確認機能
  - データ保存機能 (`/admin/data_input_create`)
  - 入力終了機能 (`/admin/data_input_exit`)
  - データ入力表示処理
    1.ログインユーザー情報を取得し、選択しているグループIDを利用し名刺情報を取得する
    2.グループ2以降はグループ1の認証が終わっている、入力一致ではない、3回入力されていない、ログインユーザーが入力していない、占有ロックされていない名刺情報を1件分配列に格納しJSに渡す。配列内は画像名、idが格納される
    3.入力開始前に該当名刺ID(answer.id)とグループIDを文字列結合した物で占有ロックを開始する
    4.JS側で受け取った配列を元に名刺画像を表示し、タイマーをリセットする
    5.保存、スキップが押された際は再度名刺情報を取得し、再表示処理を行う。
    6.終了が押された際は現在の占有を解除後に一覧へ遷移する
  - データ入力保存処理
   1.保存、スキップは同じ関数を使用
   2.回答ID、グループID、項目名、入力値、スキップフラグ、スキップ理由を関数へ渡す
   3.スキップフラグがTRUEの場合入力値はnullへ変換し、input_business_cardsへcreate処理を行い以下3つの処理のチェックを行う
   4.スキップフラグがFALSE(スキップではない正常入力の場合)、既に登録のある入力データ(OCR込み)と一致しているかを確認し、一致していたらis_input_enabledをFALSEへ更新する
   5.スキップ入力が3回あるかチェックを行い、3回以上の場合はエスカレーションフラグを立てる
   6.3回入力されているかチェックを行い、3回入力されていた場合はis_input_enabledをFALSEへ更新する

- **照合一覧画面** (admin/matching_list.blade.php - `/admin/matching_list`)
  - 照合対象アンケート検索機能
  - 照合状況表示機能
  - 照合画面へのリンク
  - 照合一覧表示処理
    1.会期中、データ化中のアンケートの回答データ取得しループ処理で一覧表示を作成
    2.総件数、一致数、不一致数、未入力数をSQLで計算し値を取得する
    3.エスカレーションの件数を取得
    4.一覧へ出力処理

- **照合画面** (admin/matching_screen.blade.php - `/admin/matching_screen`)
  - データ照合機能
  - データ修正機能 (`/admin/matching_screen_update`)
  - エスカレーション機能 (`/admin/matching_screen_escale`)
  - 照合完了機能 (`/admin/matching_screen_update_end`)
  - 照合画面表示処理
    1.アンケートIDから該当アンケートの未照合の回答を配列で取得する
    2.回答単位でループ処理を行い各入力項目を以下処理順で配列に格納する
    3.OCR入力情報、グループ情報、項目名取得、名刺画像パス取得
    4.DB情報取得
    5.オペレーター入力情報×3取得
    6.一致状態の判定を行う
    7.配列に格納した順に照合画面へ出力を行う
  - 照合画面保存処理
    1.formをpostし項目単位でループ処理を行い保存を行う
    2.確定にチェックが入っているもののみinput_business_cards.corrected_dataへ入力情報を登録を行う
    3.(2)の際にCSVダウンロード用のデータへ登録を行う
    4.各オペレーターの入力情報が照合結果と一致しているかチェックを行う
    5.表示処理で取得していた配列を次に進ませ、次の人のデータを画面に表示する
  - 照合画面エスカレーション処理
    1.input_business_cards.is_escalatedをtrueにする
    2. 表示処理で取得していた配列を次に進ませ、次の人のデータを画面に表示する


### 8. オペレーター管理
- **オペレーター一覧画面** (admin/operator_list.blade.php - `/admin/operator_list`)
  - オペレーター検索機能
  - オペレーター情報表示
  - オペレーター作成機能 (`/admin/operator_create`)
  - オペレーター編集機能 (`/admin/operator_update`)
  - オペレーター削除機能 (`/admin/operator_delete`)
  - オペレーター作成処理
   1.パスワードをランダム生成し、入力情報を元にadminuserへcreate処理を行う
   2.該当のメールアドレスへパスワードを通知する

### 9. 実績管理
- **実績画面** (admin/achievements.blade.php - `/admin/achievements`)
  - グループ別実績表示機能
    1.RewardHistoryから所属グループごとのデータを集計
    2.平均正答率を計算しながら配列へデータを格納する
    3.配列データを使用し、グループ単位で結果を出力する
  - オペレーター別実績表示機能
    1.期間と所属グループを元に(初期値当月+全てのグループ)RewardHistoryから該当データを取得する
    2.[ユーザーID][グループID][アイテムタイプ]の配列構成にオペレーターの実績を格納する
    3.配列データを使用し、グループ単位で結果を出力する

## 権限構造

### ユーザー権限
- **一般ユーザー**: 自分のアンケートの作成・管理、データ閲覧が可能
- **グループ管理者**: グループ内のアンケート共有・管理、メンバー管理が可能


### 管理者権限
- **アブロードマネージャー (authority=4)**: すべての機能にアクセス可能
- **アブロードスタッフ (authority=3)**: すべての機能にアクセス可能
- **オペレーター管理者 (authority=2)**: データ入力・照合作業のみ可能
- **オペレーター (authority=1)**: データ入力・照合作業のみ可能

## 更新履歴

- **2025年4月28日**: 初版作成
