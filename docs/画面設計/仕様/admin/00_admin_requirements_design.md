
# 管理者画面 要件・設計サマリ (v0.1)

- 作成日: 2025-09-24
- 対象システム: SPEED AD 管理者ポータル
- 参照元: 03_admin 配下モック & `docs/リファレンス/リソース/client-materials/reference-docs/【00.要件定義書】2025-05-21※Backlog転記済.txt` 等

## 1. 背景と目的
- リード管理プロセス全体を管理者が統制できることを目的に、ユーザー側UIとは独立した管理者向けモックと要件を整理する。
- 本書は既存モックの構造と要件定義書の「管理者向け機能 (3.3)」「横断要件 (3.5)」を抽出し、画面・機能・データ・運用観点を俯瞰できるようにする。
- ここで定義した内容を起点に、詳細仕様・実装タスク・バックエンドAPI設計に展開する。

## 2. 管理者ロールと権限レベル
| ロール | 想定利用者 | 主な権限/アクセス範囲 |
| --- | --- | --- |
| アブロード管理者 | アブロード社 システム全体責任者 | 全機能への閲覧・編集・設定変更権限（請求・クーポン・営業日・データ入力/照合・各種管理画面を含む）。監査ログ/権限設定も実施可。 |
| アブロードマネージャー | アブロード社 案件担当者 | 全メニューアクセス、請求・クーポン・営業日設定の更新権限。 |
| アブロードスタッフ | アブロード社 運用担当 | ユーザー/アンケート/請求管理の閲覧・更新、カレンダー/クーポン/実績管理は閲覧中心。 |
| オペレーター管理者 | パートナー企業の管理者など | データ入力・照合へのフルアクセス。請求関連は閲覧のみ。 |
| オペレーター | 名刺データ入力担当 | データ入力・照合メニューのみ（一覧→対象選択→入力/照合画面）。 |

> サイドバー (`03_admin/common/sidebar.html`) は上記ロールに合わせてメニュー表示制御を行う想定。権限別のルーティング/機能制限を後続設計で詰める。

## 3. 管理者画面の構造
- 共通レイアウト: ヘッダー/サイドバー/フッターを動的読込 (`admin.js#loadCommonHtml`)。Tailwind + カスタムCSS (`src/admin-style.css`) + Material Icons を基盤とする。
- 主要画面とモックソース:

| 画面カテゴリ | モックID/ファイル | 想定URL | 主目的 | 主な要素 |
| --- | --- | --- | --- | --- |
| ダッシュボード | `index.html` | `/admin/index.html` | 管理者導線の入口 + 通知確認 | エスカレーション/処理状況アラート、主要指標カード（準備中）。 |
| ユーザー管理 | `user-management.html` | `/admin/user-management.html` | ユーザー検索・編集 | 検索フォーム、コア列テーブル、詳細画面への導線。 |
| 利用者詳細 | `user-detail.html` | `/admin/user-detail.html` | 1アカウントの詳細確認・編集 | ステータス概要、基本情報編集、サービス設定、所有アンケート一覧。 |
| アンケート管理 | `survey-management.html` | `/admin/survey-management.html` | アンケート一覧/詳細操作 | ステータス変更、CSV取り込み、更新ログモック。 |
| 請求管理 | `billing-management.html` | `/admin/billing-management.html` | 依頼別/請求書別の管理 | サマリカード、請求一覧、詳細・ステータスログ。 |
| クーポン管理 | `coupon-management.html` | `/admin/coupon-management.html` | 割引コード発行・配布状況 | 検索、一覧、編集フォーム、利用ログ表示。 |
| 営業日カレンダー | `calendar-management.html` | `/admin/calendar-management.html` | 休業日の設定 | カレンダービュー、休業日一覧、更新ログ表示。 |
| データ入力一覧 | `BY-211_オペレーター入力画面/BY-212/BY-212.html` | `/admin/data-entry/index.html` | 入力対象の割当・遷移 | 優先度別リスト、詳細へのリンク。 |
| データ入力管理 - 入力画面 | `BY-211_オペレーター入力画面/BY-213/BY-213.html` | `/admin/data-entry/form.html` | 名刺情報の手入力 | 左:名刺画像/回転、右:入力フォーム、下部操作群。 |
| 照合一覧 | `BY-221_照合画面/BY-222/BY-222.html` | `/admin/reconciliation/index.html` | 照合ステータス確認 | KPIカード + テーブル。 |
| 照合詳細 | `BY-221_照合画面/BY-223/BY-223.html` | `/admin/reconciliation/detail.html` | 入力データとOCRの突合 | 画像ビューア + 項目比較テーブル + 操作ボタン。 |
| オペレーター管理 | `BY-231_オペレーター管理/BY-231/BY-231.html` | `/admin/operator-management.html` | アカウント一覧/招待 | モーダルで新規作成、ステータス表示。 |
| エスカレーション対応 | `escalations.html` | `/admin/escalations.html` | エスカレーション内容の確認・処理 | 種別別キュー、対応履歴入力、再割当操作。 |
| 実績管理 | `performance-management.html` | `/admin/performance-management.html` | 入力実績の集計可視化 | 指標フィルタ、チャートモック、実績テーブル。 |

### 3.1 メニュー/URL命名規則（入力/照合系）
- データ入力一覧: `/admin/data-entry/index.html`（旧 `/admin/data-entry-management.html` 相当）。一覧→フォームへの導線は行クリックで `/admin/data-entry/form.html?groupId=...`。
- データ入力フォーム: `/admin/data-entry/form.html`。
- 照合一覧: `/admin/reconciliation/index.html`（入力一覧とは別ページ運用）。操作列から `/admin/reconciliation/detail.html?id=...` へ遷移。
- 照合詳細: `/admin/reconciliation/detail.html`。一致判定ルール導線を設ける場合は別途 `/admin/reconciliation/rules.html` 等に集約する。

### 3.2 ロール別アクセス（入力/照合系の方針）
- アブロード管理者/アブロードマネージャー: 入力・照合の一覧/詳細を含む全機能閲覧・編集可。
- アブロードスタッフ: 入力・照合は閲覧可。編集可否は業務ポリシーに従い個別に設定（デフォルトは閲覧中心）。
- オペレーター管理者: 入力・照合の一覧/詳細フルアクセス。請求は閲覧のみ。
- オペレーター: データ入力/照合メニューのみ表示。割当済みタスクのフォーム/詳細に限定し、他メニューは非表示。
- サイドバー表示は上記ロールに合わせて制御し、直接URLアクセス時もガードする（フロント+API両面）。

## 4. 機能要件詳細
以下は要件定義書 3.3節からの抜粋/整理。**【冪等性制御適用対象】**は 3.5.1 の仕組みに従う。

### 4.1 アカウント管理
- 対象: 管理者画面にログインする管理者アカウント（アブロード管理者/アブロードマネージャー/アブロードスタッフ/オペレーター管理者/オペレーター）。
- 一覧: 現在のログイン状態（オンライン/オフライン/ロック中）、権限グループ、最終ログイン日時、MFA設定状況を表示。
- 詳細: プロフィール、所属組織、権限セット、セッション履歴、直近の操作ログを閲覧。
- 操作:
  - アカウントステータス更新（有効化/停止/ロック解除/パスワード初期化）。
  - 権限グループ変更、MFAリセット。
  - 強制サインアウトやセッション終了。
- 監査/冪等性: すべての更新・強制操作で Idempotency-Key を付与し、監査ログへ記録。

### 4.2 利用者アカウント管理（サービス利用アカウント）
- 対象: SPEED AD のサービスを利用する顧客アカウント（運用担当・管理者代理など含む）。契約プランや利用権限と密接に連動する。
- 一覧: ページネーション付きテーブル。フィルタ（ID、氏名、会社名、部署、役職、契約ステータス、プラン種別、管理フラグ）。初期表示はコア列（アカウントID／会社名／部署・役職／氏名／メールアドレス／停止フラグ／管理フラグ／契約プラン／最終ログイン日）に絞り、連絡先・請求先・住所などの追加項目は列表示切替または詳細ドロワーから参照する。
- 詳細モーダル/画面: サービス利用画面で設定する全項目を参照・編集可能とする。例: 契約プランとオプション、利用中のプロダクトモジュール、通知設定（メール/Slack等）、請求先/CC情報、ログイン制御（IP制限・MFA設定）、関連アンケート/グループ、SLA・利用上限値。サービス側UIとの項目差異が出ないよう同期方針を定める。
  - 専用詳細画面（`/admin/user-detail.html`）では、ステータス概要、基本情報編集、サービス設定/通知、操作履歴、所有アンケート一覧への導線を提供する。
- 操作:
  - アカウント停止/再開（理由の登録、再開時の確認プロセス含む）。
  - 管理フラグ・内部メモ登録（重要/要注意/関係者カテゴリに対応）。
  - 契約プラン/オプション変更依頼の登録・連携、初期化メール再送。
  - 請求先情報・通知設定・権限ロール・利用制限などサービス利用画面由来の設定編集。
  - 一括操作（CSVエクスポート/インポート、複数アカウントのステータス切替）が必要か検討。
- ログ・監査: 変更履歴（旧値/新値、更新者、更新理由）を保存し、履歴表示UIを設けるか検討。クリティカル操作は監査ログと連動。
- 監査/冪等性: 各更新APIで Idempotency-Key を付与し、再試行時も同一キーを利用。

### 4.3 アンケート管理
- 一覧: アンケートID/名称/会社/会期/ステータス/プラン/担当者。
- 検索: キーワード + ステータス + 期間フィルタ。
- 詳細: ユーザー代行での設定変更（フォーム構成、公開設定、プラン変更）。
- 操作: 手動ステータス変更、削除、名刺画像ダウンロード、データ化完了CSVアップロード。
- 注意: CSV取り込み時は結果フィードバックUIを設ける。

### 4.4 請求管理
- アンケート単位と請求書単位の2軸ビュー。
- 詳細: 金額・請求日・入金日を手動調整。【冪等性】対象。
- 出力: 請求書プレビュー/ダウンロード (PDF) は `docs/画面設計/仕様/04_invoice_screen.md`/`docs/画面設計/仕様/05_invoice_document.md` を準拠。
- 未決事項: 自動発行バッチとの連係/ステータス遷移ルール。

### 4.5 クーポン管理
- 一覧 + 検索（コード/名称/状態/利用回数）。
- 新規作成: コード自動生成、割引率、有効期限、利用回数制限、対象プラン設定。
- 編集: 条件変更、利用停止。履歴表示検討。
- 利用ログ: 一覧で利用日時/対象アンケート/適用金額を表示。

### 4.6 営業日カレンダー管理
- カレンダービュー（祝日API連携 or マスタ）
- 土日祝以外の休業日追加/削除。
- 補足: 休日設定はデータ入力SLA計算に影響。変更差分をログ化。

### 4.7 データ入力・照合管理
- **入力一覧**: 
  - グループ/優先度別の残タスク表示。
  - ロック制御: メール未入力時のグループ遷移禁止など内部ロジックあり。
  - 割当ルール: タイムアウト発生時は占有ロックを解除してキューへ戻し、スキップ選択時は別オペレーターに自動再割当。スキップしたオペレーターには同一名刺を再表示しない。
- **入力画面 (BY-213)**:
  - 左パネル: 名刺画像(表/裏)、回転ボタン、スワップ。
  - 右パネル: 項目フォーム（必須/任意、バリデーション表示）、ステータスラベル。
  - 下部: 保存、スキップ（理由必須）、完了、次へ。経過時間表示。
  - メモ: OCR結果は入力画面では表示しない（照合フェーズでのみ参照）。
  - 内部処理:
    - 占有ロックと経過時間監視でタイムアウトを検知し再割当する。
    - 文字列一致判定は全角/半角を区別し、空白・改行は除去した上で比較する。
    - スキップ理由を記録し、3回スキップでエスカレーション登録、3回完了で入力不可フラグを立てる。
- **照合一覧 (BY-222)**:
  - KPIカード: 総件数/一致/不一致/未入力/エスカレーション。
  - テーブル: アンケート、優先度、更新日時、担当者等。フィルタ機構想定。
- **照合画面 (BY-223)**:
  - 上部: 基本情報 + 保存/エスカレーション/キャンセルボタン。
  - 左: 名刺画像ビューア（拡大/回転/裏面切替、ホバーズーム領域）。
  - 右: 項目比較テーブル（項目名、OCR、入力1〜3、最終確定値、選択UI）。全候補を一覧表示し、既存値から選択または管理者が確定値を直接入力できる。
  - 下: コメント/履歴、次へボタン。
  - 判定補助: 差分ハイライト（全角/半角は区別、空白は無視）と自由記述コメント欄。
  - 内部処理: 確定結果を `input_business_cards.corrected_data` へ保存、CSVダウンロード用データに反映、オペレーター精度実績ログ記録。
- **エスカレーション通知/対応**:
  - エスカレーション発生時はダッシュボードにアラートカードを表示し、マネージャー/スタッフへ通知。
  - 種別（画像不備、言語不一致等）を付与し、専用画面で対応状況と履歴を管理。

### 4.8 オペレーター管理
- 一覧: 名前、メール、所属グループ、稼働状況、直近の処理件数。
- 招待: モーダルでメール入力 → アカウント発行 & 初期パスワード通知。
- 編集: 権限変更（例: 入力専任/照合兼任）、稼働ステータス変更。
- 削除: 論理削除 + 既存タスク再割当が必要。

### 4.9 実績管理
- 集計指標: グループ別処理件数/正答率、オペレーター別件数・エラー数、期間比較。
- ビジュアル: 折れ線/棒グラフ + ダウンロード（CSV, PDF）。
- ドリルダウン: オペレーター→対象アンケート→入力履歴。

### 4.10 エスカレーション対応
- 対象: 入力/照合でエスカレーションフラグが立った案件。
- 一覧: 種別、発生元（入力 or 照合）、受付日時、優先度、担当者、対応状況を表示。
- 詳細: 原因コメント、添付資料、操作履歴、再割当先を確認・編集。
- 操作: 対応結果登録、再開、再割当、クローズ。完了時はダッシュボードアラートを自動消込。
- 監査: 対応履歴は監査ログに記録し、対象案件へ紐付け。

## 5. データおよびAPI前提
- 主要テーブル (要件定義書6章より):
  - `Input_business_cards`: 名刺入力データ (OCR結果, 入力値1〜3, フラグ類, 担当オペレーターID)。
  - `Users` / `Corporate`: 顧客ユーザー・企業マスタ。
  - `AdminUser`, `AdminUserGroup`: 管理者アカウントと権限グループ。
  - `Coupon`, `RewardHistory`, カレンダー管理テーブル 等。
- 冪等性制御 (3.5.1):
  - `POST /api/idempotency-key` でキー発行 → 更新系APIの `Idempotency-Key` ヘッダーに付与。
  - Redis でキーとレスポンスをキャッシュ、ユーザーID/操作種別/タイムスタンプを監査ログ化。
  - フロントはフォーム送信毎に単一キーを払い出し、リトライ時も同一キーを使用。
- ロック/競合対策: データ入力画面の占有ロックは時間制限付き。照合画面も同様の排他制御が必要。
- 監査ログ: クリティカル操作（権限変更、請求編集、エスカレーション等）は操作履歴に記録。
- CSV方針: 名刺データ + 回答データはダウンロード対応（UTF-8, ヘッダ付き）。アップロード仕様とバリデーションは別途詳細設計で検討。
- 通知/アラート: エスカレーション登録時に `/api/admin/escalations`（仮称）へ記録し、ダッシュボードカードの未読件数と連動。

## 6. UI設計メモ
- 共通部品: `common/header.html` (通知/ユーザー情報), `common/sidebar.html` (メニュー + ログアウト + テーマ切替), `common/footer.html` (コピーライト)。
- スタイル: Tailwindベースに `src/admin-style.css` を追加し、ダーク系配色。Material Icons を主要アイコンに採用。
- レスポンシブ: サイドバーはモバイルでオーバーレイ化 (`mobileSidebarOverlay`)。主要画面は最大幅 `max-w-6xl`。
- データ入力 (BY-213):
  - 左パネル 40%、右パネル 60% レイアウト。画像拡大用ライトボックスあり。
  - 入力フォームはカテゴリごとにアコーディオン化。必須項目はラベル横に `必須` バッジ。
  - 操作ボタン: `保存`, `スキップ`, `完了`, `次の名刺へ`。
- 照合 (BY-223):
  - 画像ビューアはドラッグで拡大移動。上部に表裏切替タブ。
  - 項目比較テーブルは列固定 + 水平スクロール。確定値はドロップダウン or ラジオ。
  - `エスカレ` ボタン押下時は理由入力モーダルを出す想定。
- オペレーター管理 (BY-231):
  - 上部KPIカード（稼働中人数、当日日報等）。
  - テーブル列: 氏名/メール/権限/現在のタスク/直近完了件数。
  - `新規招待` ボタン→モーダル (メール, 権限, 初期パスワード)。

## 7. 未決事項・検討タスク
1. OCR結果の入力画面表示可否 → 入力画面では非表示、照合画面のみ候補表示（2025-10-01 方針決定）。
2. エスカレーション処理フロー → 上位権限宛のエスカレーション対応画面を新設し、ダッシュボードアラートで通知。詳細UI/通知頻度は要設計。
3. CSVアップロード/ダウンロードのフォーマット → ダウンロード（名刺 + 回答データ）は決定。アップロード仕様・バリデーションは継続検討。
4. ロール別メニュー制御・ルーティングの仕様書化。
5. ダッシュボード指標の定義 (成約率、処理件数、 SLA 等)。
6. 監査ログ/操作履歴のUI (閲覧/検索) を設けるか。
7. 請求管理画面と自動バッチの連携（ステータス同期、メール通知タイミング）。
8. オペレーター削除時のタスク再割当ロジック。
9. 実績管理画面のグラフライブラリ選定と API フォーマット。

## 8. 参照資料
- `03_admin/admin_requirements.md` (管理者機能要件リスト)
- `03_admin/index.html`, `src/admin.js`, `common/*.html`
- `03_admin/BY-211_オペレーター入力画面/BY-213/BY-213.html`
- `03_admin/BY-221_照合画面/BY-223/BY-223.html`
- `03_admin/BY-231_オペレーター管理/BY-231/BY-231.html`
- `docs/画面設計/仕様/04_invoice_screen.md`, `docs/画面設計/仕様/05_invoice_document.md`
- `docs/リファレンス/リソース/client-materials/reference-docs/【00.要件定義書】2025-05-21※Backlog転記済.txt`


