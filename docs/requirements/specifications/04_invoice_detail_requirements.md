# 請求書詳細ページ仕様書 (INV-002)

最終更新日: 2025-10-18

---

## 1. 概要

- 本ドキュメントは SPEED AD ダッシュボードの請求書詳細ページ (`02_dashboard/invoice-detail.html`) に関する UX・機能仕様を定義する。
- 目的は、利用者が請求金額の根拠を透明に把握し、支払い・ダウンロード・問い合わせ等の次アクションへ迷わず移行できること。
- データは `data/core/invoices.json` の `invoice` オブジェクトを参照する。モック API 層は `src/services/invoiceService.js` を想定。

---

## 2. 対象ユーザーとユースケース

| ユーザー種別 | ニーズ | 期待する完了状態 |
| :--- | :--- | :--- |
| 経理担当 (Standard/Premium 利用企業) | 月次請求の確認、支払済みステータスの把握 | 合計金額・支払期限・振込口座が即時に把握できる |
| 課金管理者 (Premium+ 従量課金) | 従量課金項目の内訳・数量確認 | 追加オプションと従量項目が明細で分離されている |
| 営業サポート | 顧客からの問い合わせ対応 | PDF ダウンロード・印刷ボタンから資料を提供できる |

---

## 3. ナビゲーションと画面遷移

1. `invoiceList.html` から「詳細」ボタン押下で `?id={invoiceId}` を付与した状態で遷移。
2. 画面ロード時に `invoiceService.fetchInvoice(invoiceId)` を実行。成功時に UI コンポーネントへ描画。
3. `戻る` パンくず (`請求書一覧 > {invoiceId}`) を設置し、一覧に戻る導線を確保。
4. URL パラメータが無い／不正な場合は異常系ハンドリング (セクション 7) を実行。

---

## 4. レイアウト構成

### 4.1 ページシェル

- 共通ヘッダー・サイドバー・フッターは `loadCommonHtml` で読み込む。
- メインコンテンツ幅は 960px 固定 (最大 1200px)、両側 40px のパディング。
- 各情報ブロックは `card` (影: `var(--shadow-md)`, 角丸: `8px`) で区切り、タイトルバーにアイコン (Bootstrap Icons) を添える。

### 4.2 ヘッダーセクション

| 要素 | 内容 | スタイル | 備考 |
| :--- | :--- | :--- | :--- |
| ページタイトル | `請求書詳細` | `h1`, フォントサイズ 24px | サブタイトルで `invoiceId` を表示 |
| ステータスバッジ | `未入金` / `入金済` / `延滞` / `取消` | カラーリングは一覧仕様と共通 | `延滞` 時は `支払期限 + 経過日数` を右側に表示 |
| アクションボタン群 | `PDFダウンロード`, `印刷`, `問い合わせ` | ボタン高さ 40px、右寄せ | `問い合わせ` クリックで `mailto:` を呼ぶ (開発環境では `support@example.com`) |
| 最終更新情報 | `請求日: YYYY/MM/DD` | テキスト右揃え | `issueDate` を使用 |

### 4.3 情報ブロック

1. **請求情報サマリ**
   - 表形式 (2 列)。左列にラベル、右列に値を表示。
   - 項目: `請求書番号`, `請求日`, `支払期限`, `対象期間`, `契約プラン`, `追加オプション`。
   - `契約プラン`: `plan.displayName` と `billingType` (`月次` / `年次`) を併記。
   - `追加オプション`: `addOns` が空の場合「なし」を表示。
2. **請求先情報**
   - 宛名行: `{corporateName} 御中`。
   - 担当者行: `{contactPerson} 様` (データ欠損時は非表示)。
   - 請求先住所・電話など追加項目があれば順次表示できるよう `key-value` リスト形式を採用。
3. **明細テーブル**
   - テーブル列: `No.`, `項目`, `内訳`, `数量`, `単価`, `金額`。
   - `items` を `category` ごとにグルーピング。グループ先頭にセクション行 (背景 `#f3f4f6`) を挿入。
   - 金額/単価は `¥12,345` 形式 (`toLocaleString('ja-JP')`)。
   - `quantity` と `unit` は両方存在する場合 `200 件` のように表示。
   - `category === 'CREDIT'` の金額は `-¥3,000` とマイナス表示。
   - テーブルの最終行に各カテゴリの小計行を自動生成。
4. **集計セクション**
   - カード右側に合計計算ボックス (背景 `#1f2937`, 文字色 `#ffffff`)。
   - 表示順: `課税対象小計`, `非課税小計`, `消費税 (10%)`, `合計金額（税込）`。
   - 合計金額はフォントサイズ 24px、太字。
5. **振込先情報**
   - 銀行名、支店名、口座種別 (日本語変換: `普通`/`当座`/`貯蓄`)、口座番号、口座名義。
   - `コピー` ボタンを設置し、クリップボード API で `bankInfo` をまとめてコピー (`銀行名 支店名 種別 口座番号 口座名義`)。
6. **メモ / 注意事項**
   - `notes` が `null` または空文字の場合はカードを非表示。
   - コンテンツ内の URL を自動リンク化。危険な HTML はエスケープする。

---

## 5. 状態管理とインタラクション

- **ローディング**: データ取得中はメインコンテンツ領域にスケルトン UI を表示。ヘッダーにはプレースホルダー (グレー帯) を表示。
- **ボタン状態**:
  - データ取得中は全ボタンを `disabled`。
  - `status === 'canceled'` の場合 `印刷` ボタンを非活性にし、ツールチップで「取消された請求書は印刷できません」と表示。
  - `status === 'paid'` または `dueDate < today` の場合、バッジとツールチップを更新 (`支払日: {paidDate}` は将来拡張用フィールド)。
- **PDFダウンロード**: 現時点では `seikyusyo_sample.xlsx` をダウンロード。将来 PDF 化する際はファイル名を `invoice-{invoiceId}.pdf` とする。
- **印刷**: 新規タブで `invoice-print.html?id={invoiceId}` を開く。開けない場合はブラウザポップアップ許可を案内。
- **問い合わせ**: `mailto:support@example.com?subject=請求書%20{invoiceId}%20について` を起動し、本文テンプレートを挿入。
- **キーボード操作**: `Tab` でヘッダーアクション → 情報ブロック → テーブル → 集計 → コピー → 印刷の順にフォーカス移動。

---

## 6. データマッピング

| UI 項目 | データソース | フォーマット | 備考 |
| :--- | :--- | :--- | :--- |
| 請求書番号 | `invoice.invoiceId` | そのまま表示 | | 
| 請求日 | `invoice.issueDate` | `YYYY年MM月DD日` | | 
| 支払期限 | `invoice.dueDate` | `YYYY年MM月DD日` | `overdue` の場合に経過日数を計算 |
| 対象期間 | `invoice.billingPeriod.from` / `to` | `YYYY/MM/DD 〜 YYYY/MM/DD` | | 
| 契約プラン | `invoice.plan` | `displayName（定額/月次 or 年額/年次）` | `billingType` を文言変換 |
| 追加オプション | `invoice.addOns` | `displayName (数量+単位)` を `、` 区切り | 空配列は「なし」 |
| 明細行 | `invoice.items[]` | 表示処理はセクション 4.3 を参照 | `lineId` を DOM `data-line-id` に保持 |
| 小計/税/合計 | `invoice.subtotalTaxable` など | 数値を金額書式に整形 | | 
| 振込先 | `invoice.bankInfo` | 文字列結合 | `accountType` 変換テーブル: `ordinary`→`普通` |
| メモ | `invoice.notes` | Markdown 風記法は改行保持 | HTML エスケープ必須 |

---

## 7. 異常系・バリデーション

| 条件 | 表示/動作 | 復帰動作 |
| :--- | :--- | :--- |
| `invoiceId` が未指定 | 全カードを非表示。画面中央に `対象の請求書が見つかりませんでした` | `請求書一覧に戻る` ボタンを表示 |
| `fetchInvoice` が 404 | 上記と同様。ログに `warn` を出力 | 再試行ボタンを表示 |
| `fetchInvoice` が 500 系 | オーバーレイで `請求データの取得に失敗しました。リロードして再試行してください。` | `再読み込み` ボタンで `window.location.reload()` |
| `items` が空配列 | 明細テーブルはヘッダーのみ表示し、本文に `明細データがありません` | API 側調査のため `mailto:` 案内を表示 |
| `bankInfo` 不完全 | 欠損項目は `-` 表記。コピー機能は欠損項目を除外 | サポート問い合わせを促す注意文 |

---

## 8. アクセシビリティとレスポンシブ

- コントラスト比は WCAG 2.1 AA 準拠 (最低 4.5:1)。
- ステータスバッジには `aria-label` で状態説明を付与 (`例: aria-label="請求書ステータス: 未入金"`)。
- テーブルは横スクロール対応 (`overflow-x: auto`)。幅 768px 未満では数量・単価列を折りたたみ、トグルで開閉できる。
- コピー操作・ダウンロード・印刷にはフォーカスリングを明示し、 Enter/Space で操作可能にする。

---

## 9. 計測とログ

- `invoice-detail.view` イベントをページ表示時に送信 (属性: `invoiceId`, `status`, `plan.code`, `totalAmount`)。
- `invoice-detail.download` (`action: pdf` / `print` / `contact`) をボタンクリック時に発火。
- エラーハンドリング時は `invoice-detail.error` イベントを `severity` (warning/error) 付きで送信。

---

## 10. 今後の課題・オープン事項

- PDF 差し替え時の電子署名対応要否 (経理との調整が必要)。
- `paidDate` のデータ提供タイミングと表示場所 (サマリ or 明細注釈) の検討。
- 振込先が複数口座あるケースに備えた UI 拡張 (アコーディオン or タブ) の設計。
- 税率変更 (軽減税率) への対応方針と表示文言のバリエーション。

