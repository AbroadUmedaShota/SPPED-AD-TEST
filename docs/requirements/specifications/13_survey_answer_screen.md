# アンケート回答画面 要件定義書 (`survey-answer.html`)

## 1. 概要

本ドキュメントは、アンケート回答画面 (`survey-answer.html`) の機能および非機能要件を定義する。

### 1.1. 目的

アンケート作成画面 (`surveyCreation.html`) で作成されたアンケートに対し、回答者がPC、スマートフォン、タブレットなど各種端末からスムーズに回答を入力・送信できるようにすることを目的とする。

### 1.2. 基本動作

-   **動的表示**: URLのクエリパラメータ (`?surveyId=...`) で指定されたアンケートIDを元に、アンケート定義のJSONファイル（例: `/data/surveys/{surveyId}.json`）を非同期で読み込み、タイトルや設問などを動的に描画する。
-   **回答の保存**: 送信された回答は、現行フェーズではブラウザのローカルストレージに保存される。
-   **完了通知**: 回答完了後、サンクス画面へ遷移し、回答が完了したことをユーザーに通知する。

---

## 2. 画面レイアウト

画面は「ヘッダー」「メインコンテンツ」「フッター」の3つの主要エリアで構成され、サイドバーは設けない。UIコンポーネントは、プロジェクトの共通デザインガイドライン (`docs/design/00_design_guideline.md`) に準拠すること。

-   **ヘッダー**
    -   アンケートのタイトルと説明文を表示する。
    -   **一時保存ボタン**: 回答内容を手動でドラフト保存するためのボタンを配置する。
    -   **言語選択ドロップダウン**: プレミアムプランの多言語対応アンケートの場合、ヘッダーに言語選択用のドロップダウンリストを表示する。
    -   **スクロール時の挙動**:
        -   ページを下にスクロールすると、ヘッダーは画面外にスクロールされる（非追従）。
        -   ページを上方向にスクロールすると、ヘッダーが画面上部に再表示され、そのまま追従する。
-   **メインコンテンツ**
    -   アンケートの設問を上から順に一覧表示する。
    -   現時点では、ページネーションによる設問の分割表示は行わない（※将来実装の可能性あり）。
-   **フッター**
    -   ページの**最下部**に配置される。
    -   以下の3つの操作ボタンを配置する。
        1.  **名刺画像撮影ボタン**: 名刺をカメラで撮影する機能を起動する。
        2.  **名刺が手元に無い方向けボタン**: 名刺情報を手動で入力するためのモーダルを開く。
        3.  **アンケート送信ボタン**: 全ての回答を送信する。

---

## 3. 機能要件

### 3.1. 回答プロセスフロー

1.  **アクセス**: 回答者はQRコードまたはURLからアンケート画面にアクセスする。
2.  **回答入力**: 画面に表示された設問に回答を入力する。
3.  **送信**: フッターの「アンケート送信ボタン」を押下する。
4.  **データ保存**: 回答データがオブジェクトとして収集され、ローカルストレージに保存される。
    -   **キーの形式**: 衝突を避けるため `survey_response_{surveyId}_{timestamp}` の形式で保存する。
5.  **ドラフト削除**: 送信完了後、後述するドラフトデータはローカルストレージから削除する。
6.  **画面遷移**: 保存後、`thankYouScreenSettings.html` で設定された内容に基づづくサンクス画面へ自動的に遷移する。

### 3.2. 回答のドラフト保存機能

-   **手動保存**: ヘッダーの「一時保存ボタン」を押下すると、現在の回答内容が即座にローカルストレージにドラフトとして保存される。保存完了後は、「一時保存しました」といったトースト通知などでユーザーにフィードバックを行う。
-   **自動保存**: 回答者の入力内容は、定期的に（例: 30秒ごと）ローカルストレージに自動でドラフト保存される。これにより、ブラウザクラッシュ等の不慮の事態が発生しても、途中から入力を再開できる。
    -   **キーの形式**: 複数タブでの同時編集による競合を防ぐため、`survey_draft_{surveyId}_{sessionId}` の形式で保存する（`sessionId`はページ読み込み時に生成する一意のID）。
-   **ドラフトの復元**: ページ読み込み時、ローカルストレージに有効なドラフトが存在する場合、ユーザーに「未送信の回答がありますが、復元しますか？」といった確認ダイアログを表示し、「復元する」「新しく始める」を選択させる。
-   **離脱警告**: 意図しないデータ損失を防ぐため、`surveyCreation.html`の実装に準拠し、以下の3段階の警告を実装する。
    -   **1. ページ内リンク操作時**: ページ内に配置されたリンクがクリックされ、ページからの離脱が発生する場合、**カスタムモーダル**を表示して確認を行う。
    -   **2. ブラウザの「戻る」ボタン操作時**: ブラウザの「戻る」ボタンが押された場合、`popstate`イベントを捕捉し、**カスタムモーダル**を表示して確認を行う。
    -   **3. その他のブラウザ操作時 (フォールバック)**: ページの再読み込みやタブを閉じるなど、上記以外の操作で離脱しようとした場合、**ブラウザ標準の確認ダイアログ**を表示する。

### 3.3. 名刺画像アップロードフロー

フッターの「名刺画像撮影ボタン」を押下すると、以下のフローが開始される。

1.  **アップロード方法の選択**: モーダルウィンドウが表示され、「ストレージから選択」「カメラで撮影」のいずれかを選択する。

2.  **表面の撮影・選択**: 「カメラで撮影」が選択された場合はカメラを起動し表面を撮影する。「ストレージから選択」が選択された場合はファイル選択画面を開き、表面の画像を選択する。

3.  **表面のプレビューと次のアクション**: 選択または撮影した表面の画像がプレビュー表示される。この画面で、ユーザーは以下のいずれかを選択する。
    -   **裏面を撮影する**: 裏面の撮影ステップへ進む。
    -   **裏面をスキップ**: 最終確認ステップへ進む。
    -   **撮り直す/再選択**: 前のステップ（カメラ起動 or ストレージ選択）に戻る。

4.  **裏面の撮影・選択（任意）**: 「裏面を撮影する」が選択された場合、表面と同様に裏面の撮影またはストレージからの選択を行う。

5.  **裏面のプレビューと次のアクション（任意）**: 選択または撮影した裏面の画像がプレビュー表示される。ユーザーは「最終確認へ進む」か「撮り直す/再選択」を選択する。

6.  **最終確認とアップロード**: 選択された全ての画像（表面のみ、または両面）が一覧でプレビューされる。ユーザーは「アップロード」ボタンを押下し、名刺画像の選択を完了する。

7.  **添付の任意性**: 名刺画像の添付は任意とする。画像がアップロードされていない状態でも、アンケートの送信は妨げられない。

#### 3.3.1. 【要検証】名刺言語の自動判別 (OCR)

-   **目的**: プレビュー画面に表示された名刺画像から、OCR（光学的文字認識）技術を用いて記載言語を機械的に判別し、後のデータ入力の効率化を図る。
-   **動作**: 表面・裏面の各プレビュー画面で、画像の解析を試みる。判別できた場合、その言語名（例: 「日本語」「英語」）をプレビュー画面内に表示する。
-   **フォールバック**: 言語の判別が不可能だった場合は、現在アンケートが表示されている言語をデフォルトの言語として表示する。
-   **注記**: 本機能は技術的な実現可能性の検証を要する。

### 3.4. 名刺なし回答フロー

1.  **モーダル表示**: フッターの「名刺が手元に無い方向けボタン」を押下すると、手動入力用のモーダルウィンドウが表示される。
2.  **情報入力**: モーダル内で以下の顧客情報を入力する。
    -   氏名, メールアドレス, 会社名, 部署名, 役職名, 電話番号, 住所（郵便番号, 住所, 建物名）
3.  **保存**: モーダル内の保存ボタンを押下すると、入力内容が回答データの一部として保存される。
4.  **入力の任意性**: 上記の全ての項目は任意入力とし、バリデーション（必須チェック等）は設けない。未入力の状態でもアンケートの送信は可能とする。

### 3.5. サポートする設問タイプ

設問種別に応じて、適切な入力コントロールを表示する。データモデルのキーは `docs/design/architecture/02_data_model.md` の定義と整合性を保つこと。

| 設問タイプ | データモデル上のキー | 説明 |
| :--- | :--- | :--- |
| フリーアンサー | `free_answer` | 回答者が文章で自由に回答する形式の設問。 |
| シングルアンサー | `single_answer` | 複数の選択肢の中から一つだけを選んで回答する形式の設問。（ラジオボタン） |
| マルチアンサー | `multi_answer` | 複数の選択肢の中から複数を選んで回答する形式の設問。（チェックボックス） |
| 数値回答 | `number_answer` | 整数または小数を入力させる設問。最小値・最大値、単位を設定可能。 |
| ドロップダウン回答 | (UIバリエーション) | 選択肢をドロップダウンリスト形式で表示する設問。単一または複数選択が可能。 |
| **マトリックス(SA)** | `matrix_sa` | 複数の質問（行）に対し、共通の選択肢（列）から一つだけを選ぶ形式。 |
| **マトリックス(MA)** | `matrix_ma` | 複数の質問（行）に対し、共通の選択肢（列）から複数を選ぶ形式。 |
| 日付/時間回答 | `date_time` | 日付、時刻、またはその両方を入力させる設問。 |
| 説明カード | (特殊タイプ) | 質問ではなく、アンケートの途中に説明文や案内を挿入するためのカード。 |

### 3.6. プレミアムプラン限定機能

-   **3.6.1. 連続回答機能**
    -   **プレミアムプラン**: サンクス画面に「連続で回答する」ボタンが表示される。クリックすると、再度同じアンケートの回答画面（入力内容はクリアされた状態）に遷移する。
    -   **無料プラン**: サンクス画面に連続回答ボタンは表示されない。再度回答するには、URLにアクセスし直す必要がある。
-   **3.6.2. 多言語対応**
    -   **対応言語**: 英語, 中国語（簡体字 / 繁体字）, ベトナム語
    -   **言語切り替えUI**: 回答者はヘッダーに表示された言語選択ドロップダウンを操作することで、リアルタイムにアンケートの表示言語を切り替えることができる。
-   **3.6.3. 手書きスペース設問**
    -   本設問は**プレミアムプランで作成されたアンケートでのみ有効**となる。
    -   **機能**: 回答者が手書きで文字や図形を入力できるキャンバス領域を提供する。
    -   **動作**: 無料プランのアカウントでは、アンケート作成時に「手書きスペース」の設問タイプを選択・利用することはできない。

---

## 4. 非機能要件

-   **4.1. レスポンシブデザイン**
    -   PC、タブレット、スマートフォンなど、あらゆる端末の画面サイズで表示が最適化され、全ての機能が利用可能であること。モバイルでは1カラムレイアウトを基本とする。
-   **4.2. ブラウザタブの挙動**
    -   複数タブでアンケートページを開いた場合でも、それぞれのタブが独立したセッションとして機能し、互いに影響を与えずに回答・送信が完了できること。
-   **4.3. パフォーマンス**
    -   ボタンクリックやモーダル表示など、主要なUI操作は1秒以内に応答すること。
-   **4.4. スタイル・UI**
    -   共通スタイルシート (`service-top-style.css`) および、プロジェクトのデザインガイドラインに準拠し、一貫性のあるUIを提供すること。
-   **4.5. アクセシビリティ**
    -   キーボード操作のみで、全ての設問への回答とフォームの送信が可能であること。
    -   スクリーンリーダーがUIの構造や設問内容を正しく解釈できるよう、`aria-label`等のWAI-ARIA属性を適切に設定すること。
    -   OSの `prefers-reduced-motion` 設定を尊重し、不要なアニメーションを無効化すること。
-   **4.6. バリデーション**
    -   必須項目や入力形式（メールアドレス、数値など）に対し、リアルタイム（入力時・フォーカスアウト時）および送信時にバリデーション（入力チェック）を行う。
    -   バリデーションエラーが発生した場合は、対象箇所の近傍に分かりやすいエラーメッセージを表示すること。（例: 未入力の必須項目の枠線を赤くし、項目下にエラーテキストを表示する）
-   **4.7. UIフィードバック**
    -   **ロード中**: ページの初期読み込み時など、データを取得している間はローディングインジケーターを表示する。
    -   **送信中**: 回答送信ボタンの押下後、サンクス画面に遷移するまでの間、以下のフィードバックを行う。
        -   送信ボタンを非活性化し、二重クリックを防ぐ。
        -   画面上に送信の進捗を示すプログレスバー（例: `[■■■--] 60%`）を表示する。特に、名刺画像などのファイルアップロードが伴う場合に、その進捗を視覚的に示す。
        -   プログレスバーが100%に達した時点で、サンクス画面へ遷移する。
    -   **エラー表示**: ネットワークエラー等でアンケート定義JSONを読み込めなかった場合、画面に「エラー: アンケートを読み込めませんでした。」といったユーザーフレンドリーなエラーメッセージを表示する。
-   **4.8. セキュリティ**
    -   **データの暗号化**: 将来的なバックエンド連携を見据え、アンケートの回答データや名刺データなどの個人情報を含むデータは、送信時およびサーバー保存時に暗号化される設計とする。現行のローカルストレージ保存フェーズでは、この要件は直接適用されないが、将来の拡張性を考慮する。
-   **4.9. アーキテクチャ方針**
    -   **アクション駆動アーキテクチャ**: フロントエンドの実装は、アクション駆動の概念を採用する。
        -   **イベント/ユーザー駆動**: 全てのアプリケーションの変更は、ユーザーのアクション（ボタンクリック、フォーム入力など）を起点とするイベントによってトリガーされる。
        -   **状態管理**: アプリケーションの状態（入力された回答データ、UIの表示状態など）は、一元的に管理される。
        -   **状態に基づくUI更新**: ユーザーアクションによって状態が更新されると、UIは新しい状態を反映して自動的に再描画される。これにより、データと表示の整合性を保ち、予測可能な動作を保証する。
-   **4.10. モバイル固有動作**
    -   **Pull-to-Refreshの無効化**: スマートフォン等で、画面を最上部からさらに下に引っ張った際に発生する「Pull-to-Refresh（引っ張って更新）」機能を、本画面では無効化する。これにより、回答中の意図しないページ再読み込みを防ぐ。