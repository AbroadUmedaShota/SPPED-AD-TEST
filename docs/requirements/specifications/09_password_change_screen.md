# 画面要件定義書: パスワード変更

**文書バージョン:** 1.0
**作成日:** 2025年9月22日
**作成者:** [システム]

## 1. 概要

本ドキュメントは、ユーザーが自身のログインパスワードを安全に変更するための画面に関する要件を定義する。

### 1.1. 画面目的

- ユーザーが現在のパスワードを知っている場合に、新しいパスワードに更新できること。
- パスワード変更プロセスを通じて、セキュリティ意識を向上させるためのフィードバックを提供すること。
- アカウントのセキュリティをユーザー自身が維持できるようにすること。

## 2. 画面フローと主要シナリオ

### 2.1. 画面への導線

- **アカウント情報モーダル** (`accountInfoModal`) 内に設置された「パスワードを変更する」ボタンをクリックすることで、パスワード変更画面に遷移する。

### 2.2. 主要フロー

パスワード変更は、3つのステップで構成されるウィザード形式のUIとして実装する。

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Browser as ブラウザ
    participant SystemAPI as システムAPI (モック)

    User->>Browser: 「パスワードを変更する」をクリック
    Browser->>Browser: **ステップ1: 現在のパスワード入力画面** を表示

    User->>Browser: 現在のパスワードを入力し「次へ」をクリック
    Browser->>SystemAPI: POST /api/validate-password (現在のパスワード)
    activate SystemAPI

    alt パスワードが正しい
        SystemAPI-->>Browser: 200 OK
        deactivate SystemAPI
        Browser->>Browser: **ステップ2: 新しいパスワード入力画面** に進む
    else パスワードが違う
        SystemAPI-->>Browser: 400 Bad Request
        deactivate SystemAPI
        Browser->>User: エラーメッセージ「現在のパスワードが正しくありません」を表示
    end

    User->>Browser: 新しいパスワードと確認用パスワードを入力
    Browser->>Browser: パスワードの強度と一致をリアルタイムでチェック
    User->>Browser: 「変更」ボタンをクリック

    alt パスワードが一致し、強度の要件を満たす
        Browser->>SystemAPI: POST /api/change-password (新しいパスワード)
        activate SystemAPI
        SystemAPI-->>Browser: 200 OK
        deactivate SystemAPI
        Browser->>Browser: **ステップ3: 完了画面** を表示
    else パスワードが一致しない
        Browser->>User: エラーメッセージ「パスワードが一致しません」を表示
    end
```

## 3. レイアウトとUIコンポーネント

- 画面全体のレイアウトは、ヘッダー、サイドバー、フッターを含む既存のダッシュボードレイアウト (`bizcardSettings.html` 等) を踏襲する。
- メインコンテンツエリアに、ウィザード形式のUIを配置する。

### 3.1. ステップ1: 現在のパスワード入力

- **タイトル:** 「現在のパスワードの確認」
- **入力フィールド:**
    - `現在のパスワード`: パスワード入力フィールド (type="password")
- **ボタン:**
    - `次へ`: ステップ2に進む。
    - `キャンセル`: クリックすると、確認なしでダッシュボードトップ (`index.html`) に戻る。
- **リンク:**
    - `パスワードを忘れた場合`: クリックすると「パスワードのリセット」を促すメッセージを表示する。（画面実装は将来のタスク）

### 3.2. ステップ2: 新しいパスワード入力

- **タイトル:** 「新しいパスワードの設定」
- **入力フィールド:**
    - `新しいパスワード`: パスワード入力フィールド (type="password")
    - `新しいパスワード（確認用）`: パスワード入力フィールド (type="password")
- **パスワード強度インジケーター:**
    - 「新しいパスワード」入力フィールドの下に配置。
    - 入力に応じて「弱い（赤）」「普通（黄）」「安全（緑）」の3段階で強度と色をリアルタイムに表示する。
    - 各強度の基準も表示する。
- **エラーメッセージ表示領域:**
    - 「パスワードが一致しません」などのエラーメッセージを、各入力欄の下にインラインで表示する領域。
- **ボタン:**
    - `変更する`: パスワードの変更を確定する。
    - `クリア`: 入力された2つのパスワードフィールドを空にする。
    - `戻る`: ステップ1に戻る。

### 3.3. ステップ3: 完了

- **アイコン:** 成功を示すチェックマークアイコン。
- **メッセージ:** 「パスワードの変更が完了しました」
- **ボタン:**
    - `ダッシュボードに戻る`: クリックすると `index.html` に遷移する。

## 4. 機能要件

### 4.1. 現在のパスワード検証

- **シナリオ:** ユーザーが現在のパスワードを入力し、「次へ」ボタンをクリックする。
- **期待される結果:**
    - **[正常系]** 入力されたパスワードが正しい場合、ステップ2に進む。
    - **[異常系]** パスワードが間違っている場合、「現在のパスワードが正しくありません。」というエラーメッセージを入力欄の下にインラインで表示する。3回間違えた場合はアカウントロックを示唆するメッセージを表示する（モック）。
    - **[異常系]** 入力が空の場合、「現在のパスワードを入力してください。」というエラーメッセージを入力欄の下にインラインで表示する。

### 4.2. 新しいパスワードの設定

- **シナリオ:** ユーザーが新しいパスワードと確認用パスワードを入力する。
- **期待される結果:**
    - **リアルタイム検証:**
        - 2つのパスワードが一致しない場合、「パスワードが一致しません」というエラーメッセージをリアルタイムでインライン表示する。
        - パスワード強度インジケーターがリアルタイムで更新される。
    - **「変更する」ボタンクリック時:**
        - **[正常系]** 2つのパスワードが一致している場合、バックエンド（モック）に変更リクエストを送信し、成功すればステップ3に進む。パスワード強度が「弱い」場合でも、警告は表示されるが変更は可能とする。
        - **[異常系]** パスワードが一致しない場合、インラインでエラーメッセージを表示する。
        - **[異常系]** 「新しいパスワード」が空の場合、「新しいパスワードを入力してください。」とインラインでエラーメッセージを表示する。

### 4.3. パスワード強度基準

- **テキスト:** 「推奨: 8文字以上で、英字、数字、記号を組み合わせるとより安全になります。」という推奨メッセージを表示する。
- **判定ロジック:**
    - **弱い:** スコア2未満
    - **普通:** スコア2以上4未満
    - **安全:** スコア4以上
    (スコアは文字数、文字種の組み合わせで内部的に計算される)

### 4.4. クリアボタン

- **シナリオ:** ユーザーが「クリア」ボタンをクリックする。
- **期待される結果:** 「新しいパスワード」と「新しいパスワード（確認用）」の両方の入力フィールドの内容が消去される。

## 5. 非機能要件

### 5.1. セキュリティ

- **[本フェーズ]**
    - 全てのパスワード入力フィールドで、入力内容がマスクされること (`type="password"`)。
    - オートコンプリートを無効にすること (`autocomplete="new-password"`)。
- **[将来的なバックエンド実装要件]**
    - パスワードは必ずハッシュ化（Argon2, bcrypt等）して保存すること。
    - API通信は全てHTTPSで行うこと。
    - パスワードリセット機能には、有効期限付きのセキュアなトークンを使用すること。
    - ログイン試行回数制限（Brute-force対策）を実装すること。

### 5.2. ユーザビリティ

- UIは既存の[デザインガイドライン](design/00_design_guideline.md)に準拠する。
- 各ステップで何をすべきか、ユーザーが直感的に理解できること。
- エラーメッセージは具体的で分かりやすい言葉で、入力欄の直下にインライン表示すること。([UIメッセージ定義](design/01_ui_messages.md)を参照)
- **ナビゲーションガード:** いずれかのパスワード入力欄に未保存の変更がある状態でサイドバーのリンクをクリックした場合、「変更が保存されていません。ページを移動しますか？」という確認モーダルを表示し、意図しないページ離脱を防ぐ。

## 6. モックデータ定義

- パスワード検証をシミュレートするため、以下のJSONファイルを使用する。
- **ファイルパス:** `data/dashboard/user_credentials.json`
- **内容:**
  ```json
  {
    "userId": "user@example.com",
    "currentPasswordHash": "mock_hashed_password"
  }
  ```
- **ロジック:**
    - ステップ1で入力されたパスワードが `"password123"` の場合のみを「正しい」とみなし、それ以外は「間違い」として処理する。
