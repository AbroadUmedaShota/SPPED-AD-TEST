# 営業日カレンダー管理 要件定義書 (v1.5)

- 更新日: 2025-10-22
- 初版作成日: 2025-10-22
- 対象システム: SPEED AD 管理者ポータル
- 対象画面: `03_admin/calendar-management.html`

## 1. 概要

### 1.1. 背景と目的
本ドキュメントは、管理者画面の「営業日カレンダー管理」機能に関する要件を定義する。
主な目的は、管理者がデータ入力業務のSLA（サービスレベルアグリーメント）計算の基準となる営業日・休業日を正確に管理し、その情報を外部で利用できるようにすることである。

### 1.2. 用語定義
| 用語 | 説明 |
| :--- | :--- |
| **営業日** | データ入力業務が稼働する日。 |
| **祝日** | 祝日APIから取得される国民の祝日。非稼働日として扱われる。 |
| **特別休業日** | ユーザーが任意で設定する企業独自の休日（夏季休暇など）。非稼働日として扱われる。 |
| **休業日** | 「祝日」と「特別休業日」を総称した非稼働日。 |
| **振替営業日** | 本来は非稼働日（土日、祝日など）だが、営業日として扱う日。 |
| **オペレーター** | データ入力業務を主に行うユーザー。 |
| **オペレーター管理者** | オペレーターの管理やカレンダー設定の編集権限を持つユーザー。 |

### 1.3. 対象画面
- `03_admin/calendar-management.html`

## 2. 画面構成と機能

1.  **KPIサマリー**: カレンダーに関する主要指標を表示する。
2.  **カレンダービュー**: 月次のカレンダー形式で営業日、休業日、振替営業日を視覚的に表示する。
3.  **個別設定**: 手動で設定された休業日・振替営業日を一覧表示し、管理する。
4.  **更新ログ**: カレンダーに対するすべての変更履歴を表示する。

### 2.1. KPIサマリー
画面上部の専用エリアに、以下の3つの指標をコンパクトに表示する。

| KPI項目 | 説明 | 定義 |
| :--- | :--- | :--- |
| **休業日数（今月）** | 現在表示している月の休業日の合計日数。 | `祝日` + `特別休業日` の合計。 |
| **振替営業日数** | 現在表示している月の振替営業日の合計日数。 | 手動設定された `振替営業日` の合計。 |
| **SLA期限間近の案件数** | SLAの期限が迫っている未完了案件の数。 | SLA期日が、本日を起算日として3営業日以内（本カレンダーで定義される営業日を基準）に到来する、特定のステータス（例: 「データ入力待ち」「照合待ち」）の未完了案件の総数。このデータはリアルタイムまたはバッチ処理で更新される。 |


### 2.2. カレンダービュー
- 月次のカレンダーを表示し、日付ごとに営業日、休業日、振替営業日のステータスを色分けして表示する。加えて、アンケートの有無やアサイン状況に応じた動的な色変化やインジケーターが表示される。
- 左右の矢印ボタンで月を移動できる。

#### 2.2.1. 対話的操作 (Interactive Operations)
- カレンダー上の任意の日付をクリックすると、その日の詳細（休日理由など）の確認、新規の休日・振替営業日の設定、関連アンケートの詳細確認、およびアサイン設定が行える**サイドバー/ドロワー**が表示される。サイドバーには「アンケート詳細」「アサイン」「営業日設定」のタブがある。サイドバーは、閉じるボタンまたはオーバーレイクリックで閉じられる。

#### 2.2.2. 凡例 (Legend)
カレンダー下部に、以下の凡例が表示される。

| 種別 | 説明 |
| :--- | :--- |
| ⚡: オンデマンド | オンデマンドアンケートが存在する日 |
| ⭐: 通常 | 通常アンケートが存在する日 |
| 📌: メモあり | メモが登録されている日 |
| (薄いピンクの丸): アサイン未 | オンデマンドアンケートが未アサインの日 |
| (薄い緑の丸): アサイン済 | オンデマンドアンケートがアサイン済の日 |

### 2.2.3. 動的な色の変化
カレンダーの日付セルは、アンケートの種別やアサイン状況、日付のステータスに応じて、背景色やテキスト色が動的に変化します。

#### 背景色のロジック
背景色は主にオンデマンドアンケートの有無とアサイン状況、および休業日設定によって決定されます。

| 条件 | 背景色 | CSSクラス | 説明 |
| :--- | :--- | :--- | :--- |
| オンデマンドアンケートがあり、アサイン済み | 薄い緑 | `bg-green-50` | オンデマンドアンケートが割り当てられている状態。 |
| オンデマンドアンケートがあり、未アサイン | 薄いピンク | `bg-pink-50` | オンデマンドアンケートが未割り当ての状態。 |
| 休業日（祝日、特別休業日） | 薄いグレー | `bg-surface-container-lowest` | データ入力業務が稼働しない日。 |
| 上記以外（通常アンケートのみ、またはアンケートなしの営業日） | 白 | (なし) | 標準の営業日。 |

#### 日付テキストと曜日色のロジック
日付のテキスト色と、日付セルの右上に表示される営業日種別のインジケーターは、以下のロジックで決定されます。

| 条件 | 日付テキスト色 | 営業日種別インジケーター | 説明 |
| :--- | :--- | :--- | :--- |
| 日曜日 | 赤 | - | 週末の休業日。 |
| 土曜日 | 青 | - | 週末の休業日。 |
| オンデマンドアンケートがあり、かつ休業日を営業日として扱う場合 | 通常色 | 赤字で「営業日」 | オンデマンドアンケートにより、休業日が一時的に営業日として扱われる場合。 |
| 休業日（祝日、特別休業日） | 通常色 | 赤字で「休業日」 | データ入力業務が稼働しない日。 |
| 振替営業日 | 通常色 | 青字で「振替営業日」 | 本来は休業日だが、営業日として扱う日。 |
| その他営業日 | 通常色 | 緑字で「営業日」 | 標準の営業日。 |

#### アンケート種別インジケーターのロジック
日付セルの右下には、その日に紐づくアンケートの種別を示すインジケーターが表示されます。

| 条件 | 表示 | CSSクラス | 説明 |
| :--- | :--- | :--- | :--- |
| 通常アンケートとオンデマンドアンケートの両方がある場合 | 「⭐通常」と「⚡オンデマンド」の両方 | - | 複数の種類のアンケートが存在。 |
| 通常アンケートのみの場合 | 「⭐通常」 | - | 通常のアンケートが存在。 |
| オンデマンドアンケートのみの場合 | 「⚡オンデマンド」 | - | オンデマンドのアンケートが存在。 |
| メモがある場合 | 📌アイコン | - | その日にメモが登録されていることを示す。 |

### 2.2.4. 年間カレンダー表示
- ユーザーは「年表示」ボタンをクリックすることで、12ヶ月分のカレンダーを一覧表示できる。
- 各月ごとに、その月の全日付が表示される。
- 日付には、月表示カレンダーと同様の背景色と営業日種別インジケーターが適用される。
- アンケートが登録されている日付は、背景色で薄いピンクに、アサイン済みの日付は薄い緑に色分けされる。
- 土曜日の日付テキストは青色、日曜日の日付テキストは赤色で表示される。
- 年間カレンダー上の日付をクリックすると、該当月の月表示カレンダーに自動的に遷移し、その日の詳細がサイドバー/ドロワーに表示される。

### 2.2.5. 縦表示カレンダー
- ユーザーは「縦表示」ボタンをクリックすることで、カレンダーを縦スクロール形式で表示できる。
- スマートフォンなど、多様なデバイスでの閲覧性を確保する。
- 表示内容は月表示カレンダーに準拠し、日付ごとのステータス、アンケート情報などが表示される。


### 2.3. 個別設定
- 「個別設定」セクションでは、手動またはCSVで登録された特別休業日・振替営業日を一覧表示し、管理する。
- 各項目には、日付、理由、種別が表示され、個別に編集・削除が可能。
- 一覧はページネーション機能を持ち、1ページあたり9件の項目を表示する。ページ下部のナビゲーションボタンで前後のページに移動できる。

### 2.4. 更新ログ
- 「更新ログ」セクションでは、カレンダー設定に対するすべての操作履歴を時系列で表示する。
- ログには「操作日時」「操作者」「操作内容」が含まれる。
- 一覧はページネーション機能を持ち、1ページあたり7件の項目を表示する。ページ下部のナビゲーションボタンで前後のページに移動できる。

## 3. 機能要件詳細

### 3.1. 休日データの取得元
- **祝日API連携**:
  - 国民の祝日は、外部の祝日APIから取得し、自動でカレンダーに「祝日」として反映する（**現在シミュレーション実装**）。
  - 「祝日API同期」ボタンで手動更新が可能（**現在シミュレーション実装**）。
- **手動設定**:
  - 祝日以外に、「特別休業日」や「振替営業日」を任意で設定できる。

### 3.2. 手動での休日/振替営業日設定
- 「休業日を追加」ボタン、またはカレンダーの日付クリックから設定用のサイドバー/ドロワーが表示される。

#### 3.2.1. 設定サイドバー/ドロワー (Setting Sidebar/Drawer)
- **新規追加モード**: 全てのフィールドが空の状態で表示される。
- **編集モード**: 既存の設定内容がフィールドに事前入力された状態で表示される。

| 項目 | UI種別 | 説明 |
| :--- | :--- | :--- |
| **種別** | ラジオボタン | 「特別休業日」、「振替営業日」または「設定解除」を選択。 |
| **日付** | カレンダーセルクリック | 対象の日付はカレンダーセルクリックにより選択される。 |
| **理由** | テキスト入力 | 設定理由を自由記述。（例: 社内研修のため） |
| **操作** | ボタン | 「保存」 |

#### 3.2.2. バリデーション (Validation)
- 保存時に以下の検証を行う。エラーがある場合は、モーダル内にメッセージを表示する。
  - **日付の重複**: 既に同じ種別で登録されている日付は設定できない。エラーメッセージ例: 「選択された日付（YYYY-MM-DD）は既に〇〇として登録されています。」
  - **種別の競合**: ある日付を特定の種別に設定する場合、その日付が他の相反する種別（例: 「祝日」の日に「振替営業日」を設定）として登録済みでないことを検証する。エラーメッセージ例: 「選択された日付（YYYY-MM-DD）は既に〇〇として登録されており、この種別には変更できません。」
  - **過去日の設定**: 新規の休日・振替営業日を過去の日付に設定することはできない。設定可能な最も早い日付は本日とする。ただし、記録修正の目的で、過去に設定された情報の編集・削除は可能とする。
  - **理由の必須入力**: 特別休業日または振替営業日を設定する場合、理由の入力は必須とする。
  - **過去設定の削除**: 過去の日付に設定された情報も物理削除が可能とする。

### 3.3. CSVインポート・エクスポート

#### 3.3.1. CSVによる一括登録 (インポート)
- 長期的な休日・振替営業日が決まっている場合、CSVファイルでの一括登録を可能にする（**現在開発中**）。
- 「休業日CSV取込」ボタンから実行する（**現在開発中**）。
- **インポートモード**: CSVファイル内に既存の登録日と重複する日付があった場合の処理方法を、実行前にユーザーが選択できる。
    1.  **追加のみ**: 既存のデータは変更せず、CSVに含まれる新しい日付のデータのみを追加する。
    2.  **上書き更新**: 既存の手動設定データを、CSVファイルの内容で上書きする（祝日API由来のデータは対象外）。

##### CSVフォーマット (インポート用)
| カラム名 | 型 | 説明 | 必須 |
| :--- | :--- | :--- | :--- |
| `date` | `YYYY-MM-DD` | 対象日 | ✔ |
| `type` | 文字列 | `特別休業日` または `振替営業日` | ✔ |
| `reason` | 文字列 | 理由 | ✔ |

##### UIフィードバックとエラーハンドリング
- ファイル選択後、UI上にファイル名と取り込み件数を表示し、インポートモードを選択の上、実行前に確認を求める。
- CSVファイルの処理はアトミックなトランザクションとして扱う。1行でもエラーがあった場合は、全ての処理をロールバックし、何も登録しない。
- エラー発生時は、どの行のどのデータが原因で失敗したかを示すエラーレポート（CSV形式）をユーザーがダウンロードできるようにする。

#### 3.3.2. カレンダーのエクスポート
- 指定した期間のカレンダー情報をCSV形式でダウンロードできる機能（**現在開発中**）。
- **UI**: 「カレンダーCSV出力」ボタンを設置。クリックすると、期間指定用のモーダルが表示される（**現在開発中**）。
- **期間指定**: 「月指定」または「カスタム範囲指定」で出力期間を選択できる。
- **出力処理**: 指定された期間のすべての日付について、ステータスと理由を出力する。

##### CSVフォーマット (エクスポート用)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `date` | `YYYY-MM-DD` | 対象日 |
| `status` | 文字列 | `営業日`, `祝日`, `特別休業日`, `振替営業日` |
| `reason` | 文字列 | 休日・振替営業日である場合の理由 |

### 3.4. SLA計算への影響
- 本カレンダーで「営業日」として定義された日のみを、データ入力業務のSLA計算の稼働日としてカウントする。**SLA計算において、「振替営業日」は「営業日」と完全に同等に扱う。**
- 休業日・振替営業日の設定変更は、関連する案件のSLAに影響を与えるため、その差分はログとして記録・追跡される必要がある。

### 3.5. 監査ログ

#### 3.5.1. 記録される詳細情報
| 操作種別 | 記録する内容 |
| :--- | :--- |
| **手動設定 (新規)** | `種別`, `対象日`, `理由` |
| **手動設定 (編集)** | `対象日`, 変更したフィールドの `変更前後の値` (例: `reason: "旧理由" -> "新理由"`) |
| **手動設定 (削除)** | `種別`, `対象日`, `理由` |
| **CSV取込** | 取り込んだファイル名、追加された `特別休業日` の件数、追加された `振替営業日` の件数 |
| **API同期** | 同期した祝日の件数、年度 |

#### 3.5.2. UI要件
- ログが多数になった場合に備え、表示エリアには**ページネーション機能**を設ける。
- （将来的な機能拡張として、日付範囲や操作者によるフィルタリング機能、およびログのエクスポート機能の追加を検討する。）

## 4. データモデル（案）
- 休日設定を管理するため、以下のようなスキーマを持つテーブルを想定する。

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | `int` | 主キー |
| `event_date` | `date` | 対象日 |
| `event_type_id` | `int` | イベント種別テーブルへの外部キー (`HOLIDAY`, `SUBSTITUTE_WORKDAY`) |
| `reason` | `string` | 理由 |
| `source_id` | `int` | 登録元テーブルへの外部キー (`API`, `MANUAL`, `CSV`) |
| `created_at` | `datetime` | 作成日時 |
| `created_by` | `string` | 作成者 |
| `updated_at` | `datetime` | 更新日時 |
| `updated_by` | `string` | 更新者 |

## 5. 未決事項
- 連携する「祝日API」の具体的な仕様（エンドポイント、認証方法など）。
- **祝日APIが利用できない（障害発生など）場合のフォールバック仕様。**（例: API失敗時は前回正常取得したデータを元にカレンダーを表示し、画面上に警告メッセージを表示する）
- 「SLA期限間近の案件数」の特定ロジックをバックエンドでどのように実装し、フロントエンドに提供するか。
- **初期実装案**: バックエンドは `GET /api/admin/sla-alert-tasks?days=3` のようなAPIを提供する。このAPIは、SLA期日が指定日数以内に到来するアクティブ案件のリストを返す。

## 6. 非機能要件
本機能は、以下の非機能要件を満たすこと。

### 6.1. セキュリティ
- **アクセス制御**: 本機能の閲覧は「オペレーター」以上の権限、編集（追加・変更・削除・インポート）は「オペレーター管理者」以上の権限を持つユーザーに許可する。
- **監査証跡**: 全てのデータ変更操作は、操作したユーザーIDとタイムスタンプを紐づけて監査ログに記録する。

### 6.2. ユーザビリティ
- **視覚的フィードバック**: すべてのボタンや入力欄は、マウスオーバー時やフォーカス時にスタイルが変化し、操作可能であることが視覚的にわかるようにする。
- **エラーメッセージ**: バリデーションエラーや処理失敗時には、ユーザーが次に取るべきアクションを理解できる、具体的で分かりやすいメッセージを表示する。