# 営業日カレンダー管理 要件定義書 (v1.5)

- 更新日: 2025-10-22
- 初版作成日: 2025-10-22
- 対象システム: SPEED AD 管理者ポータル
- 対象画面: `03_admin/calendar-management.html`

## 1. 概要

### 1.1. 背景と目的
本ドキュメントは、管理者画面の「営業日カレンダー管理」機能に関する要件を定義する。
主な目的は、管理者がデータ入力業務のSLA（サービスレベルアグリーメント）計算の基準となる営業日・休業日を正確に管理し、その情報を外部で利用できるようにすることである。

### 1.2. 用語定義
| 用語 | 説明 |
| :--- | :--- |
| **営業日** | データ入力業務が稼働する日。 |
| **祝日** | 祝日APIから取得される国民の祝日。非稼働日として扱われる。 |
| **特別休業日** | ユーザーが任意で設定する企業独自の休日（夏季休暇など）。非稼働日として扱われる。 |
| **休業日** | 「祝日」と「特別休業日」を総称した非稼働日。 |
| **振替営業日** | 本来は非稼働日（土日、祝日など）だが、営業日として扱う日。 |

### 1.3. 対象画面
- `03_admin/calendar-management.html`

## 2. 画面構成と機能

1.  **KPIサマリー**: カレンダーに関する主要指標を表示する。
2.  **カレンダービュー**: 月次のカレンダー形式で営業日、休業日、振替営業日を視覚的に表示する。
3.  **個別設定**: 手動で設定された休業日・振替営業日を一覧表示し、管理する。
4.  **更新ログ**: カレンダーに対するすべての変更履歴を表示する。

### 2.1. KPIサマリー
画面上部に、以下の3つの指標をコンパクトに表示する。

| KPI項目 | 説明 | 定義 |
| :--- | :--- | :--- |
| **休業日数（今月）** | 現在表示している月の休業日の合計日数。 | `祝日` + `特別休業日` の合計。 |
| **振替営業日数** | 現在表示している月の振替営業日の合計日数。 | 手動設定された `振替営業日` の合計。 |
| **SLA期限間近の案件数** | SLAの期限が迫っている未完了案件の数。 | SLA期日が、本日を起算日として3営業日以内に到来する未完了案件の総数。 |


### 2.2. カレンダービュー
- 月次のカレンダーを表示し、日付ごとに以下のいずれかのステータスを色分けして表示する。
- 左右の矢印ボタンで月を移動できる。

#### 2.2.1. 対話的操作 (Interactive Operations)
- カレンダー上の任意の日付をクリックすると、その日の詳細（休日理由など）の確認や、新規の休日・振替営業日の設定が行える**モーダル**が表示される。

#### 2.2.2. 凡例 (Legend)
| 種別 | 色 |
| :--- | :--- |
| **営業日** | 緑 |
| **休業日** | 赤 |
| **振替営業日** | 黄 |

### 2.2.3. 動的な色の変化
カレンダーの日付セルは、アンケートの種別やアサイン状況に応じて、背景色やテキスト色が動的に変化します。

#### 背景色のロジック
背景色は主にオンデマンドアンケートの状態を示します。色の優先順位は以下の通りです。

| 優先度 | 条件 | 背景色 | CSSクラス | 説明 |
| :--- | :--- | :--- | :--- | :--- |
| 1 (最高) | 手動で「緊急」に設定された日 | 赤 | `bg-red-200` | オペレーターが手動で特定の日を緊急としてマークした場合。 |
| 2 | オンデマンドアンケートがアサイン済みの日 | 緑 | `bg-green-200` | 担当者が割り当てられている状態。 |
| 3 | オンデマンドアンケートが未アサインの**当日** | 赤 | `bg-red-200` | 対応が急がれる未アサインの案件。 |
| 4 | オンデマンドアンケートが未アサイン（当日以外） | 黄 | `bg-yellow-200` | アサインが必要な通常状態の案件。 |
| 5 (最低) | 上記以外（通常アンケートのみ、またはアンケートなし） | 白 | (なし) | 標準の状態。 |

#### テキスト（通常アンケート）のロジック
通常アンケートの情報は、テキストの色とアイコンで状態を示します。

| 条件 | 表示 | CSSクラス | 説明 |
| :--- | :--- | :--- | :--- |
| アサイン済み | `☑` アイコン + アンケート名 | `text-gray-900` | 担当者が割り当てられている状態。 |
| 未アサイン（当日または3日後以内） | アンケート名 | `text-red-600 font-semibold` | 期限が迫っている未アサインの案件。 |
| 未アサイン（上記以外） | アンケート名 | `text-gray-900` | 通常状態の未アサイン案件。 |

### 2.3. 個別設定
- 「個別設定」セクションでは、手動またはCSVで登録された特別休業日・振替営業日を一覧表示する。
- 各項目には、日付、理由、種別が表示され、個別に編集・削除が可能。

### 2.4. 更新ログ
- 「更新ログ」セクションでは、カレンダー設定に対するすべての操作履歴を時系列で表示する。
- ログには「操作日時」「操作者」「操作内容」が含まれる。

## 3. 機能要件詳細

### 3.1. 休日データの取得元
- **祝日API連携**:
  - 国民の祝日は、外部の祝日APIから取得し、自動でカレンダーに「祝日」として反映する。
  - 「祝日API同期」ボタンで手動更新が可能。
- **手動設定**:
  - 祝日以外に、「特別休業日」や「振替営業日」を任意で設定できる。

### 3.2. 手動での休日/振替営業日設定
- 「休業日を追加」ボタン、またはカレンダーの日付クリックから設定用のモーダルウィンドウが表示される。

#### 3.2.1. 設定モーダル (Setting Modal)
- **新規追加モード**: 全てのフィールドが空の状態で表示される。
- **編集モード**: 既存の設定内容がフィールドに事前入力された状態で表示される。

| 項目 | UI種別 | 説明 |
| :--- | :--- | :--- |
| **種別** | ラジオボタン | 「特別休業日」または「振替営業日」を選択。 |
| **日付** | 日付ピッカー | 対象の日付を選択。編集モードでも変更可能だが、重複チェックの対象となる。 |
| **理由** | テキスト入力 | 設定理由を自由記述。（例: 社内研修のため） |
| **操作** | ボタン | 「保存」「キャンセル」 |

#### 3.2.2. バリデーション (Validation)
- 保存時に以下の検証を行う。エラーがある場合は、モーダル内にメッセージを表示する。
  - **日付の重複**: 既に同じ種別で登録されている日付は設定できない。
  - **種別の競合**: ある日付を特定の種別に設定する場合、その日付が他の相反する種別（例: 「祝日」の日に「振替営業日」を設定）として登録済みでないことを検証する。
  - **過去日の設定**: 新規の休日・振替営業日を過去の日付に設定することはできない。設定可能な最も早い日付は本日とする。ただし、記録修正の目的で、過去に設定された情報の編集・削除は可能とする。
  - **理由の必須入力**: 特別休業日または振替営業日を設定する場合、理由の入力は必須とする。
  - **過去設定の削除**: 監査証跡のため、**過去の日付に設定された情報は物理削除できない。** 過去の設定を無効化したい場合は、その操作を打ち消す新しい設定（例: 間違って登録した特別休業日を、同日の振替営業日で上書きする）で対応する。

### 3.3. CSVインポート・エクスポート

#### 3.3.1. CSVによる一括登録 (インポート)
- 長期的な休日・振替営業日が決まっている場合、CSVファイルでの一括登録を可能にする。
- 「休業日CSV取込」ボタンから実行する。
- **インポートモード**: CSVファイル内に既存の登録日と重複する日付があった場合の処理方法を、実行前にユーザーが選択できる。
    1.  **追加のみ**: 既存のデータは変更せず、CSVに含まれる新しい日付のデータのみを追加する。
    2.  **上書き更新**: 既存の手動設定データを、CSVファイルの内容で上書きする（祝日API由来のデータは対象外）。

##### CSVフォーマット (インポート用)
| カラム名 | 型 | 説明 | 必須 |
| :--- | :--- | :--- | :--- |
| `date` | `YYYY-MM-DD` | 対象日 | ✔ |
| `type` | 文字列 | `特別休業日` または `振替営業日` | ✔ |
| `reason` | 文字列 | 理由 | ✔ |

##### UIフィードバックとエラーハンドリング
- ファイル選択後、UI上にファイル名と取り込み件数を表示し、インポートモードを選択の上、実行前に確認を求める。
- CSVファイルの処理はアトミックなトランザクションとして扱う。1行でもエラーがあった場合は、全ての処理をロールバックし、何も登録しない。
- エラー発生時は、どの行のどのデータが原因で失敗したかを示すエラーレポート（CSV形式）をユーザーがダウンロードできるようにする。

#### 3.3.2. カレンダーのエクスポート
- 指定した期間のカレンダー情報をCSV形式でダウンロードできる機能。
- **UI**: 「カレンダーCSV出力」ボタンを設置。クリックすると、期間指定用のモーダルが表示される。
- **期間指定**: 「月指定」または「カスタム範囲指定」で出力期間を選択できる。
- **出力処理**: 指定された期間のすべての日付について、ステータスと理由を出力する。

##### CSVフォーマット (エクスポート用)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `date` | `YYYY-MM-DD` | 対象日 |
| `status` | 文字列 | `営業日`, `祝日`, `特別休業日`, `振替営業日` |
| `reason` | 文字列 | 休日・振替営業日である場合の理由 |

### 3.4. SLA計算への影響
- 本カレンダーで「営業日」として定義された日のみを、データ入力業務のSLA計算の稼働日としてカウントする。**SLA計算において、「振替営業日」は「営業日」と完全に同等に扱う。**
- 休業日・振替営業日の設定変更は、関連する案件のSLAに影響を与えるため、その差分はログとして記録・追跡される必要がある。

### 3.5. 監査ログ

#### 3.5.1. 記録される詳細情報
| 操作種別 | 記録する内容 |
| :--- | :--- |
| **手動設定 (新規)** | `種別`, `対象日`, `理由` |
| **手動設定 (編集)** | `対象日`, 変更したフィールドの `変更前後の値` (例: `reason: "旧理由" -> "新理由"`) |
| **手動設定 (削除)** | `種別`, `対象日`, `理由` |
| **CSV取込** | 取り込んだファイル名、追加された `特別休業日` の件数、追加された `振替営業日` の件数 |
| **API同期** | 同期した祝日の件数、年度 |

#### 3.5.2. UI要件
- ログが多数になった場合に備え、表示エリアには**ページネーション機能**を設ける。
- **日付範囲**や**操作者**でログを絞り込む**フィルタリング機能**を設ける。
- フィルタリングされた結果をCSV形式でダウンロードできる「**ログのエクスポート機能**」を設ける。

## 4. データモデル（案）
- 休日設定を管理するため、以下のようなスキーマを持つテーブルを想定する。

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | `int` | 主キー |
| `event_date` | `date` | 対象日 |
| `event_type_id` | `int` | イベント種別テーブルへの外部キー (`HOLIDAY`, `SUBSTITUTE_WORKDAY`) |
| `reason` | `string` | 理由 |
| `source_id` | `int` | 登録元テーブルへの外部キー (`API`, `MANUAL`, `CSV`) |
| `created_at` | `datetime` | 作成日時 |
| `created_by` | `string` | 作成者 |
| `updated_at` | `datetime` | 更新日時 |
| `updated_by` | `string` | 更新者 |

## 5. 未決事項
- 連携する「祝日API」の具体的な仕様（エンドポイント、認証方法など）。
- **祝日APIが利用できない（障害発生など）場合のフォールバック仕様。**（例: API失敗時は前回正常取得したデータを元にカレンダーを表示し、画面上に警告メッセージを表示する）
- 「SLA期限間近の案件数」の特定ロジックをバックエンドでどのように実装し、フロントエンドに提供するか。
- **初期実装案**: バックエンドは `GET /api/admin/sla-alert-tasks?days=3` のようなAPIを提供する。このAPIは、SLA期日が指定日数以内に到来するアクティブ案件のリストを返す。

## 6. 非機能要件
本機能は、以下の非機能要件を満たすこと。

### 6.1. セキュリティ
- **アクセス制御**: 本機能の閲覧は「オペレーター」以上の権限、編集（追加・変更・削除・インポート）は「オペレーター管理者」以上の権限を持つユーザーに許可する。
- **監査証跡**: 全てのデータ変更操作は、操作したユーザーIDとタイムスタンプを紐づけて監査ログに記録する。

### 6.2. ユーザビリティ
- **視覚的フィードバック**: すべてのボタンや入力欄は、マウスオーバー時やフォーカス時にスタイルが変化し、操作可能であることが視覚的にわかるようにする。
- **エラーメッセージ**: バリデーションエラーや処理失敗時には、ユーザーが次に取るべきアクションを理解できる、具体的で分かりやすいメッセージを表示する。