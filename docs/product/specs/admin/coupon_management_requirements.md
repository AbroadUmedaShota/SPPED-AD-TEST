# クーポン管理画面 要件定義書 (v1.7)

**文書バージョン:** 1.7  
**作成日:** 2025年10月31日  
**作成者:** [Gemini]

**改訂履歴**

| バージョン | 改訂日 | 改訂内容 | 改訂者 |
| :--- | :--- | :--- | :--- |
| 1.7 | 2025/10/31 | UIとデータモデルの整合性向上（「すべてのユーザー」選択肢の明記とUI挙動の追加） | [Gemini] |
| 1.6 | 2025/10/31 | セキュリティ要件にCSVダウンロード時の監査ログ記録と権限管理を追加 | [Gemini] |
| 1.5 | 2025/10/31 | 最終レビュー結果を反映し、UIとデータモデルの整合性向上、各仕様を明確化 | [Gemini] |
| 1.4 | 2025/10/31 | プライベートクーポンの対象者指定をIDからメールアドレスに変更 | [Gemini] |
| 1.3 | 2025/10/31 | 特定ユーザー専用のプライベートクーポン要件を追加 | [Gemini] |
| 1.2 | 2025/10/31 | 各要件の深掘り、バリデーション、UI挙動、データモデルを詳細化 | [Gemini] |
| 1.1 | 2025/10/31 | ユーザー提供のメモに基づき、要件を全面的に加筆・修正 | [Gemini] |
| 1.0 | 2025/10/04 | 初版作成 | [Gemini] |

---

## 1. 概要

### 1.1 目的
本ドキュメントは、クーポンコードの発行、管理、追跡を行う「クーポン管理」画面 (`03_admin/coupon-management.html`) の機能およびUI要件を定義する。

### 1.2 背景
キャンペーン施策や特定ユーザーへのインセンティブ（例: トラブル発生時のお詫び）として、柔軟な条件でクーポンを発行・管理する必要がある。本要件定義書は、そのための画面仕様を明確化するものである。

### 1.3 スコープ
- クーポンの一覧表示、検索、絞り込み、ソート、ページネーション機能
- クーポンの新規作成（通常クーポンおよび特定ユーザー専用のプライベートクーポン）機能
- クーポンの編集および利用停止機能
- クーポン利用ログの確認機能
- CSV出力機能

---

## 2. 画面構成とUI要素

### 2.1 共通レイアウト
- ヘッダー、サイドバー、フッターは他の管理画面と共通のコンポーネントを使用する。
- 画面H1として「クーポン管理」を表示する。

### 2.2 メインコンテンツエリア

#### 2.2.1 アクションヘッダー
- H1「クーポン管理」の右側に「新規作成」ボタンを配置する。ボタンクリックで後述の「クーポン作成モーダル」を表示する。

#### 2.2.2 クーポン検索エリア
- クーポン一覧の上部に、アコーディオンまたはカード形式で検索（絞り込み）機能を配置する。
- **UI挙動:**
    - 検索条件の変更後、「検索」ボタン押下時に一覧が更新される。
    - 「リセット」ボタン押下で、全ての検索条件を初期状態に戻し、一覧を再読み込みする。
- **検索項目:**
    - **キーワード検索:** `通常クーポン・プライベートクーポン共通でコードと名称を検索。入力がメールアドレス形式の場合、対象メールアドレスも検索対象に加える。`
    - **ステータス:** プルダウン形式で「すべて」「有効」「利用上限到達」「利用停止」「期限切れ」から選択。
    - **有効期限:** 開始日と終了日をカレンダーUIで選択可能な日付範囲指定。

#### 2.2.3 クーポン一覧エリア
- **UI挙動:**
    - **ソート:** デフォルトは作成日時の降順。各列ヘッダー（コード、名称、割引率、有効期限など）クリックで、その列を基準に昇順/降順ソートが可能。
    - **ページネーション:** 一覧下部にページネーションコントロールを配置する。
- **表示項目（テーブル）:**
    - コード（クーポンコード）
    - 名称（クーポン名）
    - 対象
    - 割引率 (%)
    - 有効期限 (YYYY/MM/DD)
    - 利用回数 (実績 / 上限)
    - ステータス (下記参照)
    - 操作ボタン
- **「対象」列の表示:**
    - **通常クーポン:** 「新規」「既存」など対象者種別を表示。
    - **プライベートクーポン:** 対象者のメールアドレスを表示し、隣に専用アイコン（例: 人型アイコン）を付与して視覚的に区別しやすくする。

- **ステータス表示:**
| ステータス | 説明 | 色（例） |
| :--- | :--- | :--- |
| **有効** | 現在利用可能な状態 | Green |
| **利用上限到達** | 利用回数が上限に達した状態 | Orange |
| **利用停止** | 管理者によって手動で停止された状態 | Gray |
| **期限切れ** | 有効期限が過ぎた状態 | Red |

- **操作ボタン:**
    - **詳細:** クーポンの詳細情報と利用ログを表示するモーダルを開く。
    - **編集:** クーポン情報の一部を編集するモーダル（後述）を開く。
- **一覧上部の機能:**
    - **CSV出力ボタン:** 現在の検索・ソート条件で絞り込まれた一覧をCSV形式でダウンロードする。
    - **表示件数:** 1ページあたりの表示件数をプルダウン（10件, 20件, 50件）で切り替え可能にする。デフォルトは10件。

---

## 3. 機能要件

### 3.1 クーポン新規作成（モーダル）
- 「新規作成」ボタンからモーダルで起動する。
- **クーポン種別:**
    - 「通常クーポン」「プライベートクーポン」を選択するラジオボタンを最初に配置する。
    - 選択に応じて、後続の入力フォームの内容が切り替わる。
- **コード生成モード:**
    - **手動作成:** ユーザーが任意の文字列をクーポンコードとして設定。サーバーサイドで重複チェックを行う。
    - **自動作成:** システムが推測困難なランダムな文字列（例: 12桁の英数字）を生成する。
- **設定項目とバリデーション:**
    - **クーポンコード (手動時):** `必須`, `50文字以内`, `使用可能な文字は半角英数字とハイフン(-)`。重複時は「`このクーポンコードは既に使用されています。`」といったエラーを表示。
    - **クーポン名称:** `必須`, `100文字以内`
    - **対象メールアドレス (プライベートクーポン選択時):** `必須`, `メールアドレス形式であること`。ユーザー存在チェックに失敗した場合は「`入力されたメールアドレスを持つユーザーは存在しません。`」といったエラーを表示。
    - **クーポン対象者 (通常クーポン選択時):** `必須`, `チェックボックスや複数選択可能なリストから指定`（例: すべてのユーザー, 新規, 既存）。「すべてのユーザー」を選択した場合、対象プランの入力欄は非活性となる。
    - **対象プラン (通常クーポン選択時):** `任意`, `チェックボックスや複数選択可能なリストから指定`（例: Standard, Premium）。
    - **有効期限:** `必須`
        - 開始日は本日以降の日付であること。
        - 終了日は開始日以降の日付であること。
    - **割引率:** `必須`, `1〜100の整数`
    - **利用回数上限:** `必須`, `1以上の整数`。「無制限」の場合は専用のチェックボックスを用意し、チェック時は入力欄を無効化する（内部的には`null`や`-1`を許容）。
    - **メモ:** `任意`, `500文字以内`
- **UI挙動:**
    - 作成成功時には「クーポンを作成しました」というトーストメッセージを表示し、モーダルを閉じて一覧を更新（1ページ目に戻り、新しいクーポンが表示されるようにする）。
    - バリデーションエラー時は、モーダルを閉じずに各入力フィールドの下にエラーメッセージを表示する。

### 3.2 クーポン編集
- 一覧の「編集」ボタンからモーダルで起動する。
- **編集可能項目:**
    - クーポン名称
    - 有効期限
    - 利用回数上限
    - メモ
- **UI挙動:**
    - 編集不可項目（クーポン種別、対象メールアドレス、コード、割引率、対象者など）はフォーム内で非活性（disabled）表示とする。
    - 保存成功時には「クーポン情報を更新しました」というトーストメッセージを表示し、モーダルを閉じて一覧の該当行を更新する。

### 3.3 クーポン詳細・利用停止
- 一覧の「詳細」ボタンからモーダルで起動する。
- **表示項目:**
    - クーポンの全情報（作成日時、作成者、最終更新日時などを含む）。
    - **利用ログ:** このクーポンがいつ、どのアカウントによって使用されたかの履歴を時系列で一覧表示する。ログが多い場合はモーダル内でページネーションを設ける。
- **利用停止:**
    - 詳細モーダル内に「クーポンを停止する」ボタンを配置する。
    - クリックすると「このクーポンを停止します。一度停止すると元に戻せませんが、よろしいですか？」といった確認ダイアログを表示。
    - 同意後、ステータスを「利用停止」に変更し、「クーポンを停止しました」というトーストメッセージを表示。一覧の表示も更新する。

### 3.4 利用ログ
- クーポンの不正利用防止と効果測定のため、以下のログを記録・表示する。
- **記録内容:**
    - **発行ログ:** `いつ`, `誰が (管理者ID)`, `どのIPアドレスから` 発行したか。
    - **利用ログ:** `いつ`, `どのアカウントが (利用者メールアドレス)`, `どのIPアドレスから` 利用したか。
- **表示形式:**
    - クーポン詳細モーダル内で、時系列にログを表示する。
    - 例: `[2025/10/31 10:00] user@example.com がクーポンコード: SPRING25 を使用しました。(IP: 192.0.2.1)`

### 3.5 クーポン利用時の検証ロジック
- **プライベートクーポンの検証:**
    - クーポンに `targetUserEmail` が設定されている場合、クーポンを利用しようとしているユーザーのメールアドレスが `targetUserEmail` と一致することを検証する。
    - 一致しない場合は、「このクーポンはご利用いただけません」というエラーメッセージを表示し、利用を拒否する。

---

## 4. データモデル

### 4.1 Coupon エンティティ

| フィールド名 | データ型 | 必須 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | String | ✔ | ユニークID (例: `c_xxxxxxxx`) |
| `code` | String | ✔ | クーポンコード (例: `SPRING25`) |
| `name` | String | ✔ | クーポン名称 |
| `discountRate` | Integer | ✔ | 割引率 (1-100) |
| `validFrom` | DateTime | ✔ | 有効期間（開始） |
| `validTo` | DateTime | ✔ | 有効期間（終了） |
| `usageLimit` | Integer | ✔ | 利用回数上限 (`-1` や `null` は無制限) |
| `usageCount` | Integer | ✔ | 現在の利用回数 (デフォルト: 0) |
| `targetType` | Enum | ✔ | 対象者種別 (`ALL`, `NEW_USER`, `EXISTING_USER`, `SPECIFIC_EMAIL`) |
| `targetUserEmail` | String | | `targetType`が`SPECIFIC_EMAIL`の場合の対象メールアドレス |
| `targetPlan` | Enum[] | | 対象プラン種別。複数選択可 (例: `STANDARD`, `PREMIUM`) |
| `status` | Enum | ✔ | `ACTIVE`, `LIMIT_REACHED`, `INACTIVE`, `EXPIRED` |
| `memo` | String | | 管理用メモ |
| `createdBy` | String | ✔ | 作成者ID |
| `createdAt` | DateTime | ✔ | 作成日時 |
| `updatedAt` | DateTime | ✔ | 最終更新日時 |

### 4.2 CouponLog エンティティ

| フィールド名 | データ型 | 必須 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | String | ✔ | ログのユニークID |
| `couponId` | String | ✔ | 関連するクーポンのID |
| `logType` | Enum | ✔ | ログ種別 (`CREATION`, `USAGE`, `STATUS_CHANGE`) |
| `operatorIdentifier` | String | ✔ | 操作者の識別子（管理者IDまたは利用者メールアドレス） |
| `ipAddress` | String | ✔ | 操作元のIPアドレス |
| `details` | String | | 操作詳細のテキスト |
| `timestamp` | DateTime | ✔ | ログ記録日時 |

---

## 5. 非機能要件

### 5.1 パフォーマンス
- 検索および一覧表示は、クーポンデータが10,000件の場合でも2秒以内に完了する。
- モーダルの表示は500ミリ秒以内に完了する。

### 5.2 セキュリティ
- **アクセス制御:** クーポン管理画面は、特定の権限を持つ管理者のみがアクセス可能であること。
- **コード生成:** 自動生成されるクーポンコードは、第三者に推測されにくい十分なエントロピーを持つこと。
- **CSVダウンロード時の監査:** CSVダウンロードの操作は監査ログに記録し、権限のある管理者のみが実行可能とすること。
- **不正利用対策:** 同一IPアドレスからの短時間での連続クーポン利用など、異常な挙動を検知した場合は管理者に通知する仕組みを検討する（将来検討事項）。

---

## 6. 将来検討事項
- クーポンの一括発行・一括編集機能。
- A/Bテストのための複数クーポンパターンの簡易生成機能。
- クーポンの効果測定レポート機能（利用者数、利用率、関連売上などを可視化）。
