# 請求管理画面 要件定義書 (v1.0)

**文書バージョン:** 1.0  
**作成日:** 2025年10月4日  
**作成者:** [Gemini]

**改訂履歴**

| バージョン | 改訂日 | 改訂内容 | 改訂者 |
| :--- | :--- | :--- | :--- |
| 1.0 | 2025/10/04 | 初版作成 | [Gemini] |

---

## 1. 概要

### 1.1 目的
請求サイクルと入金状況を管理する「請求管理」画面 (`03_admin/billing-management.html`) の要件を定義する。サマリカード、請求一覧、詳細パネル、ステータスログを明文化する。

### 1.2 背景
名刺入力・アンケート運用に伴う請求は案件単位で管理され、モックではアンケート別請求一覧や詳細の編集UIが実装されている。これを正式な要件として整理する。

### 1.3 スコープ
- 請求状況サマリ、アンケート別請求一覧、請求詳細パネル、ステータス遷移ログ。
- CSV出力・新規請求書作成・自動バッチ設定などの主要アクション。

---

## 2. 画面構成

### 2.1 ヘッダー
- H1「請求管理」と右側に `bg-secondary` の「自動バッチ設定」ボタンを配置する。【F:03_admin/billing-management.html†L23-L31】

### 2.2 請求状況サマリ
- 4枚のカード（今月予定額、未請求、支払遅延、直近入金）を表示し、単位は円または件数で表記する。【F:03_admin/billing-management.html†L33-L55】
- 表示単位切り替え（アンケート単位／請求書単位）を右上のトグルで提供する。【F:03_admin/billing-management.html†L34-L42】

### 2.3 アンケート別請求一覧
- 上部に CSV 出力と新規請求書作成ボタンを配置する。【F:03_admin/billing-management.html†L56-L77】
- テーブル列: アンケート、請求額、請求日、入金ステータス、担当者、メモ、操作。【F:03_admin/billing-management.html†L78-L116】
- 操作列には詳細、ステータス更新、リマインド送信、編集などを配置する。

### 2.4 請求詳細 & ログ
- 2カラム構成で左に詳細パネル、右にステータス遷移ログを配置する。【F:03_admin/billing-management.html†L117-L167】
- 詳細パネルでは請求書番号、請求日、入金予定日、ステータス、備考を表示し、更新・入金確認・PDFプレビューのアクションを提供する。【F:03_admin/billing-management.html†L117-L143】
- ログは時系列リストで操作内容を記録する。【F:03_admin/billing-management.html†L144-L167】

---

## 3. 機能要件

### 3.1 フィルタリング
- 将来的にアンケート一覧にフィルタバーを追加予定。現状は全件表示。
- 切替トグルに応じてテーブルの列と表示内容を調整できるよう設計する。

### 3.2 請求書操作
- 「新規請求書作成」は専用モーダルまたは `/admin/billing/create` へ遷移。
- 「ステータス更新」「入金確認」はモーダルで支払日・備考を入力し、API更新後にラベルを変更する。
- 「リマインド送信」はメール送信APIを呼び出し、履歴に記録する。

### 3.3 詳細パネル
- テーブル行選択時に詳細パネルの内容を更新する。
- 更新を保存時、差分のみ送信し、成功後にサマリカードを再計算する。

### 3.4 ステータスログ
- ログは最新10件を表示し、それ以上はページングまたは「もっと見る」ボタン（将来対応）。

---

## 4. データモデル（例）
```json
{
  "summary": {
    "forecast": 4500000,
    "unbilled": 1200000,
    "delayed": 2,
    "latestPayment": "2025-09-29"
  },
  "invoices": [
    {
      "survey": "展示会2025春アンケート",
      "amount": 1200000,
      "billedAt": "2025-09-25",
      "status": "paid",
      "owner": "田中 太郎",
      "note": "特急対応"
    }
  ],
  "selectedInvoice": {
    "id": "INV-20250928-001",
    "billedAt": "2025-09-28",
    "dueDate": "2025-10-10",
    "status": "pending",
    "memo": "先方稟議中"
  },
  "logs": [
    {
      "timestamp": "2025-09-30T10:00:00+09:00",
      "actor": "佐藤 花子",
      "message": "入金予定を10/10に変更し、リマインドメール送信"
    }
  ]
}
```

---

## 5. 非機能要件
- 一覧の初期ロードは 3 秒以内。
- 金額表示はロケール `ja-JP` でフォーマットし、税抜/税込切替に対応できるよう拡張性を確保する。
- ステータスラベルは色覚バリアフリーに配慮し、アイコンとテキストの両方で状態を伝える。

---

## 6. 将来検討事項
- 入金予定日・請求額のチャート表示。
- 定期請求のスケジューリングと自動送信。
- 会計システムとのAPI連携（仕訳データエクスポート）。
