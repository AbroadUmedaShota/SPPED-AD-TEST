# 07_グラフ化ページ機能要件定義書

## 1. 概要

このページでは、SPEEDレビューページから遷移し、シングルアンサーおよびマルチアンサー形式のアンケート回答データを元にグラフを作成することで、アンケートの回答内容を視覚的に分析できます。ユーザーは、アンケートの回答データをグラフ形式で確認し、必要に応じてグラフの種類（棒グラフ、円グラフなど）を切り替えることで、回答傾向を直感的に把握することが可能です。

## 2. ページ遷移

- **起点:** `/speed-review.html`
- **操作:** 「グラフ化」ボタンをクリック
- **遷移方法:**
    - グラフ化ページへの遷移は、URLパラメータにアンケートID（`surveyId`）を付与して行う。アンケートIDは `sv_ユーザーID4桁_年度2桁+連番3桁` 形式（JSTの作成日＋連番）で受け渡す。
    - **遷移先URL:** `/graph-page.html` (仮)
    - 例: `/graph-page.html?surveyId=sv_0001_25025`
    - 必要に応じて、追加のフィルタリング情報（例: 日付範囲）もURLパラメータまたはセッションストレージ経由で引き渡すことを検討する。**初期実装ではURLパラメータを優先し、複雑なフィルタリング条件はセッションストレージの利用を検討する。**

## 3. 主要機能

### 3.1. グラフ表示機能

- **対象アンケート項目:**
    - **シングルアンサー形式の質問:**
        - **ドーナツグラフ**を用いて、選択肢ごとの回答数と割合を表示する。
        - グラフ中央にはその設問の「有効回答総数」を表示する。
    - **マルチアンサー形式の質問:**
        - **横棒グラフ**を用いて、各選択肢の回答数を表示する。長い選択肢名でも重ならずに比較可能とする。
- **表示形式と切り替え:**
    - 各グラフカードにおいて、「棒グラフ」と「円グラフ（ドーナツ）」をボタン操作で動的に切り替え可能。
    - **注記**: マトリクス設問や特定の複雑な設問形式については、視認性と実装上の制約から切り替えが制限（固定）される場合がある。
- **クイック・インサイト（最多回答）:**
    - 各グラフカードの右上に、最も回答が多かった項目名とパーセンテージをバッジ形式で表示し、即座に結論を読み取れるようにする。
- **表示設定 (新規):**
    - ユーザーが以下の表示項目をトグルスイッチで一括制御可能。
        - サマリー（最多回答バッジ）の表示/非表示
        - グラフ上の数値ラベルの表示/非表示
        - ドーナツグラフ中央の合計値の表示/非表示
        - グラフ背景のグリッド線の表示/非表示

### 3.2. データ取得と連携

- **フィルタ連動:** 
    - フィルタエリアでの条件変更時、全てのグラフ・テーブル・KPIが即座に再集計・再描画される。
- **補足:** グラフページ内でのフィルタリング機能は別途実装し、SPEEDレビューページからのフィルタリング条件は初期状態では引き継がない。

### 3.3. フィルタリング機能 (刷新)

- **簡易検索:**
    - **表示対象日**: 会期（1/4〜1/17）の各日程をドロップダウンで選択。選択すると開始・終了日時が自動セットされる。
- **詳細検索:**
    - **開始日時 / 終了日時**: カレンダーおよび時間入力で任意の範囲を指定。会期外の日付は選択不可（グレーアウト）。

### 3.4. エクスポート機能 (強化)

- **Excel一括出力:**
    - 表示中の全グラフデータを1つのExcelファイル（.xlsx）にまとめて出力。
    - **各設問1シート構成**: 1設問につき1シートを生成する。  
      現行実装では互換性と可読性を優先し、シート名は `Q1`, `Q2`, ...（一部除外系は `Ex_番号`）の採番形式を採用する。
    - **ハイブリッド出力**:
        - **左側**: Excelの正式な「テーブル機能」による集計数値データ（フィルタ・ソート可能）。
        - **右側**: 高解像度キャプチャで取得したグラフ画像。  
          現行実装は描画負荷とのバランスを取り、`html2canvas` の `scale: 2` を使用する。
    - **バックグラウンド処理の操作感**:
        - 出力実行中も画面操作（スクロールや他項目の閲覧）が可能。
        - 画面右下に進捗状況（◯件目/全件、パーセンテージ、プログレスバー）を示すフローティング・タスクパネルを表示。
    - **離脱防止ガード**:
        - 出力実行中にユーザーが誤ってページを閉じたり移動したりしようとした際、ブラウザ標準の警告ダイアログを表示して注意を促す。
    - **軽量・高品質**: 画像のアスペクト比を完全に維持し、報告資料としてそのまま活用可能な品質を実現。

- **個別画像ダウンロード:**
    - ApexChartsのネイティブエクスポート機能を活用し、最高画質（scale: 3）のPNG画像を保存。
    *   資料への貼り付けを考慮し、周囲に30pxの白い余白（パディング）を自動付与。
    - **注記**: 現在、UI上では各グラフのネイティブツールバーは非表示に設定されており、Excel一括出力機能による統合レポート出力を推奨している。

## 4. ユーザーインターフェース要件

- **ページレイアウト:**
    *   デスクトップ表示時はグラフカードを **2列（grid-cols-2）** で配置し、一覧性を確保する。
    *   各カード内は **「タイトル・サマリー」→「メイングラフ」→「詳細データ表」** の縦積み構成（バーティカル・インサイト・レイアウト）とし、視覚的なストーリー性を重視する。
- **分析コントロール（フィルターエリア）:**
    *   **スマート・フィルター・バー**: 「表示期間」セレクターを中心とした1列のツールバー形式。
    *   **階層的開示**: 「カスタム範囲」選択時のみ、開始・終了日時の詳細入力パネルがアニメーションと共に展開される。
    *   **表示設定の統合**: フィルターエリア下部に、サマリー・数値ラベル・合計値・詳細表・グリッド線の表示/非表示を一括制御できるチェックボックス群を配置。
    *   **注釈**: 「グリッド線」設定は、軸を持つ棒グラフ形式でのみ有効である旨をラベルに明記する。
- **視認性向上:**
    *   **フローティングラベル**: 入力フォームのラベルは、フォーカス時に上部へ浮かび上がる動的なアニメーションを採用。
    *   **グラフ上の数値表示**: グラフ内にパーセンテージ（ドーナツ型）や件数（横棒型）を直接描画する。
    *   **アイコンシステム**: グラフタイトル横に、設問特性に応じたアイコン（`analytics`: 分析可能, `subject`: テキスト主体）を表示。
- **安定した体験（表示のガタつき対策）:**
    *   ヘッダーおよびサイドバーの領域に最小高さを確保し、読み込み時のガタつきを防止する。

## 5. 非機能要件

- **パフォーマンス:**
    - 大量の回答データ（例: 数千件以上）でも、グラフ描画が数秒以内に完了すること。
    - **グラフライブラリ:** SVGベースで解像度に依存しない最高品質の描画が可能な **ApexCharts** を採用。
- **画質:**
    - 内部描画解像度を3倍（devicePixelRatio: 3）に固定し、高精細ディスプレイでの視認性とキャプチャ品質を確保する。
- **レスポンシブデザイン:**
    - デスクトップ、タブレット、スマートフォンなど、様々な画面サイズでグラフが適切に表示され、操作可能であること。
    - グラフのサイズは画面サイズに合わせて動的に調整されること。
    - 必要に応じて、モバイル表示では一部の情報を省略したり、表示形式を最適化したりする。
- **セキュリティ:**
    - アンケート回答データへのアクセスは、認証・認可されたユーザーのみに限定する。
    - **アクセス制御:** グラフページへのアクセスは、ログイン済みのユーザーに限定し、表示するアンケートデータはユーザーがアクセス権を持つもののみとする。
    - URLパラメータやセッションストレージ経由で渡されるデータは、改ざん防止策を講じる。
- **アクセシビリティ:**
    - グラフは、色覚多様性を持つユーザーにも情報が伝わるよう、色の選定に配慮する（例: パターンやテクスチャの利用、コントラスト比の確保）。
    - スクリーンリーダー利用者向けに、グラフの代替テキストやデータテーブルを提供する。
- **保守性:**
    - コードはモジュール化され、将来的な機能追加や変更が容易であること。
    - グラフライブラリのバージョンアップや、アンケート質問形式の追加に対応できる設計とする。
- **国際化対応:**
    - グラフのタイトル、軸ラベル、凡例、ボタンテキストなど、ユーザーインターフェースに表示される全てのテキストは、将来的な多言語対応を考慮し、外部化されたリソースファイルから読み込む設計とする。

## 6. 今後の検討事項

- グラフ化対象外の質問形式に対する代替表示方法の検討（例: フリー入力に対するワードクラウド、マトリクスに対するヒートマップ）。
- グラフのインタラクティブ性（例: ツールチップ表示、特定のデータポイントのドリルダウン機能、期間選択による動的なグラフ更新）。
- グラフデータの画像（PNG, SVGなど）のダウンロード機能の実装。
- 複数のアンケートを横断した比較グラフの表示。
- グラフ表示設定の保存機能（例: デフォルトのグラフ形式、表示する質問の選択）。
- **テスト要件:**
    - **単体テスト:** データ集計ロジック、グラフ描画コンポーネントの単体テストを実施する。
    - **結合テスト:** データ取得からグラフ表示までの一連の流れをテストする。
    - **UIテスト:** グラフ形式の切り替え、レスポンシブ表示、エラー表示などのUI動作を確認する。
