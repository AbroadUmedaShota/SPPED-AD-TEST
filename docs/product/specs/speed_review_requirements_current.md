# 機能仕様書: SpeedAd - SPEEDレビュー画面 (詳細版)

## 1. 概要

本ドキュメントは、SpeedAdサービスのSPEEDレビュー画面に関する機能仕様、UI/UX、データ連携、および内部ロジックを詳細に定義する。
この画面は、ユーザーがアンケート回答データを効率的に確認、検索、編集、分析するための包括的なインターフェースとして機能する。

---

## 2. UI/UX 仕様

### 2.1. 基本レイアウト
- **2カラム構成**: 画面左側にメインコンテンツ（データテーブル）、右側に操作用のツールボックスを配置。ツールボックスは画面スクロールに追従する。
- **コンポーネント化**: ヘッダー、サイドバー、フッターは共通HTMLとして外部から動的に読み込まれ、ページの一貫性を担保する。

### 2.2. 主要UIコンポーネント詳細

- **アンケート名表示 (`#review-survey-name`):**
    - **目的**: ユーザーが現在どのアンケートをレビューしているか常に明確にする。
    - **動作**: ページの初期化時に、URLの`surveyId`を元にデータソースからアンケート名を取得し、動的に表示する。回答データ件数に依存しないため、回答が0件でも表示される。

- **回答データテーブル (`#reviewTable`):**
    - **目的**: 回答データを一覧形式で表示し、迅速な内容把握と詳細へのアクセスを提供する。
    - **インタラクション**:
        - **行ホバー**: マウスカーソルを乗せた行の背景色が、視認性の高い薄青色に変化する。これにより、ユーザーの現在の注目対象を明確にする。
        - **行クリック**: 行全体がクリック可能領域であり、クリックするとその回答の詳細情報がモーダルで表示される。
    - **動的列ヘッダー (`#dynamic-question-header`):**
        - **表示内容**: 「表示設問」ツールボックスで選択された設問名が表示される。
        - **省略表示ルール**: ユーザーの視認性を高め、レイアウト崩れを防ぐため、以下の2段階の省略処理が適用される。
            1.  設問名から括弧（`()` `（）`）とその内部文字列をすべて除去する。
            2.  上記処理後、文字数が17文字を超える場合は、17文字目以降を`...`に置換する。

- **ツールボックス:**
    - **目的**: データ探索と操作のための機能を一箇所に集約し、効率的な作業を支援する。
    - **コンポーネント**:
        - **キーワード検索**: 氏名、会社名、および現在表示中の設問の回答を対象とした部分一致検索。
        - **回答で絞り込み**: 選択中の設問の回答内容を元にした絞り込みフィルター。
        - **日時で絞り込み**: 回答日時による期間フィルター。
        - **フィルターリセット**: 全てのフィルター条件を初期状態に戻す。
        - **グラフ化**: 現在のアンケートデータをグラフ分析ページで表示するために画面遷移する。

- **表示設問選択 (`#question-selector-container`):**
    - **目的**: テーブルに表示する任意の回答列をユーザーが選択できるようにする。
    - **UI**: アンケート内の全設問がボタンのリストとして表示される。ボタンの設問名もテーブルヘッダーと同様のルールで省略表示されるが、マウスオーバーで完全な設問名がツールチップ表示される。

- **回答詳細モーダル (`reviewDetailModal`):
    - **目的**: 個別の回答に関するすべての情報を、画面遷移なく確認・編集する。
    - **編集フロー**:
        1.  初期表示は読み取り専用モード。
        2.  「編集する」ボタンをクリックすると、名刺情報が入力フォームに切り替わり、編集モードになる。
        3.  フッターのボタンが「保存する」「キャンセル」に変化する。
        4.  「保存する」をクリックすると、(現時点ではダミーとして)保存処理が実行された旨のアラートが表示され、読み取り専用モードに戻る。
        5.  「キャンセル」をクリックすると、変更は破棄され、読み取り専用モードに戻る。

---

## 3. 機能仕様とロジック

### 3.1. 状態管理 (State Management)
ページの動作は以下の主要な変数によって管理される。

- `allCombinedData`: 現在のアンケートに関する全回答データを保持する配列。
- `currentSurvey`: 現在のアンケートの定義情報（質問リスト、タイプ等）を保持するオブジェクト。
- `currentIndustryQuestion`: 「表示設問」で選択されている設問の完全なテキスト。
- `currentSearchTerm`, `currentDateFilter`, `currentAnswerFilter`: 各フィルターの現在の選択値を保持する。
- `currentPage`: ページネーションの現在のページ番号。

### 3.2. 主要ワークフロー

#### 3.2.1. ページ初期化 (`initializePage`)
1.  URLから `surveyId` を取得する。
2.  `surveyId` を元に `displaySurveyName` を実行し、アンケート名を表示。
3.  `surveyId` に応じて、JSONまたはCSVのデータソースから全回答データを非同期で取得し、`allCombinedData` と `currentSurvey` を設定する。
4.  `updateAnswerFilterAvailability` を実行し、「回答で絞り込み」プルダウンの初期状態を設定する。
5.  `displayPage` を初回実行し、テーブルの初期表示を行う。
6.  `setupEventListeners` を実行し、各種操作要素にイベントリスナーを設定する。

#### 3.2.2. フィルター適用 (`applyFilters`)
1.  `allCombinedData` をベースのデータとする。
2.  `currentSearchTerm` が設定されていれば、キーワードによる絞り込みを実行。
3.  `currentDateFilter` が設定されていれば、日付による絞り込みを実行。
4.  `currentAnswerFilter` が設定されていれば、回答内容による絞り込みを実行。
5.  絞り込まれた最終的なデータセットを引数として `displayPage(1, filteredData)` を呼び出し、テーブルを更新する。

#### 3.2.3. テーブル描画 (`displayPage`)
1.  引数として渡されたデータセット（フィルター後のデータ）を受け取る。
2.  **ソート処理**: データセットを以下のルールでソートする。
    -   `currentIndustryQuestion` の回答が「未回答」（空, null, `-`）の項目を配列の**末尾**に移動させる。
    -   それ以外の項目間の順序は維持される（安定ソート）。
3.  **ページネーション処理**: ソート済みのデータセットから、`currentPage` と `rowsPerPage` に基づいて、現在のページに表示すべき部分配列を切り出す。
4.  切り出したデータを `populateTable` に渡し、HTMLテーブルの行を生成・描画する。
5.  ソート済みの全データ件数を元に `setupPagination` を呼び出し、ページネーションコントロールを更新する。

#### 3.2.4. 表示設問の変更 (`handleQuestionSelectClick`)
1.  クリックされたボタンから、新しい設問名を取得し `currentIndustryQuestion` を更新する。
2.  テーブルヘッダーの設問名を更新する。
3.  `currentAnswerFilter` の値をリセットする。
4.  `updateAnswerFilterAvailability` を呼び出し、新しい設問のタイプに応じて「回答で絞り込み」プルダウンを有効化または無効化する。
5.  `applyFilters` を呼び出してテーブル表示を更新する。

### 3.3. 「回答で絞り込み」の有効化/無効化ロジック
- **目的**: 自由記述など、絞り込みに適さない設問タイプではフィルター機能を表示しないことで、ユーザーの混乱を防ぐ。
- **ロジック (`updateAnswerFilterAvailability`):**
    1.  `currentSurvey` の定義情報から、`currentIndustryQuestion` に一致する設問の `type` を特定する。
    2.  `type` が `single_choice`, `multi_choice`, `matrix_single`, `matrix_multi` のいずれかであるか判定する。
    3.  **有効な場合**: プルダウンを有効化し、`populateAnswerFilterDropdown` を呼び出して回答の選択肢を生成する。
    4.  **無効な場合**: プルダウンを無効化し、選択肢を「(対象外の設問)」のみにする。

---

## 4. データ連携仕様

- **データソース**: `surveyId` に応じて、以下のいずれかからデータを取得する。
    1.  **JSON**: `surveys-with-details.json` (設問定義) と `survey-answers.json` (回答データ)。
    2.  **CSV**: `0008000154.csv` と `0008000154ncd.csv`。この場合、設問定義は `speedReviewService.js` 内にハードコードされたものが利用される。
- **データ加工**: データソースに関わらず、`speedReviewService` によって、アンケート定義(`survey`)と名刺情報(`businessCard`)が各回答データに結合された、統一されたオブジェクト構造 (`allCombinedData`) に加工されてからページに渡される。