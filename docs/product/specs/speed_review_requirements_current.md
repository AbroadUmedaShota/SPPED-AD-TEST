# 機能仕様書: SpeedAd - SPEEDレビュー画面 (詳細版)

## 1. 概要

本ドキュメントは、SpeedAdサービスのSPEEDレビュー画面に関する機能仕様、画面体験、データ連携、および内部ロジックを詳細に定義する。
この画面は、ユーザーがアンケート回答データを効率的に確認、検索、編集、分析するための包括的なインターフェースとして機能する。

---

## 2. 画面体験仕様

### 2.1. 基本レイアウト
- **2カラム構成**: 画面左側にメインコンテンツ（データテーブル）、右側に操作用のツールボックスを配置。ツールボックスは画面スクロールに追従する。
- **コンポーネント化**: ヘッダー、サイドバー、フッターは共通HTMLとして外部から動的に読み込まれ、ページの一貫性を担保する。

### 2.2. 主要UIコンポーネント詳細

- **アンケート名表示 (`#review-survey-name`):**
    - **目的**: ユーザーが現在どのアンケートをレビューしているか常に明確にする。
    - **動作**: ページの初期化時に、URLの`surveyId`を元にデータソースからアンケート名を取得し、動的に表示する。回答データ件数に依存しないため、回答が0件でも表示される。

- **回答データテーブル (`#reviewTable`):**
    - **目的**: 回答データを一覧形式で表示し、迅速な内容把握と詳細へのアクセスを提供する。
    - **インタラクション**:
        - **行ホバー**: マウスカーソルを乗せた行の背景色が、視認性の高い薄青色に変化する。これにより、ユーザーの現在の注目対象を明確にする。
        - **行クリック**: 行全体がクリック可能領域であり、クリックするとその回答の詳細情報がモーダルで表示される。
    - **動的列ヘッダー (`#dynamic-question-header`):**
        - **表示内容**: 「表示設問」ツールボックスで選択された設問名が表示される。
        - **省略表示ルール**: ユーザーの視認性を高め、レイアウト崩れを防ぐため、以下の2段階の省略処理が適用される。
            1.  設問名から括弧（`()` `（）`）とその内部文字列をすべて除去する。
            2.  上記処理後、文字数が25文字を超える場合は、25文字目以降を`...`に置換する。

- **アナリティクスダッシュボード:**
    - **現在選択中の設問カード (`#kpi-current-question-card`):**
        - **目的**: テーブルの動的カラムおよび分析対象の設問を明確にし、変更のトリガーとする。
        - **画面表現**: ドロップダウン風のデザイン。右端に `arrow_drop_down` アイコンを配置し、エリア全体がクリック可能であることを示唆。ホバー時に背景色が変化。
        - **動作**: クリックすると、アンケート内の全設問から選択できる専用モーダルを表示。
    - **時間帯別回答数グラフ (`#timeSeriesChart`):**
        - **目的**: 回答ボリュームの推移を可視化。
        - **表示モード切替**: 「自動（実データ範囲）」と「固定（9:00-19:00）」をスイッチで切り替え。
        - **チャート種別**: 折れ線エリアチャート。

- **ツールボックス（サイドバー）:**
    - **目的**: フィルタリング機能を整理し、ユースケースに合わせた絞り込みを提供。
    - **構成**: 「簡易検索」と「詳細検索」のタブ構造。
    - **簡易検索**: 表示対象日（会期内日程）のドロップダウン、およびステータスフィルター。
    - **詳細検索**: 開始/終了日時を個別のカレンダー（Time Picker有効）で指定。
    - **操作性**: サイドバー展開時に背景のグレー領域をクリックすることでサイドバーを閉じることが可能。

- **詳細分析ページへの導線:**
    - **文言**: 「詳細分析ページへ」
    - **アイコン**: `analytics`
    - **動作**: クリックでより高度な分析が可能なグラフページ (`graph-page.html`) へ遷移。

- **表示設問選択モーダル (`questionSelectModal`):**
    - **画面表現**: 画面中央に大きなリストとして全設問を表示。
    - **同期**: 設問選択時、テーブルヘッダー、動的カラム、ダッシュボードの属性内訳が即座に同期して更新される。

- **回答詳細モーダル (`reviewDetailModal`):
    - **目的**: 個別の回答に関するすべての情報を、画面遷移なく確認・編集する。
    - **編集フロー**:
        1.  初期表示は読み取り専用モード。
        2.  「編集する」ボタンをクリックすると、名刺情報が入力フォームに切り替わり、編集モードになる。
        3.  フッターのボタンが「保存する」「キャンセル」に変化する。
        4.  「保存する」をクリックすると、(現時点ではダミーとして)保存処理が実行され、完了メッセージ（トースト通知）が表示された後に読み取り専用モードに戻る。
            - **注記**: 現状の「保存」はメモリ上の `allCombinedData` を更新するのみのモック実装であり、ページのリロードによってリセットされる。
        5.  「キャンセル」をクリックすると、変更は破棄され、読み取り専用モードに戻る。

---

## 3. 機能仕様とロジック

### 3.1. 状態管理
ページの動作は以下の主要な変数によって管理される。

- `allCombinedData`: 現在のアンケートに関する全回答データを保持する配列。
- `currentSurvey`: 現在のアンケートの定義情報（質問リスト、タイプ等）を保持するオブジェクト。
- `currentIndustryQuestion`: 「表示設問」で選択されている設問の完全なテキスト。
- `currentDateFilter`: 日付フィルターの現在の選択値を保持する。
- `currentPage`: ページネーションの現在のページ番号。

### 3.2. 主要ワークフロー

#### 3.2.1. ページ初期化 (`initializePage`)
1.  URLから `surveyId` を取得する。
2.  `surveyId` を元に `displaySurveyName` を実行し、アンケート名を表示。
3.  `surveyId` に応じて、JSONまたはCSVのデータソースから全回答データを非同期で取得し、`allCombinedData` と `currentSurvey` を設定する。
4.  `displayPage` を初回実行し、テーブルの初期表示を行う。
5.  `setupEventListeners` を実行し、各種操作要素にイベントリスナーを設定する。

#### 3.2.2. フィルター適用 (`applyFilters`)
1.  `allCombinedData` をベースのデータとする。
2.  **日時フィルタ**:
    - **簡易検索**: 「表示対象日」セレクターで選択された日程の「0:00〜23:59」を範囲として適用。
    - **詳細検索**: 開始日時および終了日時のカレンダーから取得した個別の値を範囲として適用。
3.  **ステータスフィルタ**: 「完了」または「進行中」のステータスで絞り込み。
4.  絞り込まれた最終的なデータセットを基に、テーブルおよびダッシュボード（KPI、各種グラフ）を同期的に更新する。

#### 3.2.3. テーブル描画 (`displayPage`)
1.  引数として渡されたデータセット（フィルター後のデータ）を受け取る。
2.  **ソート処理**: データセットを以下のルールでソートする。
    -   `currentIndustryQuestion` の回答が「未回答」（空, null, `-`）の項目を配列の**末尾**に移動させる。
    -   それ以外の項目間の順序は維持される（安定ソート）。
3.  **ページネーション処理**: ソート済みのデータセットから、`currentPage` と `rowsPerPage` に基づいて、現在のページに表示すべき部分配列を切り出す。
4.  切り出したデータを `populateTable` に渡し、HTMLテーブルの行を生成・描画する。
5.  ソート済みの全データ件数を元に `setupPagination` を呼び出し、ページネーションコントロールを更新する。

---

## 5. データエクスポートとプラン制限

### 5.1. ダウンロードの基本設計
- **画面上の動線**: SPEEDレビュー画面には直接の「ダウンロードボタン」を配置せず、データ出力が必要な場合は「アンケート一覧（ホーム）」のダウンロードオプション、または「詳細分析ページ（グラフ）」のExcel一括出力を利用する。
- **プランによる制限**: エクスポート可能なデータの種類は、利用者の契約プラン（無料 / プレミアム）によって動的に制御される。

### 5.2. プラン別エクスポート権限マトリクス
| 出力データ種別 | 無料 | プレミアム（月額） | 備考 |
| :--- | :---: | :---: | :--- |
| **アンケート回答（テキスト）** | ○ | ○ | CSV/Excel形式。標準的な回答内容。 |
| **名刺入力データ（テキスト）** | × | ○ | 会社名、氏名、メールアドレス等のデータ化結果。 |
| **名刺画像 / 設問添付画像** | × | ○ | 撮影された名刺および第3の画像ファイル。 |
| **名刺・回答結合データ** | × | ○ | SPEEDレビューの表示同様、名刺と回答を紐付けたリッチデータ。 |
| **分析Excelレポート** | × | ○ | グラフ分析ページから出力される加工済みレポート。 |

### 5.3. 画面体験制御方針（役割分担）
- **Abroad担当（画面体験）**: 
    - 非対象プランのユーザーがダウンロードオプションを選択した際、制限されている項目をロック（グレーアウト）し、プレミアムプラン加入LPへの誘導を行う。
- **Rep担当（ロジック）**: 
    - APIリクエスト時にサーバーサイドでプラン権限を検証し、不正なデータ取得をブロックする。
    - プランに応じたデータのフィルタリングロジック（画像パスの除外等）を実装する。
