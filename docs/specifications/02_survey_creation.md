# アンケート新規作成・編集ページ仕様書

## 1. 概要

本ドキュメントは、アンケート新規作成・編集ページの画面仕様と機能要件を定義する。
このページでは、ユーザーが新しいアンケートを作成し、既存のアンケートを編集するための各種設定を行う。

## 2. 画面レイアウト

画面は主に3つのエリアで構成される。

- **ヘッダー:** 全ページ共通のヘッダー。ブランドロゴ、ユーザー情報が表示される。
- **サイドバー:** 全ページ共通のナビゲーションメニュー。
- **メインコンテンツ:** アンケート作成・編集フォームが配置される主要な作業エリア。

## 3. 入力項目とバリデーション

メインコンテンツの各入力項目、データ連携、およびバリデーションルールを以下に定義する。

### 3.1. 基本情報

アンケートの基本的な情報を設定する。

| 項目名 | ID | タイプ | 必須 | バリデーションルール / 説明 | データ構造 (`sample_survey.json`) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| アンケート名（社内管理用） | `surveyName` | テキスト入力 | ✔ | ・空でないこと<br>・最大50文字 | `name` |
| 表示タイトル（回答者向け）| `displayTitle` | テキスト入力 | ✔ | ・空でないこと<br>・最大100文字 | `displayTitle` |
| 説明 | `description` | テキストエリア | | ・最大500文字 | `description` |
| 回答受付開始日 | `periodStart` | 日付選択 | ✔ | ・空でないこと<br>・日付形式であること | `periodStart` |
| 回答受付終了日 | `periodEnd` | 日付選択 | ✔ | ・空でないこと<br>・`periodStart`同日以降の日付であること | `periodEnd` |
| プラン | `plan` | プルダウン | ✔ | ・以下のいずれかから選択<br>・通常作業<br>・特急作業<br>・超特急作業<br>・オンデマンドプラン | `plan` |
| データ化完了予定日 | `completionDate` | 表示（自動計算）| | 「回答受付終了日」と「プラン」を基に自動計算される。<br>・通常作業: 終了日の6営業日後<br>・特急作業: 終了日の3営業日後<br>・超特急作業: 終了日の1営業日後<br>・オンデマンドプラン: 終了日当日 | `completionDate` |
| メモ | `memo` | テキストエリア | | ・最大1000文字 | `memo` |

### 3.2. 名刺データ関連

名刺のデータ化に関する設定を行う。

| 項目名 | ID | タイプ | 必須 | バリデーションルール | データ構造 (`sample_survey.json`) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 名刺データ化 | `bizcardEnabled` | プルダウン | | ・「有効」または「無効」から選択 | `settings.bizcard.enabled` |
| 名刺データ化依頼枚数 | `bizcardRequest` | 数値入力 | | ・0以上の整数 | `settings.bizcard.requestCount` |

### 3.3. お礼メール設定

回答者へのお礼メールの送信方法を設定する。

| 項目名 | ID | タイプ | 必須 | バリデーションルール | データ構造 (`sample_survey.json`) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| お礼メール | `thankYouEmailSettings` | プルダウン | ✔ | ・「自動送信」「手動」「設定なし」から選択<br>・デフォルト値: 「設定なし」 | `settings.thankYouEmail.mode` |

## 4. 質問グループ・質問項目設定

アンケートの質問項目を動的に追加・編集するエリア。

### 4.1. 質問グループ管理

- 複数の質問グループを作成可能。
- 各質問グループはアコーディオン形式で開閉可能。
- 質問グループの追加、複製、削除が可能。
- 質問グループはドラッグ＆ドロップで並べ替え可能（`Sortable.js` を使用）。

### 4.2. 質問項目管理

- 各質問グループ内に複数の質問項目を追加可能。
- 質問項目の複製、削除が可能。
- 質問項目はドラッグ＆ドロップで並べ替え可能（`Sortable.js` を使用）。並べ替え時に質問番号が自動で振り直される。

### 4.3. 質問タイプ詳細仕様

フローティングメニューから選択し、質問項目として追加できる各タイプの詳細仕様を定義する。

--- 

#### **シングルアンサー (`single_answer`)**
- **目的**: 複数の選択肢の中から、回答者に1つだけを選ばせる。
- **設定画面UI**:
    - 質問文入力フィールド (必須, 最大200文字)
    - 選択肢入力フィールドのリスト (少なくとも2つ, 各最大100文字)
    - 「選択肢を追加」ボタン
    - 「『その他』を追加」チェックボックス
    - 必須回答トグルスイッチ
- **回答画面での表示**: ラジオボタンのリスト。「その他」が有効な場合、自由記述欄付きのラジオボタンが最後に追加される。
- **データ構造**:
    ```json
    {
      "questionId": "q-2",
      "type": "single_answer",
      "text": "貴社の主な業種をお聞かせください。",
      "required": true,
      "options": [
        { "optionId": "opt-2-1", "text": "製造業" },
        { "optionId": "opt-2-2", "text": "IT・通信" }
      ],
      "hasOther": true
    }
    ```

--- 

#### **マルチアンサー (`multi_answer`)**
- **目的**: 複数の選択肢の中から、回答者に1つ以上を選ばせる。
- **設定画面UI**:
    - シングルアンサーと同様のUI。
    - 最小・最大選択数の設定フィールド (任意)。
- **回答画面での表示**: チェックボックスのリスト。「その他」も同様。
- **データ構造**: `single_answer` と同様の構造に、`minSelection`, `maxSelection` キーが追加される可能性がある。

--- 

#### **フリーアンサー (`free_answer`)**
- **目的**: 回答者にテキストを自由に入力させる。
- **設定画面UI**:
    - 質問文入力フィールド (必須, 最大200文字)
    - 回答形式の選択（単一行 / 複数行）
    - 最小・最大文字数の設定フィールド (任意)
    - 必須回答トグルスイッチ
- **回答画面での表示**: `<input type="text">` または `<textarea>`。
- **データ構造**:
    ```json
    {
      "questionId": "q-1",
      "type": "free_answer",
      "text": "ご意見・ご感想をご自由にお書きください。",
      "required": false,
      "isMultiLine": true,
      "maxLength": 500
    }
    ```

--- 

*(他の質問タイプについても同様に、目的、設定UI、回答画面表示、データ構造を定義)*

## 5. UI/UX

- 質問タイプ選択メニューを開くボタンはフローティング形式で表示され、ドラッグで画面上の任意の位置に移動可能。
- スクロール時にボタンのテキストラベルが自動的に隠れる。
- クリックとドラッグ操作を厳密に区別し、意図しないメニュー表示を防ぐ。
- メニューは画面外にはみ出さないように表示位置が調整される。
- スクロールまたはブラウザのリサイズ時に、開いているメニューは自動的に閉じる。
- 画面右側にアウトラインマップが表示され、アンケートのセクション構造を一覧できる。
- ユーザーがスクロールすると、現在表示されているセクションに対応するアウトラインマップの項目がハイライトされる（スクロールスパイ機能）。
- 質問グループはアコーディオン形式で開閉でき、コンテンツの整理と視認性向上に寄与する。

## 6. データ連携

- アンケートデータは `src/services/surveyService.js` を介して取得・更新される。
- アンケートデータの構造は `data/sample_survey.json` に定義されており、`surveyId`, `name`, `displayTitle`, `description`, `periodStart`, `periodEnd`, `plan`, `deadline`, `memo`, `questionGroups` (質問グループと質問項目を含む) などのフィールドを持つ。

## 7. モーダル連携

以下のモーダルがページから開かれる。

- アカウント情報モーダル (`accountInfoModal.js`)
- 問い合わせモーダル (`contactModal.html`)
- 名刺設定モーダル (`bizcardSettings.html`)
- サンキューメール設定モーダル (`thankYouEmailSettings.html`)

## 8. 保存時の総合バリデーション

「保存する」ボタンクリック時には、個々のフィールドのバリデーションに加えて、以下の総合的なチェックが行われる。

- **必須項目の網羅性**: `3.1` および `3.3` で定義された必須項目がすべて入力・選択されているか。
- **質問項目の整合性**: 少なくとも1つの質問グループに、1つ以上の質問項目が設定されているか。
- **選択肢の整合性**: 選択肢を持つ質問タイプ（シングルアンサー等）には、少なくとも2つの選択肢が設定されているか。

これらの条件を満たさない場合、保存は実行されず、該当箇所にエラーメッセージが表示される。
