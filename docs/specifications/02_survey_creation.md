# アンケート新規作成・編集ページ仕様書（完全版・多言語対応反映）

## 1. 概要

本ドキュメントは、アンケート新規作成・編集ページの画面仕様と機能要件を定義する。ユーザーは本ページで新しいアンケートを作成し、既存のアンケートを編集できる。画面上の表示は日本語のみとするが、アンケート自体は多言語設定が可能である（日本語・英語・中国語簡体字・中国語繁体字）。

---

## 2. 画面レイアウト

* **ヘッダー:** 共通。ブランドロゴ、ユーザー情報。
* **サイドバー:** 共通。ナビゲーションメニュー。
* **メインコンテンツ:** アンケート作成・編集フォーム。

---

## 3. 入力項目とバリデーション

### 3.1 基本情報

| 項目名       | ID               | タイプ     | 必須 | バリデーション          | データ構造            |
| --------- | ---------------- | ------- | -- | ---------------- | ---------------- |
| アンケート名    | `surveyName`     | テキスト    | ✔  | 空禁止、最大50文字       | `name`           |
| 表示タイトル    | `displayTitle`   | テキスト    | ✔  | 空禁止、最大100文字      | `displayTitle`   |
| 説明        | `description`    | テキストエリア | -  | 最大500文字          | `description`    |
| 回答受付開始日   | `periodStart`    | 日付      | ✔  | 空禁止、日付形式、当日以降    | `periodStart`    |
| 回答受付終了日   | `periodEnd`      | 日付      | ✔  | 空禁止、開始日以降        | `periodEnd`      |
| プラン       | `plan`           | プルダウン   | ✔  | 通常/特急/超特急/オンデマンド | `plan`           |
| データ化完了予定日 | `completionDate` | 自動計算    | -  | 営業日計算ルールに基づく     | `completionDate` |
| メモ        | `memo`           | テキストエリア | -  | 最大1000文字         | `memo`           |

#### データ化完了予定日の計算ルール

* 営業日: 平日（土日・祝日は除外）。祝日は `holidays.json` で管理。
* 計算例: 終了日=2025/09/01, プラン=通常 → 完了予定日=2025/09/09。

---

### 3.2 名刺データ関連

| 項目名        | ID               | タイプ   | 必須                        | バリデーション | データ構造                           |
| ---------- | ---------------- | ----- | ------------------------- | ------- | ------------------------------- |
| 名刺データ化     | `bizcardEnabled` | プルダウン | -                         | 有効/無効   | `settings.bizcard.enabled`      |
| 名刺データ化依頼枚数 | `bizcardRequest` | 数値    | `bizcardEnabled=有効` の場合必須 | 整数、0以上  | `settings.bizcard.requestCount` |

---

### 3.3 お礼メール設定

| 項目名         | ID                      | タイプ     | 必須           | バリデーション      | データ構造                             |
| ----------- | ----------------------- | ------- | ------------ | ------------ | --------------------------------- |
| お礼メール       | `thankYouEmailSettings` | プルダウン   | ✔            | 自動送信/手動/設定なし | `settings.thankYouEmail.mode`     |
| メール本文テンプレート | `thankYouEmailTemplate` | テキストエリア | `自動送信` の場合必須 | 最大2000文字     | `settings.thankYouEmail.template` |
| 差出人情報       | `thankYouEmailSender`   | テキスト    | `自動送信` の場合必須 | メールアドレス形式    | `settings.thankYouEmail.sender`   |

---

### 3.4 多言語対応設定

| 項目名     | ID                      | タイプ     | 必須                               | バリデーション                   | データ構造                                   |
| ------- | ----------------------- | ------- | -------------------------------- | ------------------------- | --------------------------------------- |
| 多言語対応   | `isMultilingualEnabled` | トグルスイッチ | -                                | ONの場合、各設問に多言語入力欄が表示される    | `is_multilingual_enabled`               |
| 設問多言語入力 | `localizedQuestions`    | タブUI入力  | `isMultilingualEnabled=ON` の場合必須 | 対象言語: 日本語、英語、中国語(簡体字/繁体字) | `survey_details.question_text` (JSON形式) |

---

## 4. 質問グループ・質問項目設定

* 質問グループ: 追加/複製/削除/並べ替え可。
* 質問項目: グループ内で複数追加可能。複製/削除/並べ替え可。番号は自動振り直し。
* 質問タイプ: シングルアンサー、マルチアンサー、フリーアンサー、プルダウン選択、数値入力、日付入力、マトリクス。
* **多言語入力:** 多言語対応ON時は、質問文・選択肢を各言語タブで入力可能。

---

## 5. UI/UX

* フローティング質問追加ボタン（ドラッグ可）。
* メニューは画面外にはみ出さない。
* スクロール/リサイズでメニュー自動クローズ。
* アウトラインマップ表示（PC:常時, モバイル:非表示）。
* **多言語入力UI:** 言語タブ切替式。未入力言語がある場合はタブに警告アイコンを表示。
* **アクセシビリティ:** キーボード操作/スクリーンリーダー対応。

---

## 6. データ連携

* `surveyService.js` 経由でAPI通信。
* API変更点:

  * `is_multilingual_enabled` の送受信追加。
  * `survey_details.question_text` をJSON形式で送受信。
  * 回答データ(`answers`)に `language_code` を保存。
* CSVエクスポートに「回答言語」「国」列を追加。

---

## 7. モーダル連携

* アカウント情報 (`accountInfoModal.js`)
* 問い合わせ (`contactModal.html`)
* 名刺設定 (`bizcardSettings.html`)
* サンキューメール設定 (`thankYouEmailSettings.html`)

---

## 8. 保存時の総合バリデーション

* 必須項目の網羅性（基本情報/お礼メール/多言語入力）。
* 少なくとも1つの質問グループに1項目。
* 選択肢付き質問には2つ以上の選択肢。
* 条件付き必須: 名刺依頼枚数、お礼メール、言語ごとの質問文/選択肢。

### エラーメッセージ仕様

* 項目直下に赤字で表示。
* ページ上部に「保存に失敗しました（詳細は各項目を確認してください）」を表示。
* **多言語入力エラー:** 言語タブに警告アイコンを表示。
* 表示言語は日本語のみ（管理画面）。

---

## 9. 多言語アンケート回答フロー

* 回答者がQRコードを読み取ると、言語選択画面を表示。
* ブラウザの言語設定を検出し推奨言語をハイライト。
* 選択された言語でアンケートUIを表示。
* 回答データに `language_code` を保存。

---

## 10. データモデル変更

* `surveys`: `is_multilingual_enabled` (Boolean) 追加。
* `survey_details`: 質問文・選択肢をJSON形式で保持。
* `answers`: `language_code` を追加。
* `admin_users`: `skill_languages` を配列で保持（中国語は簡体字・繁体字を区別）。

---

## 11. 非機能要件

* パフォーマンス: 多言語対応後も応答速度3秒以内。
* セキュリティ: 言語スキル外のデータアクセス禁止。
* 可用性: 稼働率99.9%以上。
* 運用・保守: 言語別の処理量をモニタリング。設定ファイルで言語追加に柔軟対応。Webフォントは中国語対応済みを採用。
* OCR最適化: 回答言語が指定されている場合、Google Cloud Vision API に `language_hints` を連携。

---

## 12. 今後の拡張（フェーズ2以降）

* UIの完全国際化（管理画面の多言語対応）。
* 対応言語の拡大（韓国語・東南アジア言語・欧州言語など）。
* ユーザー基本言語設定機能。

---