# 請求書確認機能 仕様書

## 1. 概要
ユーザーが自身のサービス利用状況とそれに対応する請求内容をオンラインで確認できるようにするための機能。
請求書の発行から通知までを自動化し、管理コストを削減することを目的とする。

## 2. 主な機能
- **請求書一覧表示機能**: 過去の請求書を一覧で確認できる。
- **請求書詳細表示機能**: 各月の請求明細を確認できる。
- **請求書発行とメール通知機能**: 月末に請求書を自動発行し、ユーザーにメールで通知する。

## 3. 画面仕様
### 3.1. 請求書一覧画面 (`invoiceList.html`)
- **目的**: ユーザーが過去の請求履歴を俯瞰できるようにする。
- **レイアウト**: 既存のダッシュボード画面と同様のテーブル形式。
- **表示項目**:
    - 発行月
    - 請求金額
- **操作**:
    - 各行をクリックすると、対応する月の請求書詳細画面に遷移する。

#### 3.1.2. 主要UI要素と動作
- **パンくずリスト**: 現在の画面位置を示す（例: ダッシュボード > 請求書一覧）。
- **タイトル**: 「請求書一覧」と表示。
- **フィルタ/ソートエリア (任意)**:
    - **期間選択**: 開始日と終了日を選択できるカレンダーピッカー。
    - **検索ボックス**: 請求書IDや金額などで絞り込み検索が可能。
    - **ソートオプション**: 発行月、請求金額などで昇順/降順ソートが可能。
    - **適用ボタン**: フィルタ/ソート条件を適用する。
- **請求書一覧テーブル**:
    - **ヘッダー**: 「発行月」「請求金額」
    - **行**: 各請求書データに対応。
        - **発行月**: `YYYY年MM月` 形式で表示。
        - **請求金額**: `¥XX,XXX` 形式で表示。
        - **詳細ボタン**: 各行の右端に「詳細」ボタンを配置。
    - **行クリック**: テーブルの行全体をクリック可能とし、詳細画面へ遷移する。
- **ローディング表示**: データ取得中はテーブル領域にスピナーなどのローディングインジケータを表示する。
- **エラーメッセージ表示**: データ取得失敗時やデータがない場合に、テーブル領域に分かりやすいメッセージを表示する。
- **ページネーション (任意)**: 大量のデータがある場合に、ページを切り替えて表示する。

#### 3.1.3. 非機能要件への考慮
- **パフォーマンス**: 初期表示では、直近のデータ（例: 過去1年分）のみを表示し、フィルタリングやページネーションで全データを取得する方式を検討。データ取得中はローディング表示を行い、ユーザーに待機を促す。
- **セキュリティ**: バックエンドでのアクセス制御を前提とし、ユーザーが自身の `accountId` に紐づく請求書データのみを取得・表示できるようにする。
- **エラーハンドリング**: データ取得APIからのエラーレスポンスを適切に処理し、ユーザーフレンドリーなエラーメッセージを表示する。請求書データが0件の場合、「表示する請求書がありません」といったメッセージを表示する。

### 3.2. 請求書詳細画面 (`invoice-detail.html`)
- **目的**: ユーザーが請求内容の詳細を視覚的に分かりやすく確認し、必要に応じてPDFをダウンロードできるようにする。
- **レイアウト**: Web画面としての視認性を重視したセクション分けと、請求項目を明確に表示するレイアウト。
- **表示項目**:
    - 請求書番号、発行日、支払期限
    - 請求先情報（会社名、担当者名）
    - **請求明細**:
        - サービス内容、数量、単価、金額など、請求項目を分かりやすく表示。
        - `invoices.json` のデータに加え、視覚的な見やすさのためにモックデータを活用。
    - 小計、消費税、合計請求額
    - 振込先情報
    - 注意事項
- **操作**:
    - **印刷ボタン**: クリック時、`invoice-print.html` を新しいウィンドウで開き、印刷ダイアログを表示する。この画面はPDFと同じレイアウトを持つ。
    - **PDFダウンロードボタン**: クリック時、`02_dashboard/seikyuusyo_sample.pdf` を直接ダウンロードする。

#### 3.2.2. 主要UI要素と動作
- **パンくずリスト**: 現在の画面位置を示す（例: ダッシュボード > 請求書一覧 > 請求書詳細）。
- **タイトル**: 「請求書詳細」と表示。
- **請求書情報エリア**:
    - 請求書番号、発行日、支払期限、請求先情報（会社名、担当者名）を表示。
- **請求明細テーブル**:
    - No., 品名1, 品名2, 数量, 単価, 金額の各列で明細を表示。
    - 小計、消費税、合計請求金額を表示。
- **振込先情報エリア**:
    - 金融機関名、支店名、口座種類、口座番号、口座名義を表示。
- **注意事項エリア**:
    - 固定の注意事項を表示。
- **アクションボタン**:
    - **印刷ボタン**: クリック時、現在の請求書IDをパラメータとして`invoice-print.html`を新しいウィンドウで開き、ロード完了後に`window.print()`を呼び出すことで、印刷ダイアログを表示する。
    - **PDFダウンロードボタン**: クリック時、画面の内容をPDF形式でダウンロードする。
- **ローディング表示**: データ取得中は画面全体または主要コンテンツ領域にスピナーなどのローディングインジケータを表示する。
- **エラーメッセージ表示**: データ取得失敗時やデータがない場合に、画面中央に分かりやすいメッセージを表示する。

#### 3.2.3. 非機能要件への考慮
- **パフォーマンス**: 請求書データ取得時のAPIレスポンスタイムを考慮し、ローディング表示を適切に行う。
- **セキュリティ**: URLパラメータの`invoiceId`は、サーバーサイドおよびクライアントサイドで厳密に検証する。ユーザーが自身の`accountId`に紐づく請求書データのみを閲覧できるようなアクセス制御を徹底する。
- **エラーハンドリング**:
    - **無効な請求書ID**: URLに無効な`invoiceId`が指定された場合、エラーメッセージを表示するか、請求書一覧画面へリダイレクトする。
    - **データ不整合**: 取得した請求書データが仕様と異なる場合（例: 必須項目が欠落している）、エラーとして扱い、適切なメッセージを表示する。

## 4. データモデル (案)
請求情報を管理するためのデータ構造案。`data/invoices.json`のようなファイルで管理することを想定。

```json
[
  {
    "invoiceId": "inv-202507-001",
    "accountId": "acc-12345",
    "issueDate": "2025-07-31",
    "dueDate": "2025-08-31",
    "totalAmount": 55000,
    "tax": 5000,
    "status": "unpaid",
    "items": [
      {
        "itemName": "月額基本サービス料 (2025年7月分)",
        "amount": 30000
      },
      {
        "itemName": "アンケート「A展示会来場者アンケート」利用料",
        "amount": 20000
      }
    ]
  }
]
```

## 5. デザイン仕様

- **基本方針**: 既存のデザインガイドライン(`docs/design/00_design_guideline.md`)に準拠し、アプリケーション全体で一貫性のあるUIを提供する。
- **コンポーネント**: `card`, `table`, `button`など、既存のCSS(`service-top-style.css`)で定義されたスタイルを再利用する。
- **レスポンシブ**: モバイル端末でも見やすいように、テーブルはレスポンシブ対応とする。

### 5.1. 請求書一覧画面 (`invoiceList.html`)
- **レイアウト**: メインコンテンツエリアに`card`を配置し、その中にテーブルを設置する。
- **詳細ボタン**: `btn-outline-primary` スタイルを適用し、主要なアクションではないことを示す。

### 5.2. 請求書詳細画面 (`invoice-detail.html`)
- **アクションボタン**:
    - `印刷`: `<button class="btn btn-outline-secondary"><i class="bi bi-printer"></i> 印刷</button>`
    - `PDFダウンロード`: `<button class="btn btn-primary"><i class="bi bi-download"></i> PDFダウンロード</button>` (プライマリアクション)
- **明細テーブル**: `table-bordered` を使用して情報を明確に区切り、合計金額は `fw-bold` で強調する。

## 6. 非機能要件

### 6.1. パフォーマンス
- **データ取得**: 大量の請求データが存在する場合でも、画面表示が遅延しないように考慮する。必要に応じて、ページネーション、無限スクロール、または年/月ごとのフィルタリング機能の導入を検討する。
- **ローディング表示**: データ取得中はユーザーにローディング中であることを示すUI（スピナーなど）を表示し、UXを損なわないようにする。

### 6.2. セキュリティ
- **アクセス制御**: ユーザーは自身の請求履歴のみを閲覧できるものとする。他のユーザーの請求履歴への不正なアクセスは厳しく制限する。
- **データ検証**: URLパラメータ（例: `invoiceId`）は、サーバーサイドおよびクライアントサイドで適切に検証し、不正な値や悪意のある入力に対して堅牢であること。

### 6.3. エラーハンドリング
- **データ取得失敗**: 請求書データの取得に失敗した場合（例: ネットワークエラー、APIエラー）、ユーザーに分かりやすいエラーメッセージを表示する。可能であれば、再試行オプションを提供する。
- **データなし**: 該当する請求書データが存在しない場合、その旨をユーザーに明確に伝えるメッセージを表示する。

#### 6.3.1. 請求書詳細画面のエラーハンドリング
- **無効な請求書ID**: URLに無効な`invoiceId`が指定された場合、エラーメッセージを表示するか、請求書一覧画面へリダイレクトする。
- **データ不整合**: 取得した請求書データが仕様と異なる場合（例: 必須項目が欠落している）、エラーとして扱い、適切なメッセージを表示する。

## 7. 主要シーケンス
### 請求書発行・通知フロー
1.  **[システム]** 毎月月末の夜間にバッチ処理を実行する。
2.  **[システム]** 各アカウントの当月利用状況を集計し、請求データを作成する。
3.  **[システム]** 作成した請求データを`invoices.json`に保存する。
4.  **[システム]** ユーザーの登録メールアドレス宛に、請求書詳細画面へのユニークなURLを記載した通知メールを送信する。
5.  **[ユーザー]** メール内のURLをクリックする。
6.  **[ブラウザ]** 請求書詳細画面(`invoice-detail.html`)を表示する。