# 請求書確認機能 仕様書

## 1. 概要
ユーザーが自身のサービス利用状況とそれに対応する請求内容をオンラインで確認できるようにするための機能。
請求書の発行から通知までを自動化し、管理コストを削減することを目的とする。

## 2. 主な機能
- **請求書一覧表示機能**: 過去の請求書を一覧で確認できる。
- **請求書詳細表示機能**: 各月の請求明細を確認できる。
- **請求書発行とメール通知機能**: 月末に請求書を自動発行し、ユーザーにメールで通知する。

## 3. 請求金額計算ロジック

請求金額は、以下のルールに基づいて算出される。

### 3.1. 料金テーブル

| 項目 | プラン / 内容 | 料金（税抜） | 単位 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **基本料金** | Standard | ¥10,000 | 月額 | | 
| | Premium | ¥30,000 | 月額 | |
| **従量課金** | 名刺データ化 | ¥50 | 枚 | `bizcardEnabled: true` のアンケートが対象 |

### 3.2. 計算式

- **請求対象**: 請求月の1日から末日までに「終了後」ステータスになったアンケート、および当月の月額基本料金。
- **名刺データ化料金**: `SUM(各アンケートの bizcardRequest) * 50円`
- **小計（税抜）**: `(月額基本料金) + (名刺データ化料金)`
- **消費税**: `小計（税抜） * 0.1` （小数点以下切り捨て）
- **合計請求額**: `小計（税抜） + 消費税`

## 4. 画面仕様

...(既存の画面仕様は変更なし。ここでは省略)...

## 5. データモデル (案)

請求情報を管理するためのデータ構造案。この構造は「3. 請求金額計算ロジック」に基づいて生成される。

```json
[
  {
    "invoiceId": "inv-202507-001",
    "accountId": "acc-12345",
    "issueDate": "2025-07-31",
    "dueDate": "2025-08-31",
    "subtotal": 50000, // 税抜小計
    "tax": 5000,
    "totalAmount": 55000, // 税込合計
    "status": "unpaid",
    "items": [
      {
        "itemName": "月額基本サービス料 (Premiumプラン)",
        "quantity": 1,
        "unitPrice": 30000,
        "amount": 30000,
        "isTaxable": true
      },
      {
        "itemName": "名刺データ化費用 (アンケート「A展示会」)",
        "quantity": 200,
        "unitPrice": 50,
        "amount": 10000,
        "isTaxable": true
      },
      {
        "itemName": "名刺データ化費用 (アンケート「Bセミナー」)",
        "quantity": 200,
        "unitPrice": 50,
        "amount": 10000,
        "isTaxable": true
      }
    ]
  }
]
```

## 6. デザイン仕様

...(既存のデザイン仕様は変更なし。ここでは省略)...

## 7. 非機能要件

...(既存の非機能要件は変更なし。ここでは省略)...

## 8. 主要シーケンス

### 請求書発行・通知フロー

1.  **[システム]** 毎月月末の夜間にバッチ処理を実行する。
2.  **[システム]** 各アカウントの当月利用状況（終了したアンケート、プラン情報）を集計する。
3.  **[システム]** 「3. 請求金額計算ロジック」に基づき請求データを生成する。
4.  **[システム]** 生成した請求データを`invoices.json`に保存する。
5.  **[システム]** ユーザーの登録メールアドレス宛に、請求書詳細画面へのユニークなURLを記載した通知メールを送信する。
6.  **[ユーザー]** メール内のURLをクリックする。
7.  **[ブラウザ]** 請求書詳細画面(`invoice-detail.html`)を表示する。
