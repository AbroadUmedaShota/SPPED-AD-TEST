# 07_グラフ化ページ機能要件定義書

## 1. 概要

このページでは、SPEEDレビューページから遷移し、シングルアンサーおよびマルチアンサー形式のアンケート回答データを元にグラフを作成することで、アンケートの回答内容を視覚的に分析できます。ユーザーは、アンケートの回答データをグラフ形式で確認し、必要に応じてグラフの種類（棒グラフ、円グラフなど）を切り替えることで、回答傾向を直感的に把握することが可能です。

## 2. ページ遷移

- **起点:** `/speed-review.html`
- **操作:** 「グラフ化」ボタンをクリック
- **遷移方法:**
    - グラフ化ページへの遷移は、URLパラメータにアンケートID（`surveyId`）を付与して行う。
    - **遷移先URL:** `/graph-page.html` (仮)
    - 例: `/graph-page.html?surveyId=SURVEY_ID_XXXX`
    - 必要に応じて、追加のフィルタリング情報（例: 日付範囲）もURLパラメータまたはセッションストレージ経由で引き渡すことを検討する。**初期実装ではURLパラメータを優先し、複雑なフィルタリング条件はセッションストレージの利用を検討する。**

## 3. 主要機能

### 3.1. グラフ表示機能

- **対象アンケート項目:**
    - **シングルアンサー形式の質問:**
        - 選択肢ごとの回答数と割合をグラフで表示する。
        - 質問タイプが「ラジオボタン」「ドロップダウン」「単一選択チェックボックス」など、明確な選択肢を持つ形式を対象とする。
        - 質問メタデータ（例: `questionType: 'single_choice'`）に基づいて識別する。
    - **マルチアンサー形式の質問:**
        - 各選択肢が選択された回数（または回答者数に対する割合）をグラフで表示する。
        - 質問タイプが「複数選択チェックボックス」など、複数の選択肢を許容する形式を対象とする。
        - 質問メタデータ（例: `questionType: 'multi_choice'`）に基づいて識別する。
- **非対象アンケート項目:**
    - **マトリクス形式の質問:** 複雑なデータ構造のため、初期リリースではグラフ化の対象外とする。
    - **手書きスペース形式の質問:** 自由記述のため、グラフ化の対象外とする。
    - **フリー入力形式の質問:** 自由記述のため、グラフ化の対象外とする。
    - **（原則としてグラフ化しないが、将来的な拡張の可能性は考慮する）:** これらの質問タイプに対しては、グラフの代わりにテキストリストやワードクラウドなどの代替表示方法を検討する。
- **表示形式:**
    - **棒グラフ:** 各カテゴリの回答数や割合を比較するのに適している。
    - **円グラフ:** 全体に対する各カテゴリの割合を示すのに適している。
- **切り替え機能:**
    - 棒グラフと円グラフは、ページ上部に配置されるボタン（例: 「棒グラフ」「円グラフ」）操作により、動的に切り替え可能とする。
    - 切り替え時、グラフデータは再取得せず、表示形式のみを切り替える。
- **ソート機能:**
    - 各グラフにおいて、回答数（または割合）に基づいて昇順・降順でデータを並べ替える機能を提供する。
    - ソートの切り替えは、グラフの軸ラベルのクリック、または別途ソートボタンを設けることで行う。
    - **補足:** ユーザーの要望により、キーワードによるフィルタリングよりも、この回答数（または割合）による並べ替え機能を重視する。
- **データ表示:**
    - グラフと同時に、回答数や割合などの回答内容を文字ベースで表示する。
    - 例: 「選択肢A: 100件 (30%)」
    - **補足:** 現状は文字ベースでの表示を想定しているが、将来的に表示形式が変更される可能性も考慮する。
    - 回答がない場合や、グラフ化できないデータの場合には、「データがありません」などの適切なメッセージを表示する。
    - 全ての回答が同じ選択肢に集中している場合など、グラフが意味をなさないエッジケースも考慮し、必要に応じて警告メッセージを表示する。

### 3.2. データ取得

- **データソース:** SPEEDレビューページで選択されたアンケートの回答データ（`survey-answers.json`、`business-cards.json`）を基にする。
- **データ連携:**
    - グラフ化ページは、URLパラメータから `surveyId` を取得し、そのIDに対応するアンケート回答データをバックエンドサービス（またはローカルのデータファイル）から取得する。
    - **質問メタデータの取得:** グラフ化対象の質問タイプ（シングルアンサー、マルチアンサー）を識別するため、アンケート定義データ（例: `surveys.json` または関連API）から質問ごとのタイプ情報を取得する。
    - **補足:** グラフページ内でのフィルタリング機能は別途実装し、SPEEDレビューページからのフィルタリング条件は引き継がない。
- **データ処理・集計:**
    - 取得した生データは、グラフ表示に適した形式に集計・整形する。
    - シングルアンサーの場合: 各選択肢の出現回数をカウント。
    - マルチアンサーの場合: 各選択肢が選択された総回数をカウント。
    - 欠損値や無効なデータは適切に処理（例: 除外、"不明"としてカウント）。

### 3.3. フィルタリング機能 (新規追加)

- グラフページ内で、表示するデータを絞り込むためのフィルタリング機能を提供する。
- **対象フィルター:**
    - 日付範囲フィルター
- フィルタリング条件は、グラフページ内でユーザーが設定し、SPEEDレビューページからの条件は引き継がない。
- **補足:** キーワードによるフィルタリング機能は提供せず、回答数（または割合）による並べ替え機能を重視する。

## 4. ユーザーインターフェース (UI) 要件

- **ページレイアウト:**
    - ヘッダー、サイドバー、フッターは既存の共通コンポーネントを再利用する。
    - メインコンテンツエリアにグラフ表示領域とコントロール（グラフ形式切り替えボタンなど）を配置する。
- **グラフ表示エリア:**
    - 各質問に対するグラフは、独立したセクションとして表示する。
    - 複数の質問がある場合、**初期リリースでは各質問のグラフを縦に並べて表示し、スクロールで閲覧できるようにする。** 各質問セクションは明確な区切り（例: 質問タイトル、ボーダー）を持ち、必要に応じてページ内リンクによるナビゲーションも検討する。
- **グラフ形式切り替えボタン:**
    - 「棒グラフ」「円グラフ」の2つのボタンを配置し、現在選択されているグラフ形式が視覚的にわかるようにする（例: 背景色、テキスト色の変更）。
    - ボタンは直感的で分かりやすいアイコンまたはテキストを使用する。
- **文字ベースのデータ表示エリア:**
    - グラフの視認性を損なわない位置に、集計結果の数値データ（回答数、割合）を表示する。
    - **表示形式:** 各選択肢の回答数と割合をリスト形式またはシンプルなテーブル形式で表示する。
    - フォントサイズや色を調整し、グラフと一体感のあるデザインにする。
- **ローディング表示:** データ取得中やグラフ描画中にローディングインジケーターを表示し、ユーザーに待機を促す。
- **エラー表示:**
    - データ取得失敗時（ネットワークエラー、不正なアンケートIDなど）には、ユーザーフレンドリーなエラーメッセージ（例: 「データの読み込みに失敗しました。時間をおいて再度お試しください。」）を表示し、必要に応じて再試行ボタンを提供する。
    - グラフ描画エラー時（データ形式の不整合など）には、エラーメッセージと技術的な詳細（開発者向け）を表示する。

## 5. 非機能要件

- **パフォーマンス:**
    - 大量の回答データ（例: 数千件以上）でも、グラフ描画が数秒以内に完了すること。
    - データ集計処理はクライアントサイドで行うか、必要に応じてサーバーサイドでの集計を検討する。
    - **グラフライブラリ:** 描画速度、メモリ使用量、カスタマイズ性、バンドルサイズを考慮して選定する。初期検討候補としてChart.jsやD3.jsを挙げるが、最終選定は実装フェーズで行う。
- **レスポンシブデザイン:**
    - デスクトップ、タブレット、スマートフォンなど、様々な画面サイズでグラフが適切に表示され、操作可能であること。
    - グラフのサイズは画面サイズに合わせて動的に調整されること。
    - 必要に応じて、モバイル表示では一部の情報を省略したり、表示形式を最適化したりする。
- **セキュリティ:**
    - アンケート回答データへのアクセスは、認証・認可されたユーザーのみに限定する。
    - **アクセス制御:** グラフページへのアクセスは、ログイン済みのユーザーに限定し、表示するアンケートデータはユーザーがアクセス権を持つもののみとする。
    - URLパラメータやセッションストレージ経由で渡されるデータは、改ざん防止策を講じる。
- **アクセシビリティ:**
    - グラフは、色覚多様性を持つユーザーにも情報が伝わるよう、色の選定に配慮する（例: パターンやテクスチャの利用、コントラスト比の確保）。
    - スクリーンリーダー利用者向けに、グラフの代替テキストやデータテーブルを提供する。
- **保守性:**
    - コードはモジュール化され、将来的な機能追加や変更が容易であること。
    - グラフライブラリのバージョンアップや、アンケート質問形式の追加に対応できる設計とする。
- **国際化 (i18n):**
    - グラフのタイトル、軸ラベル、凡例、ボタンテキストなど、ユーザーインターフェースに表示される全てのテキストは、将来的な多言語対応を考慮し、外部化されたリソースファイルから読み込む設計とする。

## 6. 今後の検討事項

- グラフ化対象外の質問形式に対する代替表示方法の検討（例: フリー入力に対するワードクラウド、マトリクスに対するヒートマップ）。
- グラフのインタラクティブ性（例: ツールチップ表示、特定のデータポイントのドリルダウン機能、期間選択による動的なグラフ更新）。
- グラフデータの画像（PNG, SVGなど）のダウンロード機能の実装。
- 複数のアンケートを横断した比較グラフの表示。
- グラフ表示設定の保存機能（例: デフォルトのグラフ形式、表示する質問の選択）。
- **テスト要件:**
    - **単体テスト:** データ集計ロジック、グラフ描画コンポーネントの単体テストを実施する。
    - **結合テスト:** データ取得からグラフ表示までの一連の流れをテストする。
    - **UIテスト:** グラフ形式の切り替え、レスポンシブ表示、エラー表示などのUI動作を確認する。
