
# 管理者画面 要件・設計サマリ (v0.1)

- 作成日: 2025-09-24
- 対象システム: SPEED AD 管理者ポータル
- 参照元: 03_admin 配下モック & `docs/resources/client-materials/reference-docs/【00.要件定義書】2025-05-21※Backlog転記済.txt` 等

## 1. 背景と目的
- リード管理プロセス全体を管理者が統制できることを目的に、ユーザー側UIとは独立した管理者向けモックと要件を整理する。
- 本書は既存モックの構造と要件定義書の「管理者向け機能 (3.3)」「横断要件 (3.5)」を抽出し、画面・機能・データ・運用観点を俯瞰できるようにする。
- ここで定義した内容を起点に、詳細仕様・実装タスク・バックエンドAPI設計に展開する。

## 2. 管理者ロールと権限レベル
| ロール | 想定利用者 | 主な権限/アクセス範囲 |
| --- | --- | --- |
| マネージャー | アブロード社 管理責任者 | 全メニューアクセス、請求・クーポン・営業日設定の更新権限。
| スタッフ | アブロード社 運用担当 | ユーザー/アンケート/請求管理の閲覧・更新、カレンダー/クーポンは閲覧中心。
| オペレーター管理者 | BPOチームリード | データ入力・照合・オペレーター管理・実績管理へのフルアクセス。請求関連は閲覧のみ。
| オペレーター | 名刺データ入力担当 | データ入力・照合メニューのみ（一覧→対象選択→入力/照合画面）。

> サイドバー (`03_admin/common/sidebar.html`) は上記ロールに合わせてメニュー表示制御を行う想定。権限別のルーティング/機能制限を後続設計で詰める。

## 3. 管理者画面の構造
- 共通レイアウト: ヘッダー/サイドバー/フッターを動的読込 (`admin.js#loadCommonHtml`)。Tailwind + カスタムCSS (`src/admin-style.css`) + Material Icons を基盤とする。
- 主要画面とモックソース:

| 画面カテゴリ | モックID/ファイル | 想定URL | 主目的 | 主な要素 |
| --- | --- | --- | --- | --- |
| ダッシュボード | `index.html` | `/admin/index.html` | 管理者導線の入口 | ウェルカムメッセージのみ。カード/統計は未実装。 |
| ユーザー管理 | (未実装モック) | `/admin/user-management.html` | ユーザー検索・編集 | リスト + 詳細ドロワー想定。 |
| アンケート管理 | (未実装モック) | `/admin/survey-management.html` | アンケート一覧/詳細操作 | ステータス変更・CSV取込など。 |
| 請求管理 | (未実装モック) | `/admin/billing-management.html` | 依頼別/請求書別の管理 | `docs/specifications/04_invoice_screen.md` 連携。
| クーポン管理 | (未実装モック) | `/admin/coupon-management.html` | 割引コード発行・配布状況 | 自動コード生成UIが必要。 |
| 営業日カレンダー | (未実装モック) | `/admin/calendar-management.html` | 休業日の設定 | カレンダー + 追加/削除操作。 |
| データ入力管理 - 一覧 | `BY-211_オペレーター入力画面/BY-212/BY-212.html` | `/admin/data-entry-management.html` | 入力対象の割当・遷移 | 優先度別リスト、詳細へのリンク。 |
| データ入力管理 - 入力画面 | `BY-211_オペレーター入力画面/BY-213/BY-213.html` | `/admin/data-entry/form.html` | 名刺情報の手入力 | 左:名刺画像/回転、右:入力フォーム、下部操作群。 |
| 照合管理 - 一覧 | `BY-221_照合画面/BY-222/BY-222.html` | `/admin/reconciliation/list.html` | 照合ステータス確認 | KPIカード + テーブル。
| 照合管理 - 詳細 | `BY-221_照合画面/BY-223/BY-223.html` | `/admin/reconciliation/detail.html` | 入力データとOCRの突合 | 画像ビューア + 項目比較テーブル + 操作ボタン。
| オペレーター管理 | `BY-231_オペレーター管理/BY-231/BY-231.html` | `/admin/operator-management.html` | アカウント一覧/招待 | モーダルで新規作成、ステータス表示。
| 実績管理 | (未実装モック) | `/admin/performance-management.html` | 入力実績の集計可視化 | 時系列/項目別グラフ想定。

## 4. 機能要件詳細
以下は要件定義書 3.3節からの抜粋/整理。**【冪等性制御適用対象】**は 3.5.1 の仕組みに従う。

### 4.1 アカウント管理
- 管理者ログイン/ログアウト。
- 権限別ナビゲーション制御。ロール切替は後続で実装方針を決定。
- 監査: ログイン/ログアウト、権限変更の記録が必要。

### 4.2 ユーザー管理
- 一覧: ページネーション付きテーブル。フィルタ（ID、氏名、会社名、状態）。
- 詳細モーダル/画面: 基本情報、契約プラン、関連アンケートを閲覧・編集。
- 操作: 
  - アカウント停止/再開。
  - 管理フラグ・内部メモ登録。
- 監査/冪等性: 各更新APIで Idempotency-Key を付与。再試行時も同一キーを利用。

### 4.3 アンケート管理
- 一覧: アンケートID/名称/会社/会期/ステータス/プラン/担当者。
- 検索: キーワード + ステータス + 期間フィルタ。
- 詳細: ユーザー代行での設定変更（フォーム構成、公開設定、プラン変更）。
- 操作: 手動ステータス変更、削除、名刺画像ダウンロード、データ化完了CSVアップロード。
- 注意: CSV取り込み時は結果フィードバックUIを設ける。

### 4.4 請求管理
- アンケート単位と請求書単位の2軸ビュー。
- 詳細: 金額・請求日・入金日を手動調整。【冪等性】対象。
- 出力: 請求書プレビュー/ダウンロード (PDF) は `docs/specifications/04_invoice_screen.md`/`05_invoice_document.md` を準拠。
- 未決事項: 自動発行バッチとの連係/ステータス遷移ルール。

### 4.5 クーポン管理
- 一覧 + 検索（コード/名称/状態/利用回数）。
- 新規作成: コード自動生成、割引率、有効期限、利用回数制限、対象プラン設定。
- 編集: 条件変更、利用停止。履歴表示検討。
- 利用ログ: 一覧で利用日時/対象アンケート/適用金額を表示。

### 4.6 営業日カレンダー管理
- カレンダービュー（祝日API連携 or マスタ）
- 土日祝以外の休業日追加/削除。
- 補足: 休日設定はデータ入力SLA計算に影響。変更差分をログ化。

### 4.7 データ入力・照合管理
- **入力一覧**: 
  - グループ/優先度別の残タスク表示。
  - ロック制御: メール未入力時のグループ遷移禁止など内部ロジックあり。
- **入力画面 (BY-213)**:
  - 左パネル: 名刺画像(表/裏)、回転ボタン、スワップ。
  - 右パネル: 項目フォーム（必須/任意、バリデーション表示）、ステータスラベル。
  - 下部: 保存、スキップ（理由必須）、完了、次へ。経過時間表示。
  - 内部処理: 占有ロック、OCR結果との自動比較、3回スキップでエスカレーション、3回完了で入力不可。
  - メモ: OCR結果表示は検討中（2025/05/02 時点）。
- **照合一覧 (BY-222)**:
  - KPIカード: 総件数/一致/不一致/未入力/エスカレーション。
  - テーブル: アンケート、優先度、更新日時、担当者等。フィルタ機構想定。
- **照合画面 (BY-223)**:
  - 上部: 基本情報 + 保存/エスカレーション/キャンセルボタン。
  - 左: 名刺画像ビューア（拡大/回転/裏面切替、ホバーズーム領域）。
  - 右: 項目比較テーブル（項目名、OCR、入力1/2/3、最終確定値、選択UI）。
  - 下: コメント/履歴、次へボタン。
  - 内部処理: 確定結果を `input_business_cards.corrected_data` へ保存、CSVダウンロード用データに反映、オペレーター精度実績ログ記録。

### 4.8 オペレーター管理
- 一覧: 名前、メール、所属グループ、稼働状況、直近の処理件数。
- 招待: モーダルでメール入力 → アカウント発行 & 初期パスワード通知。
- 編集: 権限変更（例: 入力専任/照合兼任）、稼働ステータス変更。
- 削除: 論理削除 + 既存タスク再割当が必要。

### 4.9 実績管理
- 集計指標: グループ別処理件数/正答率、オペレーター別件数・エラー数、期間比較。
- ビジュアル: 折れ線/棒グラフ + ダウンロード（CSV, PDF）。
- ドリルダウン: オペレーター→対象アンケート→入力履歴。

## 5. データおよびAPI前提
- 主要テーブル (要件定義書6章より):
  - `Input_business_cards`: 名刺入力データ (OCR結果, 入力値1〜3, フラグ類, 担当オペレーターID)。
  - `Users` / `Corporate`: 顧客ユーザー・企業マスタ。
  - `AdminUser`, `AdminUserGroup`: 管理者アカウントと権限グループ。
  - `Coupon`, `RewardHistory`, カレンダー管理テーブル 等。
- 冪等性制御 (3.5.1):
  - `POST /api/idempotency-key` でキー発行 → 更新系APIの `Idempotency-Key` ヘッダーに付与。
  - Redis でキーとレスポンスをキャッシュ、ユーザーID/操作種別/タイムスタンプを監査ログ化。
  - フロントはフォーム送信毎に単一キーを払い出し、リトライ時も同一キーを使用。
- ロック/競合対策: データ入力画面の占有ロックは時間制限付き。照合画面も同様の排他制御が必要。
- 監査ログ: クリティカル操作（権限変更、請求編集、エスカレーション等）は操作履歴に記録。

## 6. UI設計メモ
- 共通部品: `common/header.html` (通知/ユーザー情報), `common/sidebar.html` (メニュー + ログアウト + テーマ切替), `common/footer.html` (コピーライト)。
- スタイル: Tailwindベースに `src/admin-style.css` を追加し、ダーク系配色。Material Icons を主要アイコンに採用。
- レスポンシブ: サイドバーはモバイルでオーバーレイ化 (`mobileSidebarOverlay`)。主要画面は最大幅 `max-w-6xl`。
- データ入力 (BY-213):
  - 左パネル 40%、右パネル 60% レイアウト。画像拡大用ライトボックスあり。
  - 入力フォームはカテゴリごとにアコーディオン化。必須項目はラベル横に `必須` バッジ。
  - 操作ボタン: `保存`, `スキップ`, `完了`, `次の名刺へ`。
- 照合 (BY-223):
  - 画像ビューアはドラッグで拡大移動。上部に表裏切替タブ。
  - 項目比較テーブルは列固定 + 水平スクロール。確定値はドロップダウン or ラジオ。
  - `エスカレ` ボタン押下時は理由入力モーダルを出す想定。
- オペレーター管理 (BY-231):
  - 上部KPIカード（稼働中人数、当日日報等）。
  - テーブル列: 氏名/メール/権限/現在のタスク/直近完了件数。
  - `新規招待` ボタン→モーダル (メール, 権限, 初期パスワード)。

## 7. 未決事項・検討タスク
1. OCR結果の入力画面表示可否 (要件定義書注記: 2025/05/02 時点検討中)。
2. エスカレーション処理フロー（誰に通知し、どの画面で解決するか）。
3. CSVアップロード/ダウンロードのフォーマット詳細とバリデーション方針。
4. ロール別メニュー制御・ルーティングの仕様書化。
5. ダッシュボード指標の定義 (成約率、処理件数、 SLA 等)。
6. 監査ログ/操作履歴のUI (閲覧/検索) を設けるか。
7. 請求管理画面と自動バッチの連携（ステータス同期、メール通知タイミング）。
8. オペレーター削除時のタスク再割当ロジック。
9. 実績管理画面のグラフライブラリ選定と API フォーマット。

## 8. 参照資料
- `03_admin/admin_requirements.md` (管理者機能要件リスト)
- `03_admin/index.html`, `src/admin.js`, `common/*.html`
- `03_admin/BY-211_オペレーター入力画面/BY-213/BY-213.html`
- `03_admin/BY-221_照合画面/BY-223/BY-223.html`
- `03_admin/BY-231_オペレーター管理/BY-231/BY-231.html`
- `docs/specifications/04_invoice_screen.md`, `05_invoice_document.md`
- `docs/resources/client-materials/reference-docs/【00.要件定義書】2025-05-21※Backlog転記済.txt`

