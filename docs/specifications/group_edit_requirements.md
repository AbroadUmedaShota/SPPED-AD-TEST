# グループ編集画面 要件定義書

## 1. 概要

本ドキュメントは、「グループ編集」画面の機能要件と仕様を定義する。
この画面は、ユーザーが所属する組織内のグループを作成・編集し、グループメンバーや請求先情報などを管理することを目的とする。

---

## 2. 画面レイアウト

画面は、アプリケーション共通のヘッダーおよびサイドバーと、メインコンテンツエリアで構成される。

メインコンテンツエリアは、以下の主要セクションが**アコーディオン形式**で構成される。各アコーディオンは、デフォルト（初期表示時）では開いた状態である。

1.  **画面ヘッダーエリア**: パンくずリスト、画面タイトル、および編集対象のグループを切り替えるための「グループ選択プルダウン」を配置する。
2.  **グループ情報セクション**: 選択されたグループの基本情報（グループ名、説明文）を表示・編集する。
3.  **請求先情報セクション**: グループの請求書送付先情報を管理する。
4.  **メンバー管理セクション**: グループに所属するメンバーの招待、一覧表示、並び替え、役割変更、削除を行う。
5.  **フッターアクションエリア**: 「キャンセル」および「保存」ボタンを配置する。

---

## 3. 機能要件

### 3.1. グループ選択機能

-   **目的**: 複数のグループを管理しているユーザーが、編集対象のグループを容易に切り替えられるようにする。
-   **トリガー**: 画面右上の「編集するグループを選択」プルダウンを操作する。
-   **仕様**:
    -   ユーザーが所属または管理するすべてのグループがプルダウンの選択肢として表示される。
    -   画面読み込み時、URLに `groupId` クエリパラメータが指定されている場合は、該当するグループが選択された状態で表示される。パラメータが存在しない場合は、リストの先頭のグループがデフォルトで選択される。
    -   プルダウンで異なるグループを選択すると、画面全体の表示内容（グループ情報、請求先情報、メンバー一覧）が、選択されたグループのデータに即座に更新される。
    -   **（詳細仕様）**: 未保存の変更がある状態でグループを切り替えようとすると、「編集中の内容があります。変更を保存せずにグループを切り替えますか？」という確認モーダルを表示し、意図しない変更の喪失を防ぐ。

### 3.2. グループ情報編集機能

-   **目的**: グループの基本的な識別情報を設定・変更する。
-   **UI**: 「グループ情報」アコーディオンパネル。
-   **仕様**:
    -   **グループ名**: テキスト入力フィールド。グループの名称を編集できる。
    -   **説明文**: テキストエリア。グループの目的や補足情報などを自由記述で編集できる。
-   **バリデーション（入力値検証）**:
    -   **グループ名**: 空であってはならない。空の状態で保存しようとすると、入力フィールドの下にエラーメッセージを表示し、保存処理は実行されない。

### 3.3. 請求先情報管理機能

-   **目的**: グループに関連する請求書送付先を、アカウントのデフォルト設定またはグループ固有設定から選択・管理する。誤操作による誤った請求先情報の設定を防ぎつつ、柔軟な設定を可能にする。
-   **UI**: 「請求先情報」アコーディオンパネル。
-   **仕様**:
    -   セクション上部のトグルスイッチにより、以下の2つのモードを切り替える。
        1.  **グループ作成者の情報を利用**: アカウントに登録されているデフォルトの請求先情報を使用するモード。
        2.  **グループ専用の請求先を設定**: このグループのためだけに、個別の請求先情報を設定するモード。
    -   **「グループ作成者の情報を利用」モード選択時**:
        -   アカウントに紐づく請求先情報（氏名、部署名、電話番号、郵便番号、住所）が読み取り専用で表示される。ユーザーによる編集は不可。
    -   **「グループ専用の請求先を設定」モード選択時**:
        -   **初期表示**: グループに設定されている請求先情報が、読み取り専用の確定情報として表示される。
        -   **編集フロー**:
            1.  表示エリアの右下に「編集」ボタンが配置される。
            2.  「編集」ボタンをクリックすると、各情報が入力フォームに切り替わり、編集可能な状態になる。
            3.  フォーム内の「保存」ボタンをクリックすると変更が確定し、表示が読み取り専用モードに戻る。
            4.  フォーム内の「キャンセル」ボタンをクリックすると、変更内容が破棄され、読み取り専用モードに戻る。変更があった場合は、破棄する前に確認モーダルが表示される。

### 3.4. メンバー管理機能

-   **目的**: グループに所属するメンバーの構成と権限を管理する。
-   **UI**: 「メンバー管理」アコーディオンパネル。

#### 3.4.1. ヘッダーと説明
-   **仕様**:
    -   セクションヘッダーの「メンバー管理」というタイトルの横に、「？」アイコンを配置する。
    -   このアイコンにマウスカーソルを合わせると、「メンバーの招待や権限の管理を行います。ドラッグ&ドロップで表示順を変更できますが、これは管理上の表示順であり、権限の序列を示すものではありません。」という説明がツールチップで表示される。

#### 3.4.2. メンバー一覧表示と並び替え

-   **一覧表示**:
    -   現在選択されているグループに所属する全メンバーが、カード形式で一覧表示される。
    -   各メンバーカードには、アバター画像、氏名、メールアドレス、役割（プルダウン）、ステータス（バッジ）が表示される。
-   **手動での並べ替え**:
    -   カードの左端にあるドラッグハンドルを操作することで、リスト内のメンバーの表示順を直感的に並べ替えることができる。
    -   手動で並べ替えた場合、現在適用されている自動並び替え（後述）は解除される。
-   **自動での並び替え（ソート）**:
    -   **UI**: メンバー一覧の上部に、アイコン形式の並び替えボタン（「権限」「ステータス」）と、リセットボタンを配置する。
    -   **基本動作**: 
        - 並び替えボタンを初めてクリックすると、定義された順序で**昇順**に並び替わる。
        - 同じボタンを再度クリックすると、**降順**に切り替わる。
        - 現在アクティブな並び替えボタンの横には、順序を示すインジケーター（▲/▼）が表示される。
    -   **権限順**: 「管理者」が「一般」より上に来るように並び替える。
    -   **ステータス順**: 「グループ加入済」→「グループ招待中」→「アドレスエラー」の優先順位で並び替える。
    -   **リセット**: 並び順を初期状態に戻し、インジケーターを非表示にする。

#### 3.4.3. メンバー詳細情報の表示
-   **トリガー**: メンバーカードの非操作領域をクリックする。
-   **動作**: そのユーザーのアカウント情報を読み取り専用で表示する「メンバー詳細モーダル」が開く。

#### 3.4.4. メンバー招待

-   **仕様**:
    -   「新しいメンバーを招待」エリアのフォームから、新規メンバーをグループに招待できる。
    -   招待するユーザーの「メールアドレス」を入力し、「権限」（一般メンバー/管理者）を選択して「招待する」ボタンをクリックする。
    -   招待が実行されると、メンバー一覧に新しいメンバーが「グループ招待中」のステータスで追加される。
-   **バリデーション**:
    -   メールアドレスは、有効な形式であり、かつグループ内に重複がないことを検証する。

#### 3.4.5. メンバー情報編集

-   **仕様**:
    -   メンバーカード内の「役割」プルダウンを操作することで、当該メンバーの権限を「管理者」と「一般メンバー」の間でリアルタイムに変更できる。

#### 3.4.6. メンバー削除

-   **仕様**:
    -   メンバーカードの右端にあるゴミ箱アイコン（削除ボタン）をクリックする。
    -   確認モーダルが表示され、ユーザーが承認すると、当該メンバーはグループから削除される。

---

## 4. モーダルダイアログ

### 4.1. 確認モーダル (Confirmation Modal)
-   **目的**: ユーザーの意図しないデータ損失や破壊的な操作を防ぐため、実行前に最終確認を求める。
-   **表示タイミング**:
    1.  未保存の変更がある状態で、ページ離脱やグループ切り替えを行おうとした時。
    2.  メンバーを削除するボタンをクリックした時。
    3.  グループ専用請求先情報の編集中に、変更を保存せずキャンセルしようとした時。
-   **表示内容**: 操作に応じた確認メッセージと、「承認」「キャンセル」に相当するボタンを表示する。

### 4.2. メンバー詳細モーダル (Member Detail Modal)
-   **目的**: メンバーの完全なプロフィール情報を、編集中の画面フローを妨げることなく参照できるようにする。
-   **トリガー**: メンバー一覧の各メンバーカードの非操作領域をクリックする。
-   **表示内容**:
    -   モーダル上部に、メンバーのアバター画像、氏名、メールアドレスがヘッダーとして表示される。
    -   その下に、会社名、部署名、役職、電話番号、住所、権限、ステータスなどの詳細情報が読み取り専用で表示される。

---

## 5. エラーハンドリング

-   **データ読み込み失敗**: 画面の初期化に必要なグループ情報の取得に失敗した場合、画面の主要機能を無効化し、「グループデータの読み込みに失敗しました。」というエラーメッセージを画面中央に表示する。
-   **保存失敗**: 「保存」ボタンをクリックして情報の更新処理に失敗した場合、「グループ情報の保存に失敗しました。」というトースト通知（画面下部に数秒間表示されるメッセージ）を表示する。保存に失敗しても、ユーザーが入力した内容はフォーム上に維持される。

---

## 6. 非機能要件（UI/UX要件）

-   **変更状態の追跡**:
    -   画面上のいずれかの情報（グループ名、説明、請求先設定、メンバー構成など）がユーザーによって変更されたかを常に追跡する（Dirty State管理）。
    -   この状態に基づき、「保存」ボタンの有効/無効状態が制御される。
-   **変更の保存**:
    -   画面下部に「キャンセル」ボタンと「保存」ボタンが常に表示される。
    -   画面情報に変更が加えられると、「保存」ボタンが自動的に有効化される。初期状態および変更がない状態では無効化されている。
-   **変更破棄の防止**:
    -   未保存の変更がある状態でユーザーが「キャンセル」ボタンをクリックするか、ブラウザを閉じる・別ページに移動するなどのページ離脱操作を行った場合、確認モーダルを表示し、意図しない変更の喪失を防ぐ。

---

## 7. データモデル（参考）

本画面で扱われるデータ構造の例を以下に示す。

### グループオブジェクト

```json
{
  "id": "group001",
  "name": "サンプルグループA",
  "description": "これはサンプルグループAの説明です。",
  "useGroupBilling": false,
  "billingInfo": {
    "contactName": "",
    "department": "",
    "phone": "",
    "postalCode": "",
    "address1": "",
    "address2": ""
  },
  "members": [
    {
      "email": "admin@example.com",
      "role": "admin",
      "name": "佐藤 管理者",
      "status": "グループ加入済",
      "avatarUrl": "https://i.pravatar.cc/40?u=admin@example.com"
    }
  ]
}
```

### グループ作成者 請求先情報オブジェクト

```json
{
  "contactName": "山田 太郎 (オーナー)",
  "department": "経理部",
  "phone": "03-1234-5678",
  "postalCode": "100-0001",
  "address1": "東京都千代田区千代田1-1",
  "address2": "皇居"
}
```