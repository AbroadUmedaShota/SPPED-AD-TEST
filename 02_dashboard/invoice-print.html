<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>請求書（印刷用） - SPEED AD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="service-top-style.css">
  <style>
    body {
      font-family: 'Noto Sans JP', 'メイリオ', 'Yu Gothic', sans-serif;
      background-color: #fff !important;
      margin: 0;
      padding: 20mm;
      font-size: 10pt;
      line-height: 1.5;
      box-sizing: border-box;
      -webkit-print-color-adjust: exact;
      color-adjust: exact;
    }

    .invoice-container {
      width: 170mm;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10mm;
    }

    .invoice-title {
      font-size: 24pt;
      font-weight: 700;
      margin: 0;
      padding-bottom: 5px;
      border-bottom: 3px double #000;
    }

    .invoice-header-info {
      text-align: right;
      font-size: 9pt;
    }

    .invoice-to {
      margin-bottom: 12mm;
    }

    .invoice-to p {
      margin: 0;
    }

    .invoice-to .company-name {
      font-size: 16pt;
      font-weight: 700;
    }

    .invoice-to .contact-name {
      font-size: 12pt;
      margin-top: 4px;
    }

    .invoice-summary {
      display: flex;
      justify-content: space-between;
      gap: 8mm;
      margin-bottom: 10mm;
    }

    .invoice-summary table {
      width: 50%;
      border-collapse: collapse;
      font-size: 9pt;
    }

    .invoice-summary th,
    .invoice-summary td {
      border: 1px solid #000;
      padding: 6px 8px;
      vertical-align: middle;
    }

    .invoice-summary th {
      background-color: #f2f2f2;
      width: 30%;
      white-space: nowrap;
    }

    .invoice-summary .total-row th,
    .invoice-summary .total-row td {
      background-color: #e0e0e0;
      font-weight: 600;
      font-size: 11pt;
    }

    .invoice-details {
      margin-top: 8mm;
    }

    .invoice-details h2 {
      font-size: 11pt;
      font-weight: 600;
      margin-bottom: 4mm;
      border-bottom: 1px solid #000;
      padding-bottom: 2mm;
    }

    .invoice-details table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9pt;
    }

    .invoice-details th,
    .invoice-details td {
      border: 1px solid #000;
      padding: 5px;
      vertical-align: middle;
    }

    .invoice-details th {
      background-color: #f2f2f2;
      text-align: center;
      white-space: nowrap;
    }

    .subtotal-row {
      background-color: #fafafa;
      font-weight: 600;
    }

    .notes-section {
      margin-top: 10mm;
      padding: 6mm 5mm;
      border: 1px solid #d1d1d1;
      background-color: #fafafa;
      font-size: 9pt;
    }

    @media print {
      body, html {
        margin: 0;
        padding: 0;
      }
      .invoice-container {
        width: 100%;
        margin: 0;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div id="invoice-content" class="invoice-container"></div>

  <script type="module">
    import { fetchInvoiceById } from './src/services/invoiceService.js';

    const CATEGORY_ORDER = ['BASE', 'ADD_ON', 'ONE_TIME', 'CREDIT'];
    const CATEGORY_LABELS = {
      BASE: '小計（基本料金）',
      ADD_ON: '小計（追加オプション）',
      ONE_TIME: '小計（一時費用）',
      CREDIT: '小計（調整額）'
    };
    const STATUS_LABELS = {
      unpaid: '未入金',
      paid: '入金済',
      overdue: '延滞',
      canceled: '取消'
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const invoiceId = urlParams.get('id');

      if (!invoiceId) {
        renderError('請求書IDが指定されていません。');
        return;
      }

      try {
        const invoice = await fetchInvoiceById(invoiceId);
        if (!invoice) {
          renderError('対象の請求書が見つかりませんでした。');
          return;
        }

        const container = document.getElementById('invoice-content');
        container.innerHTML = generateInvoiceHTML(invoice);
        setTimeout(() => window.print(), 300);
      } catch (error) {
        console.error('Error loading invoice for printing:', error);
        renderError('請求データの取得に失敗しました。');
      }
    });

    function renderError(message) {
      document.getElementById('invoice-content').innerHTML = `
        <div style="padding:24px; border: 1px solid #e2e2e2; background: #fff3cd; font-size: 12pt;">
          ${escapeHtml(message)}
        </div>
      `;
    }

    function generateInvoiceHTML(invoice) {
      const currency = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' });
      const issueDate = formatDate(invoice.issueDate);
      const planSummary = describePlan(invoice);
      const addOnSummary = describeAddOns(invoice?.addOns);
      const billingPeriod = formatBillingPeriod(invoice?.billingPeriod);
      const statusLabel = STATUS_LABELS[invoice.status] ?? '不明';
      const bankInfo = invoice.bankInfo ?? {};
      const notesHtml = invoice.notes ? escapeHtml(invoice.notes).replace(/\n/g, '<br>') : '';

      return `
        <div class="invoice-header">
          <div>
            <h1 class="invoice-title">請求書</h1>
            <div class="invoice-header-info" style="text-align:left;">
              <p>発行日: ${escapeHtml(issueDate)}</p>
              <p>請求書番号: ${escapeHtml(invoice.invoiceId)}</p>
            </div>
          </div>
          <div class="invoice-header-info">
            <p class="fw-bold">SPEED AD 株式会社</p>
            <p>東京都千代田区神田○○ 1-2-3</p>
            <p>TEL: 03-1234-5678</p>
            <p>登録番号: T9011701016647</p>
          </div>
        </div>

        <section class="invoice-to">
          <p class="company-name">${escapeHtml(invoice.corporateName ?? '-')} 御中</p>
          <p class="contact-name">${escapeHtml(invoice.contactPerson ?? '-')} 様</p>
        </section>

        <section class="invoice-summary">
          <table>
            <tbody>
              <tr>
                <th>請求対象期間</th>
                <td>${escapeHtml(billingPeriod)}</td>
              </tr>
              <tr>
                <th>契約プラン</th>
                <td>${escapeHtml(planSummary)}</td>
              </tr>
              <tr>
                <th>追加オプション</th>
                <td>${escapeHtml(addOnSummary)}</td>
              </tr>
              <tr>
                <th>ステータス</th>
                <td>${escapeHtml(statusLabel)}</td>
              </tr>
              <tr>
                <th>小計（課税）</th>
                <td>${formatAmount(invoice.subtotalTaxable, currency)}</td>
              </tr>
              <tr>
                <th>小計（非課税）</th>
                <td>${formatAmount(invoice.subtotalNonTaxable, currency)}</td>
              </tr>
              <tr>
                <th>消費税</th>
                <td>${formatAmount(invoice.tax, currency)}</td>
              </tr>
              <tr class="total-row">
                <th>合計（税込）</th>
                <td>${formatAmount(invoice.totalAmount, currency)}</td>
              </tr>
            </tbody>
          </table>
          <table>
            <tbody>
              <tr>
                <th>振込先銀行</th>
                <td>${escapeHtml(bankInfo.bankName ?? '-')}</td>
              </tr>
              <tr>
                <th>支店名</th>
                <td>${escapeHtml(bankInfo.branchName ?? '-')}</td>
              </tr>
              <tr>
                <th>口座種別</th>
                <td>${escapeHtml(bankInfo.accountType ?? '-')}</td>
              </tr>
              <tr>
                <th>口座番号</th>
                <td>${escapeHtml(bankInfo.accountNumber ?? '-')}</td>
              </tr>
              <tr>
                <th>口座名義</th>
                <td>${escapeHtml(bankInfo.accountHolder ?? '-')}</td>
              </tr>
              <tr>
                <th>支払期限</th>
                <td>${escapeHtml(formatDate(invoice.dueDate))}</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="invoice-details">
          <h2>請求明細</h2>
          <table>
            <thead>
              <tr>
                <th>No.</th>
                <th>項目</th>
                <th>内訳</th>
                <th>数量</th>
                <th>単価</th>
                <th>金額</th>
              </tr>
            </thead>
            <tbody>
              ${renderItemRows(invoice.items ?? [], currency)}
            </tbody>
          </table>
        </section>

        ${notesHtml ? `
          <section class="notes-section">
            <strong>備考</strong>
            <p style="margin-top: 4px;">${notesHtml}</p>
          </section>
        ` : ''}
      `;
    }

    function renderItemRows(items, currencyFormatter) {
      if (!Array.isArray(items) || items.length === 0) {
        return `
          <tr>
            <td colspan="6" style="text-align:center; padding:12px;">明細が登録されていません。</td>
          </tr>
        `;
      }

      const rows = [];
      let lineNumber = 1;

      CATEGORY_ORDER.forEach(category => {
        const categoryItems = items.filter(item => (item.category ?? '').toUpperCase() === category);
        if (categoryItems.length === 0) return;

        let subtotal = 0;
        categoryItems.forEach(item => {
          const quantityText = formatQuantity(item.quantity, item.unit);
          const unitPriceText = typeof item.unitPrice === 'number' ? currencyFormatter.format(item.unitPrice) : '';
          const amount = typeof item.amount === 'number' ? item.amount : 0;
          subtotal += amount;

          rows.push(`
            <tr>
              <td style="text-align:center;">${lineNumber++}</td>
              <td>${escapeHtml(item.itemName ?? '-')}</td>
              <td>${escapeHtml(item.description ?? '')}</td>
              <td style="text-align:right;">${escapeHtml(quantityText)}</td>
              <td style="text-align:right;">${escapeHtml(unitPriceText)}</td>
              <td style="text-align:right;">${currencyFormatter.format(amount)}</td>
            </tr>
          `);
        });

        rows.push(`
          <tr class="subtotal-row">
            <td></td>
            <td colspan="4" style="text-align:right;">${CATEGORY_LABELS[category] ?? '小計'}</td>
            <td style="text-align:right;">${currencyFormatter.format(subtotal)}</td>
          </tr>
        `);
      });

      return rows.join('');
    }

    function describePlan(invoice) {
      const plan = invoice?.plan;
      if (!plan) return '-';
      const billingLabel = plan.billingType === 'annual' ? '年額' : '月額';
      return `${plan.displayName ?? '-'}（${billingLabel}）`;
    }

    function describeAddOns(addOns) {
      if (!Array.isArray(addOns) || addOns.length === 0) return 'なし';
      return addOns.map(addOn => {
        const quantityText = formatQuantity(addOn.quantity, addOn.unit);
        return quantityText ? `${addOn.displayName} ${quantityText}` : addOn.displayName;
      }).join(' / ');
    }

    function formatDate(value) {
      if (!value) return '-';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return `${date.getFullYear()}年${String(date.getMonth() + 1).padStart(2, '0')}月${String(date.getDate()).padStart(2, '0')}日`;
    }

    function formatBillingPeriod(period) {
      if (!period || (!period.from && !period.to)) return '-';
      const from = formatDate(period.from);
      const to = formatDate(period.to);
      if (from === '-' && to === '-') return '-';
      return `${from} 〜 ${to}`;
    }

    function formatAmount(value, formatter) {
      if (typeof value !== 'number') return '-';
      return formatter.format(value);
    }

    function formatQuantity(quantity, unit) {
      if (typeof quantity !== 'number') return '';
      const formatted = quantity.toLocaleString('ja-JP');
      return unit ? `${formatted}${unit}` : formatted;
    }

    function escapeHtml(value) {
      if (value == null) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
